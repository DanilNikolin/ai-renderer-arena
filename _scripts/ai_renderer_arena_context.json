{
  "project_name": "ai-renderer-arena",
  "file_tree": "## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞\n\n```\nai-renderer-arena\n‚îú‚îÄ‚îÄ .gitignore\n‚îú‚îÄ‚îÄ README.md\n‚îú‚îÄ‚îÄ eslint.config.mjs\n‚îú‚îÄ‚îÄ next-env.d.ts\n‚îú‚îÄ‚îÄ next.config.ts\n‚îú‚îÄ‚îÄ package.json\n‚îú‚îÄ‚îÄ postcss.config.mjs\n‚îú‚îÄ‚îÄ src\n‚îÇ   ‚îú‚îÄ‚îÄ app\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api\n‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ generate\n‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ route.ts\n‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ refine-prompt\n‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ route.ts\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ globals.css\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx\n‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx\n‚îÇ   ‚îî‚îÄ‚îÄ components\n‚îÇ       ‚îî‚îÄ‚îÄ ImageWorkspace.tsx\n‚îú‚îÄ‚îÄ tailwind.config.ts\n‚îî‚îÄ‚îÄ tsconfig.json\n```\n\n---\n\n",
  "code_files": [
    {
      "path": ".gitignore",
      "content": "# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.\n\n# dependencies\n/node_modules\n/.pnp\n.pnp.*\n.yarn/*\n!.yarn/patches\n!.yarn/plugins\n!.yarn/releases\n!.yarn/versions\n\n# testing\n/coverage\n\n# next.js\n/.next/\n/out/\n\n# production\n/build\n\n# misc\n.DS_Store\n*.pem\n\n# debug\nnpm-debug.log*\nyarn-debug.log*\nyarn-error.log*\n.pnpm-debug.log*\n\n# env files (can opt-in for committing if needed)\n.env*\n!.env.example\n\n# vercel\n.vercel\n\n# typescript\n*.tsbuildinfo\nnext-env.d.ts\n"
    },
    {
      "path": "eslint.config.mjs",
      "content": "import { dirname } from \"path\";\nimport { fileURLToPath } from \"url\";\nimport { FlatCompat } from \"@eslint/eslintrc\";\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = dirname(__filename);\n\nconst compat = new FlatCompat({\n  baseDirectory: __dirname,\n});\n\nconst eslintConfig = [\n  ...compat.extends(\"next/core-web-vitals\", \"next/typescript\"),\n  {\n    ignores: [\n      \"node_modules/**\",\n      \".next/**\",\n      \"out/**\",\n      \"build/**\",\n      \"next-env.d.ts\",\n    ],\n  },\n];\n\nexport default eslintConfig;\n"
    },
    {
      "path": "next-env.d.ts",
      "content": "/// <reference types=\"next\" />\n/// <reference types=\"next/image-types/global\" />\n/// <reference path=\"./.next/types/routes.d.ts\" />\n\n// NOTE: This file should not be edited\n// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.\n"
    },
    {
      "path": "next.config.ts",
      "content": "import type { NextConfig } from \"next\";\n\nconst nextConfig: NextConfig = {\n  /* config options here */\n};\n\nexport default nextConfig;\n"
    },
    {
      "path": "package.json",
      "content": "{\n  \"name\": \"ai-renderer-arena\",\n  \"version\": \"0.1.0\",\n  \"private\": true,\n  \"scripts\": {\n    \"dev\": \"next dev\",\n    \"build\": \"next build\",\n    \"start\": \"next start\",\n    \"lint\": \"eslint\"\n  },\n  \"dependencies\": {\n    \"@fal-ai/client\": \"^1.6.2\",\n    \"next\": \"^15.5.3\",\n    \"openai\": \"^5.20.3\",\n    \"react\": \"^19.1.1\",\n    \"react-dom\": \"^19.1.1\"\n  },\n  \"devDependencies\": {\n    \"@eslint/eslintrc\": \"^3\",\n    \"@tailwindcss/postcss\": \"^4\",\n    \"@types/node\": \"^20\",\n    \"@types/react\": \"^19\",\n    \"@types/react-dom\": \"^19\",\n    \"autoprefixer\": \"^10.4.21\",\n    \"eslint\": \"^9\",\n    \"eslint-config-next\": \"15.5.3\",\n    \"postcss\": \"^8.5.6\",\n    \"tailwindcss\": \"^4\",\n    \"typescript\": \"^5\"\n  }\n}\n"
    },
    {
      "path": "postcss.config.mjs",
      "content": "const config = {\n  plugins: [\"@tailwindcss/postcss\"],\n};\n\nexport default config;"
    },
    {
      "path": "README.md",
      "content": "This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).\n\n## Getting Started\n\nFirst, run the development server:\n\n```bash\nnpm run dev\n# or\nyarn dev\n# or\npnpm dev\n# or\nbun dev\n```\n\nOpen [http://localhost:3000](http://localhost:3000) with your browser to see the result.\n\nYou can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.\n\nThis project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.\n\n## Learn More\n\nTo learn more about Next.js, take a look at the following resources:\n\n- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.\n- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.\n\nYou can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!\n\n## Deploy on Vercel\n\nThe easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.\n\nCheck out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.\n"
    },
    {
      "path": "tailwind.config.ts",
      "content": "import type { Config } from \"tailwindcss\";\n\nconst config: Config = {\n  content: [\n    \"./src/pages/**/*.{js,ts,jsx,tsx,mdx}\",\n    \"./src/components/**/*.{js,ts,jsx,tsx,mdx}\",\n    \"./src/app/**/*.{js,ts,jsx,tsx,mdx}\",\n  ],\n  theme: {\n    extend: {\n      backgroundImage: {\n        \"gradient-radial\": \"radial-gradient(var(--tw-gradient-stops))\",\n        \"gradient-conic\":\n          \"conic-gradient(from 180deg at 50% 50%, var(--tw-gradient-stops))\",\n      },\n      // ‚ú® –î–æ–±–∞–≤–∏–º —Å—é–¥–∞ –Ω–∞—à–∏ –∫–∞—Å—Ç–æ–º–Ω—ã–µ —Ü–≤–µ—Ç–∞ –∏–∑ —Ç–≤–æ–µ–≥–æ –∫–æ–¥–∞, —á—Ç–æ–±—ã –≤—Å–µ –±—ã–ª–æ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ\n      colors: {\n        'gray-850': '#1b2332',\n      },\n    },\n  },\n  plugins: [],\n};\nexport default config;"
    },
    {
      "path": "tsconfig.json",
      "content": "{\n  \"compilerOptions\": {\n    \"target\": \"ES2017\",\n    \"lib\": [\"dom\", \"dom.iterable\", \"esnext\"],\n    \"allowJs\": true,\n    \"skipLibCheck\": true,\n    \"strict\": true,\n    \"noEmit\": true,\n    \"esModuleInterop\": true,\n    \"module\": \"esnext\",\n    \"moduleResolution\": \"bundler\",\n    \"resolveJsonModule\": true,\n    \"isolatedModules\": true,\n    \"jsx\": \"preserve\",\n    \"incremental\": true,\n    \"plugins\": [\n      {\n        \"name\": \"next\"\n      }\n    ],\n    \"paths\": {\n      \"@/*\": [\"./src/*\"]\n    }\n  },\n  \"include\": [\"next-env.d.ts\", \"**/*.ts\", \"**/*.tsx\", \".next/types/**/*.ts\"],\n  \"exclude\": [\"node_modules\"]\n}\n"
    },
    {
      "path": "src/app/globals.css",
      "content": "\n@import \"tailwindcss\";\n@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\nbody {\n  background-color: #111827; /* –ù–µ–º–Ω–æ–≥–æ —Å–º—è–≥—á–∏–º —Ñ–æ–Ω */\n  color: #d1d5db; /* –°–¥–µ–ª–∞–µ–º —Ç–µ–∫—Å—Ç —á—É—Ç—å –º–µ–Ω–µ–µ —Ä–µ–∑–∫–∏–º */\n}\n\n/* –≠—Ñ—Ñ–µ–∫—Ç —Å–≤–µ—á–µ–Ω–∏—è –¥–ª—è —Ç–µ–∫—Å—Ç–∞ */\n.text-glow {\n  text-shadow: 0 0 8px rgba(56, 189, 248, 0.4);\n}\n\n/* –ü–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */\nbutton,\ntextarea,\ninput,\nlabel {\n  transition: all 0.2s ease-in-out;\n}\n\n/* –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä –ø–æ–¥ –Ω–∞—à—É —Ç–µ–º—É */\n::-webkit-scrollbar {\n  width: 8px;\n}\n::-webkit-scrollbar-track {\n  background: #1f2937;\n}\n::-webkit-scrollbar-thumb {\n  background: #4b5563;\n  border-radius: 4px;\n}\n::-webkit-scrollbar-thumb:hover {\n  background: #6b7280;\n}\n/* –£–∑–∫–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */\n.container-narrow {\n  max-width: 1100px; /* –º–æ–∂–µ—à—å –ø–æ—Å—Ç–∞–≤–∏—Ç—å 960px/1200px –µ—Å–ª–∏ —Ö–æ—á–µ—à—å —É–∂–µ/—à–∏—Ä–µ */\n  margin: 0 auto;\n  padding: 16px;\n}\n\n@media (min-width: 768px) {\n  .container-narrow { padding: 24px; }\n}\n@media (min-width: 1024px) {\n  .container-narrow { padding: 32px; }\n}\n\n/* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —á—É—Ç—å –±–æ–ª–µ–µ —Ç—ë–º–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ */\n.bg-gray-850 {\n  background-color: #1b2332; /* –º—è–≥–∫–∏–π —Ç—ë–º–Ω—ã–π –º–µ–∂–¥—É 800 –∏ 900 */\n}\n"
    },
    {
      "path": "src/app/layout.tsx",
      "content": "//D:\\Work\\Image test for 3Dims (3 models)\\ai-renderer-arena\\src\\app\\layout.tsx\nimport type { Metadata } from \"next\";\nimport { Inter } from \"next/font/google\";\nimport \"./globals.css\";\n\nconst inter = Inter({ subsets: [\"latin\", \"cyrillic\"] });\n\nexport const metadata: Metadata = {\n  title: \"AI Renderer Arena\",\n  description: \"Instruction-Based Image Editing Testbed\",\n};\n\nexport default function RootLayout({ children }: { children: React.ReactNode }) {\n  return (\n    <html lang=\"ru\">\n      <body className={inter.className}>{children}</body>\n    </html>\n  );\n}\n"
    },
    {
      "path": "src/app/page.tsx",
      "content": "//D:\\Work\\Image test for 3Dims (3 models)\\ai-renderer-arena\\src\\app\\page.tsx\nimport ImageWorkspace from \"@/components/ImageWorkspace\";\n\nexport default function HomePage() {\n  return (\n    <main>\n      <div className=\"container-narrow\">\n        <header className=\"mb-6\">\n          <h1 className=\"text-2xl md:text-3xl font-bold text-cyan-400 text-glow\">AI Renderer Arena</h1>\n          <p className=\"text-gray-400 text-sm mt-1\">\n            Instruction-Based Image Editing ‚Ä¢ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –∏ –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–Ω–∏—è\n          </p>\n        </header>\n\n        <ImageWorkspace />\n      </div>\n    </main>\n  );\n}\n"
    },
    {
      "path": "src/app/api/generate/route.ts",
      "content": "import { NextRequest, NextResponse } from \"next/server\";\nimport fs from \"fs/promises\";\nimport path from \"path\";\n\n// –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º Node runtime\nexport const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\n// ===== –¢–∏–ø—ã –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã =====\ntype ImgExt = \"png\" | \"jpg\" | \"jpeg\" | \"webp\";\n\n// –£—á–∏—Ç—ã–≤–∞–µ–º –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞\ninterface FalRequestBody {\n  prompt: string;\n  image_url?: string;      // –î–ª—è Qwen, Flux\n  image_urls?: string[];   // –î–ª—è Nano Banana (gemini)\n  negative_prompt?: string;\n  seed?: number;\n  num_inference_steps?: number;\n  guidance_scale?: number;\n  safety_tolerance?: number;\n}\n\n// –ü–∞–ø–∫–∞ –∞–≤—Ç–æ—Å–µ–π–≤–∞ (env > –¥–µ—Ñ–æ–ª—Ç)\nconst SAVE_DIR =\n  process.env.IMAGES_SAVE_PATH ||\n  \"D:\\\\Work\\\\images from Image test for 3Dims (3 models)\";\n\n// –ú–µ—Ç–∫–∏ –¥–ª—è –ø—Ä–µ—Ñ–∏–∫—Å–∞ —Ñ–∞–π–ª–æ–≤\nconst MODEL_LABELS: Record<string, string> = {\n  qwen: \"qwen\",\n  flux: \"flux\",\n  gemini: \"Nano-Banana\",\n};\n\n// ===== –í—Å–ø–æ–º–æ–≥–∞–ª–∫–∏ =====\nfunction inferExt(contentType?: string | null, url?: string): ImgExt {\n  if (contentType) {\n    const ct = contentType.toLowerCase();\n    if (ct.includes(\"png\")) return \"png\";\n    if (ct.includes(\"jpeg\")) return \"jpeg\";\n    if (ct.includes(\"jpg\")) return \"jpg\";\n    if (ct.includes(\"webp\")) return \"webp\";\n  }\n  if (url) {\n    const m = url.toLowerCase().match(/\\.(png|jpe?g|webp)(\\?|#|$)/i);\n    if (m) return (m[1].toLowerCase() as ImgExt).replace(\"jpeg\", \"jpeg\") as ImgExt;\n  }\n  return \"png\";\n}\n\nfunction tsForName(d = new Date()) {\n  const yyyy = d.getFullYear();\n  const mm = String(d.getMonth() + 1).padStart(2, \"0\");\n  const dd = String(d.getDate()).padStart(2, \"0\");\n  const hh = String(d.getHours()).padStart(2, \"0\");\n  const mi = String(d.getMinutes()).padStart(2, \"0\");\n  const ss = String(d.getSeconds()).padStart(2, \"0\");\n  return `${yyyy}-${mm}-${dd}__${hh}-${mi}-${ss}`;\n}\n\n\n// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π –∏–Ω–¥–µ–∫—Å –¥–ª—è —Ñ–∞–π–ª–æ–≤ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º <label><N>\nasync function getNextLabelIndex(dir: string, label: string): Promise<number> {\n  try {\n    const files = await fs.readdir(dir).catch(() => []);\n    let max = 0;\n    // –ò—â–µ–º —Ä–æ–≤–Ω–æ –≤ –Ω–∞—á–∞–ª–µ –∏–º–µ–Ω–∏: label + —á–∏—Å–ª–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, \"–Ω–∞–Ω–æ-–±–∞–Ω–∞–Ω–æ12__...\")\n    const re = new RegExp(`^${label.replace(/[.*+?^${}()|[\\\\]\\\\\\\\]/g, \"\\\\$&\")}(\\\\d+)\\\\b`, \"i\");\n    for (const name of files) {\n      const m = name.match(re);\n      if (m) {\n        const n = Number(m[1]);\n        if (!Number.isNaN(n) && n > max) max = n;\n      }\n    }\n    return max + 1;\n  } catch {\n    return 1;\n  }\n}\n\nexport async function POST(req: NextRequest) {\n  const FAL_KEY = process.env.FAL_KEY;\n  if (!FAL_KEY) {\n    return NextResponse.json({ error: \"–ö–ª—é—á API –¥–ª—è fal.ai –Ω–µ –Ω–∞–π–¥–µ–Ω\" }, { status: 500 });\n  }\n\n  try {\n    const formData = await req.formData();\n    const model = (formData.get(\"model\") as string | null)?.toLowerCase() || null;\n    const prompt = formData.get(\"prompt\") as string | null;\n    const negativePrompt = formData.get(\"negative_prompt\") as string | null;\n    const imageFile = formData.get(\"image\") as File | null;\n    const settingsStr = formData.get(\"settings\") as string | null;\n\n    if (!model || !prompt || !imageFile) {\n      return NextResponse.json({ error: \"–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è\" }, { status: 400 });\n    }\n\n    // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤—Ö–æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞–∫ data URL\n    const imageBuffer = Buffer.from(await imageFile.arrayBuffer());\n    const imageUrl = `data:${imageFile.type};base64,${imageBuffer.toString(\"base64\")}`;\n\n    // –ü–∞—Ä—Å–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏\n    const settings = settingsStr ? JSON.parse(settingsStr) : {};\n\n    // –ë–∞–∑–æ–≤–æ–µ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞\n    const body: FalRequestBody = { prompt };\n    if (negativePrompt) body.negative_prompt = negativePrompt;\n\n    // –ú–∞—Ä—à—Ä—É—Ç –∏ –æ—Å–æ–±—ã–µ –ø–æ–ª—è –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –º–æ–¥–µ–ª—å\n    let endpointUrl: string;\n    switch (model) {\n      case \"qwen\":\n        endpointUrl = \"https://fal.run/fal-ai/qwen-image-edit\";\n        body.image_url = imageUrl;\n        if (settings.guidance_scale != null) body.guidance_scale = settings.guidance_scale;\n        if (settings.num_inference_steps != null) body.num_inference_steps = settings.num_inference_steps;\n        if (settings.seed != null) body.seed = settings.seed;\n        break;\n\n      case \"flux\":\n        endpointUrl = \"https://fal.run/fal-ai/flux-pro/kontext\";\n        body.image_url = imageUrl;\n        if (settings.guidance_scale != null) body.guidance_scale = settings.guidance_scale;\n        if (settings.safety_tolerance != null) body.safety_tolerance = settings.safety_tolerance;\n        if (settings.seed != null) body.seed = settings.seed;\n        break;\n\n      case \"gemini\": // Nano Banana edit\n        endpointUrl = \"https://fal.run/fal-ai/nano-banana/edit\";\n        body.image_urls = [imageUrl];\n        if (settings.seed != null) body.seed = settings.seed;\n        break;\n\n      default:\n        return NextResponse.json({ error: `–ú–æ–¥–µ–ª—å '${model}' –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è` }, { status: 400 });\n    }\n\n    // –í—ã–∑–æ–≤ FAL\n    const response = await fetch(endpointUrl, {\n      method: \"POST\",\n      headers: {\n        Authorization: `Key ${FAL_KEY}`,\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify(body),\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      console.error(\"API Error Response:\", errorText);\n      return NextResponse.json({ error: `–û—à–∏–±–∫–∞ API: ${errorText}` }, { status: response.status });\n    }\n\n    const data = await response.json();\n\n    // –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞: –∏—â–µ–º URL –∏—Ç–æ–≥–æ–≤–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏\n    const finalImageUrl: string | undefined =\n      data.images?.[0]?.url || data.image?.url || data.output?.[0]?.url;\n\n    if (!finalImageUrl) {\n      console.error(\"API did not return an image URL. Response:\", data);\n      return NextResponse.json({ error: \"API –Ω–µ –≤–µ—Ä–Ω—É–ª–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ\" }, { status: 500 });\n    }\n\n    // –°–∫–∞—á–∏–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ\n    const imgResp = await fetch(finalImageUrl);\n    if (!imgResp.ok) {\n      const errText = await imgResp.text().catch(() => \"\");\n      return NextResponse.json(\n        { error: `–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ${imgResp.status} ${errText}` },\n        { status: 502 }\n      );\n    }\n\n    const ct = imgResp.headers.get(\"content-type\");\n    const ext = inferExt(ct, finalImageUrl);\n    const buf = Buffer.from(await imgResp.arrayBuffer());\n\n    // –ü—Ä–µ—Ñ–∏–∫—Å —Å –º–µ—Ç–∫–æ–π –º–æ–¥–µ–ª–∏ –∏ –∞–≤—Ç–æ-–∏–Ω–¥–µ–∫—Å–æ–º: \"<label><N>__...\"\n    const label = MODEL_LABELS[model] ?? model;\n    await fs.mkdir(SAVE_DIR, { recursive: true });\n    const labelIndex = await getNextLabelIndex(SAVE_DIR, label);\n\n    // –•–≤–æ—Å—Ç –∏–º–µ–Ω–∏ –∫–∞–∫ —É —Ç–µ–±—è —Ä–∞–Ω—å—à–µ\n    const seedPart =\n      typeof settings?.seed === \"number\" && !Number.isNaN(settings.seed)\n        ? `seed-${settings.seed}`\n        : \"seed-auto\";\n\n    // –ò—Ç–æ–≥–æ–≤–æ–µ –∏–º—è: \"<label><N>__<timestamp>__<model>__<seedPart>.<ext>\"\n    const fileName = `${label}${labelIndex}__${tsForName()}__${model}__${seedPart}.${ext}`;\n\n    // –ü–∏—à–µ–º —Ñ–∞–π–ª\n    const filePath = path.join(SAVE_DIR, fileName);\n    await fs.writeFile(filePath, buf);\n\n    // –û—Ç–≤–µ—Ç\n    return NextResponse.json({\n      imageUrl: finalImageUrl,\n      savedPath: filePath,\n      fileName,\n      label,\n      labelIndex,\n    });\n  } catch (e: any) {\n    console.error(\"Server-side error:\", e);\n    return NextResponse.json(\n      { error: e?.message || \"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ\" },\n      { status: 500 }\n    );\n  }\n}\n"
    },
    {
      "path": "src/app/api/refine-prompt/route.ts",
      "content": "import { NextResponse } from \"next/server\";\nimport OpenAI from \"openai\";\n\n// –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å —Ç–∏–ø–∏–∑–∞—Ü–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π —Å –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω–æ—Å—Ç—å—é:\ntype TextPart = { type: \"text\"; text: string };\ntype ImagePart = { type: \"image_url\"; image_url: { url: string } };\ntype ChatMsg =\n  | { role: \"system\"; content: string }\n  | { role: \"user\"; content: (TextPart | ImagePart)[] }\n  | { role: \"assistant\"; content: string };\n\ntype RefineBody = {\n  prompt?: string;\n  system?: string;               // —Å–∏—Å—Ç–µ–º–∫–∞\n  model?: string;                // gpt-5-mini –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\n  temperature?: number | string;\n  top_p?: number | string;\n  max_completion_tokens?: number | string;\n  image?: string | null;         // data:image/...;base64,xxxx\n};\n\nfunction num(val: unknown): number | undefined {\n  if (val === null || val === undefined) return undefined;\n  if (typeof val === \"number\") return Number.isFinite(val) ? val : undefined;\n  if (typeof val === \"string\") {\n    const t = val.trim();\n    if (/^[+-]?\\d+$/.test(t)) return parseInt(t, 10);\n    if (/^[+-]?\\d+(\\.\\d+)?$/.test(t)) return parseFloat(t);\n  }\n  return undefined;\n}\n\nexport async function POST(req: Request) {\n  try {\n    const apiKey = process.env.OPENAI_API_KEY;\n    if (!apiKey) {\n      return NextResponse.json(\n        { error: \"OPENAI_API_KEY –Ω–µ –∑–∞–¥–∞–Ω.\" },\n        { status: 500 }\n      );\n    }\n\n    const client = new OpenAI({\n      apiKey,\n      baseURL: process.env.OPENAI_BASE_URL || undefined,\n    });\n\n    // ---- —á–∏—Ç–∞–µ–º JSON —Ç–µ–ª–æ ----\n    const body = (await req.json()) as RefineBody;\n\n    const prompt = (body.prompt ?? \"\").trim();\n    const system = (body.system ?? \"\").trim();\n    const model = (body.model && body.model.trim()) || \"gpt-5-mini\";\n    const temperature = num(body.temperature);\n    const top_p = num(body.top_p);\n    const max_completion_tokens = num(body.max_completion_tokens) ?? 200;\n    const image = (body.image ?? \"\").trim() || null;\n\n    if (!prompt) {\n      return NextResponse.json(\n        { error: \"–ü–æ–ª–µ 'prompt' –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ.\" },\n        { status: 400 }\n      );\n    }\n\n    // ---- —Å–æ–±–∏—Ä–∞–µ–º –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω—ã–µ messages ----\n    const userParts: (TextPart | ImagePart)[] = [{ type: \"text\", text: prompt }];\n    if (image) {\n      // –æ–∂–∏–¥–∞–µ–º data:URL –∏–ª–∏ https URL\n      userParts.push({ type: \"image_url\", image_url: { url: image } });\n    }\n\n    const messages: ChatMsg[] = [];\n    if (system) messages.push({ role: \"system\", content: system });\n    messages.push({ role: \"user\", content: userParts });\n\n    // ---- –≤—ã–∑–æ–≤ Chat Completions –ø–æ–¥ GPT-5 ----\n    const resp = await client.chat.completions.create({\n      model,\n      // @ts-expect-error ‚Äî SDK –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω—ã–µ —á–∞—Å—Ç–∏ –≤ messages\n      messages,\n      max_completion_tokens,\n      ...(temperature !== undefined ? { temperature } : {}),\n      ...(top_p !== undefined ? { top_p } : {}),\n    });\n\n    const choice = resp.choices?.[0];\n    const finishReason = choice?.finish_reason ?? \"unknown\";\n    const refinedPrompt = choice?.message?.content?.trim() || \"\";\n\n    if (refinedPrompt) {\n      return NextResponse.json({\n        refinedPrompt,\n        finish_reason: finishReason,\n        usage: resp.usage ?? null,\n      });\n    }\n\n    // –µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –ª–æ–≥ –∏ –ø–æ–Ω—è—Ç–Ω–∞—è 502\n    console.error(\"OpenAI empty response:\", JSON.stringify(resp, null, 2));\n    return NextResponse.json(\n      { error: `OpenAI –Ω–µ –≤–µ—Ä–Ω—É–ª–∞ —Ç–µ–∫—Å—Ç. –ü—Ä–∏—á–∏–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: '${finishReason}'.` },\n      { status: 502 }\n    );\n  } catch (err: any) {\n    console.error(\"refine-prompt error:\", err);\n    return NextResponse.json(\n      { error: err?.message || \"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.\" },\n      { status: 500 }\n    );\n  }\n}\n"
    },
    {
      "path": "src/components/ImageWorkspace.tsx",
      "content": "\"use client\";\n\nimport React, {\n  useState,\n  useMemo,\n  useEffect,\n  useRef,\n  ChangeEvent,\n  DragEvent,\n  KeyboardEvent,\n} from \"react\";\n\n/** ---------- types & const ---------- */\ntype Model = \"gemini\" | \"qwen\" | \"flux\";\n\nconst MAX_FILE_SIZE_MB = 10;\nconst ACCEPTED_FILE_TYPES = [\"image/png\", \"image/jpeg\", \"image/webp\"];\n\ntype QwenSettings = { guidance_scale: number; num_inference_steps: number; seed: number };\ntype FluxSettings = { guidance_scale: number; safety_tolerance: number; seed: number };\n\ntype LlmModel = 'gpt-5-mini' | 'gpt-5-nano';\n\ntype LlmSettings = {\n  model: LlmModel;\n  systemPrompt: string;\n  temperature: number;\n  topP: number;\n  maxCompletionTokens: number;\n};\n\ntype PersistState = {\n  prompt: string;\n  negativePrompt: string;\n  selectedModel: Model;\n  qwenSettings: QwenSettings;\n  fluxSettings: FluxSettings;\n\n  // NEW ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º LLM –∏ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ–ª–∞–≥–∏/–≤–∫–ª–∞–¥–∫–∏\n  llmSettings: LlmSettings;\n  sendImageToLlm: boolean;\n  showRefiner: boolean;\n  showNeg: boolean;\n  seedLock: boolean;\n  tab: \"source\" | \"result\" | \"compare\";\n  comparePos: number;\n};\n\n/** ---------- utils ---------- */\nfunction cx(...s: (string | false | undefined)[]) {\n  return s.filter(Boolean).join(\" \");\n}\n\nfunction readImageDims(file: File): Promise<{ w: number; h: number }> {\n  return new Promise((res, rej) => {\n    const img = new Image();\n    img.onload = () => res({ w: img.naturalWidth, h: img.naturalHeight });\n    img.onerror = rej;\n    img.src = URL.createObjectURL(file);\n  });\n}\n\nfunction loadPersist(): PersistState | null {\n  try {\n    const raw = localStorage.getItem(\"image_workspace_v2\");\n    return raw ? JSON.parse(raw) : null;\n  } catch {\n    return null;\n  }\n}\n\nfunction savePersist(s: PersistState) {\n  try {\n    localStorage.setItem(\"image_workspace_v2\", JSON.stringify(s));\n  } catch {}\n}\n\n/** ---------- small UI atoms ---------- */\nconst Label: React.FC<{ title: string; right?: React.ReactNode; className?: string }> = ({ title, right, className }) => (\n  <div className={cx(\"flex items-center justify-between mb-1.5\", className)}>\n    <span className=\"text-xs text-gray-300\">{title}</span>\n    {right}\n  </div>\n);\n\nconst Slider: React.FC<{\n  label: string;\n  value: number;\n  min: number;\n  max: number;\n  step: number;\n  onChange: (e: ChangeEvent<HTMLInputElement>) => void;\n  info?: string;\n  name: string;\n}> = ({ label, value, min, max, step, onChange, info, name }) => (\n  <label className=\"block space-y-1\">\n    <Label\n      title={label}\n      right={\n        <input\n          type=\"number\"\n          value={value}\n          onChange={onChange}\n          min={min}\n          max={max}\n          step={step}\n          name={name}\n          className=\"w-20 bg-gray-900 border border-gray-700 rounded p-1.5 text-xs text-center\"\n        />\n      }\n    />\n    <input\n      type=\"range\"\n      value={value}\n      min={min}\n      max={max}\n      step={step}\n      onChange={onChange}\n      name={name}\n      className=\"w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-cyan-500\"\n    />\n    {info && <p className=\"text-[10px] text-gray-500\">{info}</p>}\n  </label>\n);\n\n/** ---------- main ---------- */\nexport default function ImageWorkspace() {\n  const [sourceFile, setSourceFile] = useState<File | null>(null);\n  const [sourceUrl, setSourceUrl] = useState<string | null>(null);\n  const [resultUrl, setResultUrl] = useState<string | null>(null);\n  const [prompt, setPrompt] = useState(\"\");\n  const [rawPrompt, setRawPrompt] = useState(\"\"); // <-- –î–ª—è \"–º—É—Å–æ—Ä–Ω–æ–≥–æ\" –ø—Ä–æ–º—Ç–∞\n  const [isRefining, setIsRefining] = useState(false); // <-- –ó–∞–≥—Ä—É–∑–∫–∞ LLM\n  const [refineError, setRefineError] = useState<string | null>(null); // <-- –û—à–∏–±–∫–∞ LLM\n  const [sendImageToLlm, setSendImageToLlm] = useState(true); // <-- –°–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–∞\n  const [showRefiner, setShowRefiner] = useState(false); // <-- –î–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –±–ª–æ–∫–∞\n  const [llmSettings, setLlmSettings] = useState<LlmSettings>({\n    model: 'gpt-5-mini',\n    systemPrompt: `–¢—ã ‚Äî —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç ¬´–ü—Ä–æ–º—Ç-–ò–Ω–∂–µ–Ω–µ—Ä¬ª –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ AI-–†–µ–Ω–¥–µ—Ä–µ—Ä.\n–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∞—É–Ω—ã –∏ —Å–ø–∏—Å–æ–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤) –∏ —Å–æ–±–∏—Ä–∞—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–π, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º—Ç –¥–ª—è –º–æ–¥–µ–ª–∏ —Ä–µ–¥–∞–∫—Ç—É—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, Qwen-Image-Edit).\n\n–ê–ª–≥–æ—Ä–∏—Ç–º:\n\n–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤\n\n–ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –æ–±—ä–µ–∫—Ç–æ–≤, —Ä–µ–∞–ª—å–Ω–æ –≤–∏–¥–∏–º—ã—Ö –Ω–∞ —Ä–µ–Ω–¥–µ—Ä–µ.\n\n–ò–≥–Ω–æ—Ä–∏—Ä—É–π –ª–∏—à–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –∏ –Ω–µ–≤–∏–¥–∏–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã.\n\n–ì–µ–æ–º–µ—Ç—Ä–∏—è\n–í—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–π:\n¬´–°–æ—Ö—Ä–∞–Ω–∏ —Ç–æ—á–Ω—É—é –≥–µ–æ–º–µ—Ç—Ä–∏—é, –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏, —Ä–∞–∫—É—Ä—Å –∏ FOV —Å—Ü–µ–Ω—ã; –Ω–∏—á–µ–≥–æ –Ω–µ –ø–µ—Ä–µ–º–µ—â–∞—Ç—å –∏ –Ω–µ –¥–æ–±–∞–≤–ª—è—Ç—å.¬ª\n\n–ú–∞—Ç–µ—Ä–∏–∞–ª—ã\n\n–ó–∞–º–µ–Ω–∏ –≤—Å–µ –∏—Å—Ö–æ–¥–Ω—ã–µ –∑–∞–≥–ª—É—à–∫–∏ –Ω–∞ —Ñ–æ—Ç–æ—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã.\n\n–û–ø–∏—à–∏ –∏—Ö –ø—Ä–æ—Å—Ç–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ: –¥–µ—Ä–µ–≤–æ —Å –≤–∞—Ä–∏–∞—Ü–∏–µ–π –æ—Ç—Ç–µ–Ω–∫–æ–≤, —Å—É—á–∫–∞–º–∏, –¥–µ—Ñ–µ–∫—Ç–∞–º–∏; –∞–±–∞—à–∏ —Å –º–∞—Ç–æ–≤–æ–π –æ—Ç–¥–µ–ª–∫–æ–π; –ø–ª–∏—Ç–∫–∞ —Å–æ —à–≤–∞–º–∏; –º–µ—Ç–∞–ª–ª –ø–µ—á–∏ –º–∞—Ç–æ–≤—ã–π; –∫–∞–º–Ω–∏ —à–µ—Ä–æ—Ö–æ–≤–∞—Ç—ã–µ.\n\n–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã –≤—Ä–æ–¥–µ albedo, normal, AO. –ü–∏—à–∏: ¬´–¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ PBR-—Ç–µ–∫—Å—Ç—É—Ä—ã¬ª.\n\n–û—Å–æ–±—ã–µ —É—Å–ª–æ–≤–∏—è (‚ö°)\n–ï—Å–ª–∏ –µ—Å—Ç—å —á—ë—Ä–Ω—ã–µ –ø—É—Å—Ç—ã–µ –æ–±–ª–∞—Å—Ç–∏, –≤—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π –∏—Ö –∑–∞–º–µ–Ω—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n\n‚ö° –ß—ë—Ä–Ω–∞—è —Å—Ç–µ–Ω–∞ = –ø–∞–Ω–æ—Ä–∞–º–Ω–æ–µ –æ–∫–Ω–æ —Å –≤–∏–¥–æ–º –Ω–∞ –∑–∞—Å–Ω–µ–∂–µ–Ω–Ω—ã–π —Å–∫–∞–Ω–¥–∏–Ω–∞–≤—Å–∫–∏–π –ª–µ—Å –¥–Ω—ë–º, –º—è–≥–∫–∏–π –¥–Ω–µ–≤–Ω–æ–π —Å–≤–µ—Ç –∑–∞—Ö–æ–¥–∏—Ç –≤–Ω—É—Ç—Ä—å.\n\n‚ö° –ß—ë—Ä–Ω—ã–π –¥–≤–µ—Ä–Ω–æ–π –ø—Ä–æ—ë–º = –ø—Ä–µ–¥–±–∞–Ω–Ω–∏–∫: —Å–≤–µ—Ç–ª—ã–π –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –∏–Ω—Ç–µ—Ä—å–µ—Ä, –æ—Ç–¥–µ–ª–∞–Ω–Ω—ã–π —Ç–µ–º –∂–µ –¥–µ—Ä–µ–≤–æ–º, —á—Ç–æ –∏ —Å—Ç–µ–Ω—ã —Å–∞—É–Ω—ã.\nüëâ –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–ª–æ–≤–æ ¬´—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π¬ª ‚Äî —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–≥—É—é —Ñ–æ—Ä–º—É ¬´=¬ª.\n\n–°–≤–µ—Ç\n–í—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–π: ¬´–°–≤–µ—Ç —Ç—ë–ø–ª—ã–π, –º—è–≥–∫–∏–π, —Å —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ —Ç–µ–Ω—è–º–∏; –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–∏—Ç—å —Ö–æ–ª–æ–¥–Ω—ã–π –¥–Ω–µ–≤–Ω–æ–π —Å–≤–µ—Ç –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç–∏.¬ª\n\n–î–ª–∏–Ω–∞\n–ò—Ç–æ–≥–æ–≤—ã–π –ø—Ä–æ–º—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–æ—Ä–æ—á–µ, –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 5‚Äì7 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π.\n–ù–µ –ø—Ä–µ–≤—Ä–∞—â–∞–π —Ç–µ–∫—Å—Ç –≤ ¬´–≤–æ–π–Ω—É –∏ –º–∏—Ä¬ª ‚Äî –≥–ª–∞–≤–Ω—ã–µ –∞–∫—Ü–µ–Ω—Ç—ã: –≥–µ–æ–º–µ—Ç—Ä–∏—è, –º–∞—Ç–µ—Ä–∏–∞–ª—ã, –æ–∫–Ω–æ, –¥–≤–µ—Ä—å, —Å–≤–µ—Ç.'.`,\n    temperature: 1.0,\n    topP: 1,\n    maxCompletionTokens: 2000,\n  });\n  const [negativePrompt, setNegativePrompt] = useState(\"blurry, ugly, deformed, text, watermark\");\n  const [showNeg, setShowNeg] = useState(false);\n  const [selectedModel, setSelectedModel] = useState<Model>(\"flux\");\n  const [isLoading, setIsLoading] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [imageInfo, setImageInfo] = useState<{ w: number; h: number } | null>(null);\n  const [tab, setTab] = useState<\"source\" | \"result\" | \"compare\">(\"source\");\n  const [comparePos, setComparePos] = useState(50); // %\n  const [seedLock, setSeedLock] = useState(false);\n\n  const abortControllerRef = useRef<AbortController | null>(null);\n  const dropRef = useRef<HTMLLabelElement | null>(null);\n\n  // settings\n  const [qwenSettings, setQwenSettings] = useState<QwenSettings>({\n    guidance_scale: 4,\n    num_inference_steps: 30,\n    seed: 0,\n  });\n  const [fluxSettings, setFluxSettings] = useState<FluxSettings>({\n    guidance_scale: 3.5,\n    safety_tolerance: 2,\n    seed: 0,\n  });\n\n  const handleQwenChange = (e: ChangeEvent<HTMLInputElement>) => {\n    setQwenSettings((p) => ({ ...p, [e.target.name]: Number(e.target.value) }));\n  };\n  const handleFluxChange = (e: ChangeEvent<HTMLInputElement>) => {\n    setFluxSettings((p) => ({ ...p, [e.target.name]: Number(e.target.value) }));\n  };\n\n  // persist\n  useEffect(() => {\n  const p = loadPersist();\n  if (!p) return;\n\n  setPrompt(p.prompt ?? \"\");\n  setNegativePrompt(p.negativePrompt ?? \"blurry, ugly, deformed, text, watermark\");\n  setSelectedModel(p.selectedModel ?? \"flux\");\n  setQwenSettings(p.qwenSettings ?? { guidance_scale: 4, num_inference_steps: 30, seed: 0 });\n  setFluxSettings(p.fluxSettings ?? { guidance_scale: 3.5, safety_tolerance: 2, seed: 0 });\n\n  // NEW ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–µ–º, –µ—Å–ª–∏ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ\n  if (p.llmSettings) setLlmSettings(p.llmSettings);\n  if (typeof p.sendImageToLlm === \"boolean\") setSendImageToLlm(p.sendImageToLlm);\n  if (typeof p.showRefiner === \"boolean\") setShowRefiner(p.showRefiner);\n  if (typeof p.showNeg === \"boolean\") setShowNeg(p.showNeg);\n  if (typeof p.seedLock === \"boolean\") setSeedLock(p.seedLock);\n  if (p.tab) setTab(p.tab);\n  if (typeof p.comparePos === \"number\") setComparePos(p.comparePos);\n}, []);\n\n\n  useEffect(() => {\n  savePersist({\n    prompt,\n    negativePrompt,\n    selectedModel,\n    qwenSettings,\n    fluxSettings,\n\n    // NEW ‚Äî –¥–æ–±–∞–≤–∏–ª–∏ –≤—Å—ë, —á—Ç–æ —Ö–æ—Ç–∏–º —Å–æ—Ö—Ä–∞–Ω—è—Ç—å\n    llmSettings,\n    sendImageToLlm,\n    showRefiner,\n    showNeg,\n    seedLock,\n    tab,\n    comparePos,\n  });\n}, [\n  prompt,\n  negativePrompt,\n  selectedModel,\n  qwenSettings,\n  fluxSettings,\n\n  // NEW ‚Äî deps –¥–ª—è –∞–≤—Ç–æ—Å–µ–π–≤–∞\n  llmSettings,\n  sendImageToLlm,\n  showRefiner,\n  showNeg,\n  seedLock,\n  tab,\n  comparePos,\n]);\n\n\n  // revoke URL\n  useEffect(() => {\n    return () => {\n      if (sourceUrl) URL.revokeObjectURL(sourceUrl);\n    };\n  }, [sourceUrl]);\n\n  // keyboard shortcuts\n  const onKeyDown = (e: KeyboardEvent<HTMLDivElement>) => {\n    if (e.key === \"Enter\" && (e.metaKey || e.ctrlKey || (e.target as HTMLElement).tagName !== \"TEXTAREA\")) {\n      e.preventDefault();\n      onGenerate();\n    }\n    if (e.key === \"Escape\") {\n      if (isLoading) onCancel();\n    }\n  };\n\n  const handleLlmSettingsChange = (e: ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {\n    const { name, value, type } = e.target;\n    setLlmSettings(prev => ({\n      ...prev,\n      [name]: type === 'number' ? parseFloat(value) : value,\n    }));\n  };\n\n  const onRefinePrompt = async () => {\n    if (!rawPrompt.trim()) return;\n    setIsRefining(true);\n    setRefineError(null);\n    abortControllerRef.current = new AbortController();\n\n    function arrayBufferToBase64(buffer: ArrayBuffer): string {\n      let binary = \"\";\n      const bytes = new Uint8Array(buffer);\n      const chunkSize = 0x8000; // 32KB –ø–∞–∫–µ—Ç–∞–º–∏\n      for (let i = 0; i < bytes.length; i += chunkSize) {\n        const chunk = bytes.subarray(i, i + chunkSize);\n        binary += String.fromCharCode.apply(null, Array.from(chunk));\n      }\n      return btoa(binary);\n    }\n\n    let base64Image: string | undefined = undefined;\n    if (sendImageToLlm && sourceFile) {\n      const buffer = await sourceFile.arrayBuffer();\n      base64Image = `data:${sourceFile.type};base64,${arrayBufferToBase64(buffer)}`;\n    }\n\n    const payload = {\n      prompt: rawPrompt,\n      model: llmSettings.model,\n      system: llmSettings.systemPrompt,\n      temperature: llmSettings.temperature,\n      top_p: llmSettings.topP,\n      max_completion_tokens: llmSettings.maxCompletionTokens,\n      ...(base64Image ? { image: base64Image } : {}),\n    };\n\n    try {\n      const response = await fetch(\"/api/refine-prompt\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(payload),\n        signal: abortControllerRef.current.signal,\n      });\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}));\n        throw new Error(errorData.error || \"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ API\");\n      }\n\n      const data = await response.json();\n      setPrompt(data.refinedPrompt);\n      setShowRefiner(false);\n    } catch (e: unknown) {\n      if (e instanceof Error) {\n        if (e.name === \"AbortError\") {\n          setRefineError(\"–£–ª—É—á—à–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.\");\n        } else {\n          setRefineError(e.message);\n        }\n      } else {\n        setRefineError(\"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.\");\n      }\n    } finally {\n      setIsRefining(false);\n    }\n  };\n\n\n  const isReadyToGenerate = useMemo(() => !!sourceFile && !!prompt.trim() && !isLoading, [sourceFile, prompt, isLoading]);\n\n  const fail = (msg: string) => {\n    setError(msg);\n    setIsLoading(false);\n  };\n\n  const handleFileSelect = async (file: File) => {\n    if (file.size > MAX_FILE_SIZE_MB * 1024 * 1024) {\n      return fail(`–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å ${MAX_FILE_SIZE_MB} MB.`);\n    }\n    if (!ACCEPTED_FILE_TYPES.includes(file.type)) {\n      return fail(\"–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ PNG, JPEG –∏–ª–∏ WebP.\");\n    }\n    setError(null);\n    setResultUrl(null);\n    setTab(\"source\");\n    setSourceFile(file);\n    if (sourceUrl) URL.revokeObjectURL(sourceUrl);\n    const url = URL.createObjectURL(file);\n    setSourceUrl(url);\n    try {\n      const dims = await readImageDims(file);\n      setImageInfo(dims);\n    } catch {\n      setImageInfo(null);\n    }\n  };\n\n  const onFileChange = (e: ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (file) handleFileSelect(file);\n    e.target.value = \"\";\n  };\n\n  const onDrop = (e: DragEvent<HTMLLabelElement>) => {\n    e.preventDefault();\n    const file = e.dataTransfer.files?.[0];\n    if (file) handleFileSelect(file);\n  };\n\n  const onPaste = async (e: ClipboardEvent) => {\n    const items = e.clipboardData?.items;\n    if (!items) return;\n    for (const it of items) {\n      if (it.type.startsWith(\"image/\")) {\n        const file = it.getAsFile();\n        if (file) {\n          await handleFileSelect(file);\n          break;\n        }\n      }\n    }\n  };\n\n  useEffect(() => {\n    const handler = (ev: ClipboardEvent) => onPaste(ev);\n    window.addEventListener(\"paste\", handler);\n    return () => window.removeEventListener(\"paste\", handler);\n  }, []);\n\n  const onClear = () => {\n    if (sourceUrl) URL.revokeObjectURL(sourceUrl);\n    setSourceFile(null);\n    setSourceUrl(null);\n    setResultUrl(null);\n    setError(null);\n    setPrompt(\"\");\n    setImageInfo(null);\n    setTab(\"source\");\n    setShowRefiner(false);\n    setShowNeg(false);\n    setSendImageToLlm(true);\n    setSeedLock(false);\n    setTab(\"source\");\n    setComparePos(50);\n  };\n\n  const onCancel = () => {\n    abortControllerRef.current?.abort();\n    setIsLoading(false);\n    setError(\"–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.\");\n  };\n\n  const randomizeSeed = () => {\n    const seed = Math.floor(Math.random() * 2_147_483_647);\n    if (selectedModel === \"flux\") setFluxSettings((p) => ({ ...p, seed }));\n    if (selectedModel === \"qwen\") setQwenSettings((p) => ({ ...p, seed }));\n  };\n\n  const onGenerate = async () => {\n    if (!isReadyToGenerate || !sourceFile) return;\n    setIsLoading(true);\n    setError(null);\n    setResultUrl(null);\n    abortControllerRef.current = new AbortController();\n\n    const formData = new FormData();\n    formData.append(\"image\", sourceFile);\n    formData.append(\"prompt\", prompt);\n    formData.append(\"negative_prompt\", negativePrompt);\n    formData.append(\"model\", selectedModel);\n\n    let settings: QwenSettings | FluxSettings;\n    if (selectedModel === \"qwen\") {\n      settings = qwenSettings;\n    } else {\n      settings = fluxSettings;\n    }\n\n    // –µ—Å–ª–∏ —Å–∏–¥ –Ω–µ –∑–∞–ª–æ—á–µ–Ω ‚Äî –ø–æ–¥–∫–∏–Ω–µ–º –Ω–æ–≤—ã–π –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è\n    if (!seedLock) {\n      const seed = Math.floor(Math.random() * 2_147_483_647);\n      if (selectedModel === \"flux\") {\n        settings = { ...settings, seed };\n        setFluxSettings((p) => ({ ...p, seed }));\n      }\n      if (selectedModel === \"qwen\") {\n        settings = { ...settings, seed };\n        setQwenSettings((p) => ({ ...p, seed }));\n      }\n    }\n\n    formData.append(\"settings\", JSON.stringify(settings));\n\n    try {\n      const response = await fetch(\"/api/generate\", {\n        method: \"POST\",\n        body: formData,\n        signal: abortControllerRef.current.signal,\n      });\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}));\n        throw new Error(errorData.error || \"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ API\");\n      }\n      const data = await response.json();\n      setResultUrl(data.imageUrl);\n      setTab(\"result\");\n    } catch (e: unknown) {\n      if (e instanceof Error) {\n        if (e.name === \"AbortError\") {\n          setError(\"–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.\");\n        } else {\n          setError(e.message);\n        }\n      } else {\n        setError(\"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.\");\n      }\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"grid grid-cols-1 xl:grid-cols-[360px_minmax(0,1fr)] gap-6\" onKeyDown={onKeyDown} tabIndex={0}>\n      {/* ---------- Sidebar ---------- */}\n      <aside className=\"bg-gray-850 border border-gray-800 rounded-xl p-4 lg:p-5 sticky top-6 h-fit\">\n        {/* file */}\n        <div className=\"space-y-2\">\n          <Label\n            title=\"–ò—Å—Ö–æ–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ\"\n            right={\n              imageInfo && (\n                <span className=\"text-[10px] text-gray-500\">\n                  {imageInfo.w}√ó{imageInfo.h}px\n                </span>\n              )\n            }\n          />\n          <label\n            ref={dropRef}\n            htmlFor=\"image-upload\"\n            onDrop={onDrop}\n            onDragOver={(e) => e.preventDefault()}\n            className={cx(\n              \"group border border-dashed rounded-lg p-4 text-center cursor-pointer transition\",\n              \"border-gray-700 hover:border-cyan-500 bg-gray-900/50\"\n            )}\n            title=\"–ü–µ—Ä–µ—Ç–∞—â–∏ —Ñ–∞–π–ª –∏–ª–∏ –∫–ª–∏–∫–Ω–∏. –ú–æ–∂–Ω–æ —Ç–∞–∫–∂–µ –≤—Å—Ç–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞ Ctrl+V.\"\n          >\n            {sourceFile ? (\n              <div className=\"text-left space-y-1\">\n                <p className=\"text-cyan-400 text-sm font-medium truncate\">{sourceFile.name}</p>\n                <p className=\"text-xs text-gray-500\">\n                  {(sourceFile.size / 1024 / 1024).toFixed(2)} MB ‚Ä¢ {sourceFile.type.replace(\"image/\", \"\").toUpperCase()}\n                </p>\n              </div>\n            ) : (\n              <div className=\"space-y-1\">\n                <p className=\"text-sm text-gray-400\">–ü–µ—Ä–µ—Ç–∞—â–∏ –∏–ª–∏ –Ω–∞–∂–º–∏, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å</p>\n                <p className=\"text-xs text-gray-500\">PNG, JPEG, WebP ‚Ä¢ –¥–æ {MAX_FILE_SIZE_MB}MB ‚Ä¢ Ctrl+V –∏–∑ –±—É—Ñ–µ—Ä–∞</p>\n              </div>\n            )}\n            <input id=\"image-upload\" type=\"file\" className=\"hidden\" accept={ACCEPTED_FILE_TYPES.join(\",\")} onChange={onFileChange} />\n          </label>\n        </div>\n\n\n        {/* prompt refiner */}\n        <div className=\"mt-5 space-y-3 bg-gray-900/50 border border-gray-700/50 rounded-lg p-3\">\n          <button type=\"button\" onClick={() => setShowRefiner(v => !v)} className=\"w-full text-left text-sm font-medium text-cyan-400\">\n            {showRefiner ? \"‚ñº –°–∫—Ä—ã—Ç—å ¬´–ü—Ä–æ–º–ø—Ç-–ò–Ω–∂–µ–Ω–µ—Ä¬ª\" : \"‚ñ∫ –û—Ç–∫—Ä—ã—Ç—å ¬´–ü—Ä–æ–º–ø—Ç-–ò–Ω–∂–µ–Ω–µ—Ä¬ª\"}\n          </button>\n          {showRefiner && (\n            <div className=\"pt-2 space-y-4\">\n              <div>\n                <Label title=\"1. –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è LLM\" />\n                <textarea\n                  rows={3}\n                  className=\"w-full bg-gray-900 border border-gray-800 rounded-lg p-3 text-sm placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-500\"\n                  placeholder=\"–û–ø–∏—à–∏ –∑–∞–¥–∞—á—É –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ (–Ω–∞–ø—Ä.: —Å—Ç–µ–Ω—ã –∫–µ–¥—Ä, –ª–∞–≤–∫–∏ –æ—Å–∏–Ω–∞)\"\n                  value={rawPrompt}\n                  onChange={(e) => setRawPrompt(e.target.value)}\n                />\n              </div>\n\n              <div>\n                <Label title=\"2. –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è LLM\" />\n                <textarea\n                  name=\"systemPrompt\"\n                  rows={6}\n                  className=\"w-full bg-gray-900 border border-gray-800 rounded-lg p-3 text-xs font-mono placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-500\"\n                  value={llmSettings.systemPrompt}\n                  onChange={handleLlmSettingsChange}\n                />\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label title=\"–ú–æ–¥–µ–ª—å\" />\n                  <div className=\"flex items-center gap-2 rounded-lg bg-gray-950 p-1\">\n                    {(['gpt-5-mini', 'gpt-5-nano'] as const).map((model) => (\n                      <button\n                        key={model}\n                        onClick={() => setLlmSettings(p => ({ ...p, model }))}\n                        className={`w-full px-2 py-1 text-xs rounded-md transition-colors ${\n                          llmSettings.model === model ? 'bg-cyan-600 text-white' : 'hover:bg-gray-800'\n                        }`}\n                      >\n                        {model.replace('gpt-5-', 'GPT-5 ')}\n                      </button>\n                    ))}\n                  </div>\n                </div>\n                <label className=\"flex flex-col justify-end items-start gap-2 text-xs text-gray-400 cursor-pointer\">\n                  <Label title=\"–ö–æ–Ω—Ç–µ–∫—Å—Ç\" />\n                  <div className=\"flex items-center gap-2\">\n                    <input\n                      type=\"checkbox\"\n                      checked={sendImageToLlm}\n                      onChange={(e) => setSendImageToLlm(e.target.checked)}\n                      className=\"accent-cyan-500\"\n                      disabled={!sourceFile}\n                    />\n                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É\n                  </div>\n                </label>\n              </div>\n\n              <div className=\"pt-2 border-t border-gray-800 space-y-4\">\n                <Slider label=\"Temperature\" name=\"temperature\" value={llmSettings.temperature} min={0} max={2} step={0.1} onChange={handleLlmSettingsChange} />\n                <Slider label=\"Top P\" name=\"topP\" value={llmSettings.topP} min={0} max={1} step={0.05} onChange={handleLlmSettingsChange} />\n                <Slider label=\"Max Tokens\" name=\"maxCompletionTokens\" value={llmSettings.maxCompletionTokens} min={50} max={1000} step={10} onChange={handleLlmSettingsChange} />\n              </div>\n\n              <div className=\"text-center\">\n                <button\n                  onClick={onRefinePrompt}\n                  disabled={!rawPrompt.trim() || isRefining}\n                  className=\"w-full px-3 py-2 text-sm font-semibold rounded-md bg-cyan-700 hover:bg-cyan-600 text-white disabled:bg-gray-600 disabled:cursor-not-allowed\"\n                >\n                  {isRefining ? \"–£–ª—É—á—à–∞—é...\" : \"‚úì –£–ª—É—á—à–∏—Ç—å –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–æ–º–ø—Ç\"}\n                </button>\n              </div>\n\n              {refineError && (\n                <p className=\"text-xs text-red-400 bg-red-900/20 p-2 rounded-md\">{refineError}</p>\n              )}\n            </div>\n          )}\n        </div>\n\n        {/* prompt */}\n        <div className=\"mt-5 space-y-2\">\n          <Label\n            title=\"–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è\"\n            right={\n              <span className=\"text-[10px] text-gray-500\">{prompt.trim().length || 0}</span>\n            }\n          />\n          <textarea\n            rows={5}\n            className=\"w-full bg-gray-900 border border-gray-800 rounded-lg p-3 text-sm placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-500\"\n            placeholder=\"–ù–∞–ø—Ä.: Change the walls to photorealistic Canadian cedar...\"\n            value={prompt}\n            onChange={(e) => setPrompt(e.target.value)}\n          />\n\n          <button\n            type=\"button\"\n            onClick={() => setShowNeg((v) => !v)}\n            className=\"text-xs text-gray-400 hover:text-gray-200 transition underline underline-offset-4\"\n          >\n            {showNeg ? \"–°–∫—Ä—ã—Ç—å –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–ø—Ç\" : \"–ü–æ–∫–∞–∑–∞—Ç—å –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–ø—Ç\"}\n          </button>\n\n          {showNeg && (\n            <input\n              type=\"text\"\n              value={negativePrompt}\n              onChange={(e) => setNegativePrompt(e.target.value)}\n              className=\"w-full bg-gray-900 border border-gray-800 rounded-lg p-2 text-xs placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-500\"\n              placeholder=\"–ß—Ç–æ –ù–ï –Ω—É–∂–Ω–æ –≤–∏–¥–µ—Ç—å\"\n            />\n          )}\n        </div>\n\n        {/* model */}\n        <div className=\"mt-5 space-y-2\">\n          <Label title=\"–ú–æ–¥–µ–ª—å\" />\n          <div className=\"grid grid-cols-3 gap-3\">\n            {([\"flux\", \"qwen\", \"gemini\"] as Model[]).map((m) => {\n              const isActive = selectedModel === m;\n              return (\n                <button\n                  key={m}\n                  onClick={() => setSelectedModel(m)}\n                  className={cx(\n                    \"py-2.5 rounded-lg text-sm font-bold uppercase tracking-wider transition-all duration-200\",\n                    isActive\n                      ? \"bg-green-500 text-white shadow-lg shadow-green-500/30\"\n                      : \"bg-gray-900 border border-gray-700 text-gray-400 hover:bg-gray-800 hover:text-gray-200 hover:border-gray-600\"\n                  )}\n                >\n                  {m}\n                </button>\n              );\n            })}\n          </div>\n        </div>\n\n        {/* settings */}\n        <div className=\"mt-5 pt-4 border-t border-gray-800 space-y-4\">\n          <div className=\"flex items-center justify-between\">\n            <h3 className=\"text-sm font-semibold text-gray-200\">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</h3>\n            <div className=\"flex items-center gap-2\">\n              <label className=\"flex items-center gap-1 text-[11px] text-gray-400\">\n                <input\n                  type=\"checkbox\"\n                  checked={seedLock}\n                  onChange={(e) => setSeedLock(e.target.checked)}\n                  className=\"accent-cyan-500\"\n                />\n                –§–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å seed\n              </label>\n              <button\n                type=\"button\"\n                onClick={randomizeSeed}\n                className=\"text-[11px] px-2 py-1 rounded border border-gray-700 text-gray-300 hover:bg-gray-800\"\n                title=\"–°–ª—É—á–∞–π–Ω—ã–π seed\"\n              >\n                üé≤\n              </button>\n            </div>\n          </div>\n\n          {selectedModel === \"qwen\" && (\n            <>\n              <Slider label=\"Guidance scale\" value={qwenSettings.guidance_scale} min={1} max={10} step={0.1} onChange={handleQwenChange} name=\"guidance_scale\" />\n              <Slider label=\"Inference Steps\" value={qwenSettings.num_inference_steps} min={10} max={60} step={1} onChange={handleQwenChange} name=\"num_inference_steps\" />\n              <Slider label=\"Seed\" value={qwenSettings.seed} min={0} max={2147483647} step={1} onChange={handleQwenChange} name=\"seed\" />\n            </>\n          )}\n\n          {selectedModel === \"flux\" && (\n            <>\n              <Slider label=\"Guidance scale (CFG)\" value={fluxSettings.guidance_scale} min={0} max={10} step={0.1} onChange={handleFluxChange} name=\"guidance_scale\" />\n              <Slider label=\"Safety Tolerance\" value={fluxSettings.safety_tolerance} min={0} max={10} step={0.5} onChange={handleFluxChange} name=\"safety_tolerance\" info=\"–ë–æ–ª—å—à–µ–µ ‚Äî —Å—Ç—Ä–æ–∂–µ safety –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∫—Ä–æ–ø.\" />\n              <Slider label=\"Seed\" value={fluxSettings.seed} min={0} max={2147483647} step={1} onChange={handleFluxChange} name=\"seed\" />\n            </>\n          )}\n\n          {selectedModel === \"gemini\" && <p className=\"text-xs text-gray-500\">–î–ª—è Gemini –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ–ø. –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.</p>}\n        </div>\n\n        {/* actions */}\n        <div className=\"mt-5 space-y-3\">\n          <button\n            onClick={onGenerate}\n            disabled={!isReadyToGenerate}\n            className={cx(\n              \"w-full inline-flex items-center justify-center gap-2 text-sm font-semibold py-2.5 rounded-lg transition\",\n              isReadyToGenerate ? \"bg-cyan-600 hover:bg-cyan-500 text-white\" : \"bg-gray-700 text-gray-400 cursor-not-allowed\"\n            )}\n            title=\"Ctrl/Cmd+Enter ‚Äî —Ç–æ–∂–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç\"\n          >\n            {isLoading ? \"–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...\" : \"–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å\"}\n          </button>\n\n          <div className=\"flex items-center justify-between\">\n            {isLoading ? (\n              <button onClick={onCancel} className=\"text-xs text-red-400 hover:text-red-300\">\n                –û—Ç–º–µ–Ω–∏—Ç—å (Esc)\n              </button>\n            ) : (\n              <button onClick={onClear} className=\"text-xs text-gray-400 hover:text-gray-200\">\n                –û—á–∏—Å—Ç–∏—Ç—å\n              </button>\n            )}\n            {sourceFile && (\n              <span className=\"text-[11px] text-gray-500\">{sourceFile.type.replace(\"image/\", \"\").toUpperCase()}</span>\n            )}\n          </div>\n\n          {error && (\n            <div className=\"text-red-300 text-xs bg-red-900/20 border border-red-800/40 rounded p-2\">\n              <p className=\"font-semibold\">–û—à–∏–±–∫–∞</p>\n              <p>{error}</p>\n            </div>\n          )}\n        </div>\n      </aside>\n\n      {/* ---------- Canvas ---------- */}\n      <section className=\"space-y-4\">\n        {/* top bar */}\n        <div className=\"flex items-center justify-between\">\n          <div className=\"text-sm text-gray-400\">\n            {isLoading ? \"–û–±—Ä–∞–±–æ—Ç–∫–∞‚Ä¶\" : resultUrl ? \"–ì–æ—Ç–æ–≤–æ\" : \"–û–∂–∏–¥–∞–µ—Ç –∑–∞–ø—É—Å–∫–∞\"}\n          </div>\n\n          <div className=\"flex items-center gap-2\">\n            <div className=\"bg-gray-900 border border-gray-800 rounded-lg p-1 flex\">\n              {([\"source\", \"result\", \"compare\"] as const).map((t) => (\n                <button\n                  key={t}\n                  onClick={() => setTab(t)}\n                  className={cx(\n                    \"px-3 py-1.5 text-xs rounded-md\",\n                    tab === t ? \"bg-gray-800 text-gray-100\" : \"text-gray-400 hover:text-gray-200\"\n                  )}\n                >\n                  {t === \"source\" ? \"–ò—Å—Ö–æ–¥–Ω–∏–∫\" : t === \"result\" ? \"–†–µ–∑—É–ª—å—Ç–∞—Ç\" : \"–°—Ä–∞–≤–Ω–∏—Ç—å\"}\n                </button>\n              ))}\n            </div>\n\n            <button\n              onClick={() => {\n                if (!sourceUrl || !sourceFile) return;\n                const link = document.createElement(\"a\");\n                link.href = sourceUrl;\n                link.download = sourceFile.name || \"source.png\";\n                link.click();\n              }}\n              disabled={!sourceUrl}\n              className=\"text-xs px-2.5 py-1.5 rounded border border-gray-800 text-gray-300 hover:bg-gray-800 disabled:opacity-50\"\n            >\n              –°–∫–∞—á–∞—Ç—å –∏—Å—Ö–æ–¥–Ω–∏–∫\n            </button>\n\n            <button\n              onClick={() => {\n                if (!resultUrl) return;\n                const link = document.createElement(\"a\");\n                link.href = resultUrl;\n                link.download = \"result.png\";\n                link.click();\n              }}\n              disabled={!resultUrl}\n              className=\"text-xs px-2.5 py-1.5 rounded border border-gray-800 text-gray-300 hover:bg-gray-800 disabled:opacity-50\"\n            >\n              –°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç\n            </button>\n          </div>\n        </div>\n\n        {/* canvases */}\n        <div className=\"bg-gray-850 border border-gray-800 rounded-xl overflow-hidden\">\n          <div className=\"px-3 py-2 border-b border-gray-800 text-xs text-gray-400\">\n            {tab === \"source\" ? \"–ò—Å—Ö–æ–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ\" : tab === \"result\" ? \"–†–µ–∑—É–ª—å—Ç–∞—Ç\" : \"–°—Ä–∞–≤–Ω–µ–Ω–∏–µ (–¥–≤–∏–≥–∞–π —Å–ª–∞–π–¥–µ—Ä)\"}\n          </div>\n\n          <div className=\"relative h-[60vh] md:h-[70vh] bg-gray-900\">\n\n            {/* loading overlay */}\n            {isLoading && <div className=\"absolute inset-0 bg-gray-800/50 animate-pulse\" aria-label=\"loading\" />}\n\n            {/* source */}\n            {tab !== \"result\" && (\n              sourceUrl ? (\n                <img src={sourceUrl} alt=\"Source\" className=\"absolute inset-0 w-full h-full object-contain\" />\n              ) : (\n                <div className=\"absolute inset-0 flex items-center justify-center text-gray-600 text-sm\">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</div>\n              )\n            )}\n\n            {/* result */}\n            {tab !== \"source\" && (\n              resultUrl ? (\n                tab === \"compare\" ? (\n                  <>\n                    <img src={resultUrl} alt=\"Result\" className=\"absolute inset-0 w-full h-full object-contain\" style={{ clipPath: `inset(0 ${100 - comparePos}% 0 0)` }} />\n                    <div className=\"absolute inset-0 pointer-events-none border-l-2 border-cyan-500\" style={{ left: `${comparePos}%` }} />\n                    <input\n                      type=\"range\"\n                      min={0}\n                      max={100}\n                      value={comparePos}\n                      onChange={(e) => setComparePos(Number(e.target.value))}\n                      className=\"absolute bottom-3 left-1/2 -translate-x-1/2 w-[60%] h-2 bg-gray-700 rounded-lg appearance-none accent-cyan-500\"\n                    />\n                  </>\n                ) : (\n                  <img src={resultUrl} alt=\"Result\" className=\"absolute inset-0 w-full h-full object-contain\" />\n                )\n              ) : (\n                tab !== \"source\" && (\n                  <div className=\"absolute inset-0 flex items-center justify-center text-gray-600 text-sm\">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>\n                )\n              )\n            )}\n          </div>\n        </div>\n\n        <div className=\"text-[11px] text-gray-500\">\n          –õ–∞–π—Ñ—Ö–∞–∫: –∫–æ—Ä–æ—Ç–∫–∏–π –ø—Ä–æ–º–ø—Ç ‚Üí –≤—ã–±–µ—Ä–∏ –º–æ–¥–µ–ª—å ‚Üí Ctrl/Cmd+Enter. –í—Å—Ç–∞–≤–∫–∞ –∏–∑ –±—É—Ñ–µ—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç.\n        </div>\n      </section>\n    </div>\n  );\n}"
    }
  ]
}