{
  "project_name": "ai-renderer-arena",
  "file_tree": "## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞\n\n```\nai-renderer-arena\n‚îú‚îÄ‚îÄ .gitignore\n‚îú‚îÄ‚îÄ README.md\n‚îú‚îÄ‚îÄ eslint.config.mjs\n‚îú‚îÄ‚îÄ next-env.d.ts\n‚îú‚îÄ‚îÄ next.config.ts\n‚îú‚îÄ‚îÄ package.json\n‚îú‚îÄ‚îÄ postcss.config.mjs\n‚îú‚îÄ‚îÄ src\n‚îÇ   ‚îú‚îÄ‚îÄ app\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api\n‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ generate\n‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ route.ts\n‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ refine-prompt\n‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ route.ts\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ globals.css\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx\n‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx\n‚îÇ   ‚îú‚îÄ‚îÄ components\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ImageWorkspace.tsx\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ui\n‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ FormControls.tsx\n‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ workspace\n‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ Canvas.tsx\n‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ Sidebar.tsx\n‚îÇ   ‚îú‚îÄ‚îÄ hooks\n‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useImageWorkspace.ts\n‚îÇ   ‚îî‚îÄ‚îÄ lib\n‚îÇ       ‚îú‚îÄ‚îÄ types.ts\n‚îÇ       ‚îî‚îÄ‚îÄ utils.ts\n‚îú‚îÄ‚îÄ tailwind.config.ts\n‚îî‚îÄ‚îÄ tsconfig.json\n```\n\n---\n\n",
  "code_files": [
    {
      "path": ".gitignore",
      "content": "# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.\n\n# dependencies\n/node_modules\n/.pnp\n.pnp.*\n.yarn/*\n!.yarn/patches\n!.yarn/plugins\n!.yarn/releases\n!.yarn/versions\n\n# testing\n/coverage\n\n# next.js\n/.next/\n/out/\n\n# production\n/build\n\n# misc\n.DS_Store\n*.pem\n\n# debug\nnpm-debug.log*\nyarn-debug.log*\nyarn-error.log*\n.pnpm-debug.log*\n\n# env files (can opt-in for committing if needed)\n.env*\n!.env.example\n\n# vercel\n.vercel\n\n# typescript\n*.tsbuildinfo\nnext-env.d.ts\n"
    },
    {
      "path": "eslint.config.mjs",
      "content": "import { dirname } from \"path\";\nimport { fileURLToPath } from \"url\";\nimport { FlatCompat } from \"@eslint/eslintrc\";\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = dirname(__filename);\n\nconst compat = new FlatCompat({\n  baseDirectory: __dirname,\n});\n\nconst eslintConfig = [\n  ...compat.extends(\"next/core-web-vitals\", \"next/typescript\"),\n  {\n    ignores: [\n      \"node_modules/**\",\n      \".next/**\",\n      \"out/**\",\n      \"build/**\",\n      \"next-env.d.ts\",\n    ],\n  },\n];\n\nexport default eslintConfig;\n"
    },
    {
      "path": "next-env.d.ts",
      "content": "/// <reference types=\"next\" />\n/// <reference types=\"next/image-types/global\" />\n/// <reference path=\"./.next/types/routes.d.ts\" />\n\n// NOTE: This file should not be edited\n// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.\n"
    },
    {
      "path": "next.config.ts",
      "content": "import type { NextConfig } from \"next\";\n\nconst nextConfig: NextConfig = {\n  /* config options here */\n};\n\nexport default nextConfig;\n"
    },
    {
      "path": "package.json",
      "content": "{\n  \"name\": \"ai-renderer-arena\",\n  \"version\": \"0.1.0\",\n  \"private\": true,\n  \"scripts\": {\n    \"dev\": \"next dev\",\n    \"build\": \"next build\",\n    \"start\": \"next start\",\n    \"lint\": \"eslint\"\n  },\n  \"dependencies\": {\n    \"@fal-ai/client\": \"^1.6.2\",\n    \"next\": \"^15.5.3\",\n    \"openai\": \"^5.20.3\",\n    \"react\": \"^19.1.1\",\n    \"react-dom\": \"^19.1.1\"\n  },\n  \"devDependencies\": {\n    \"@eslint/eslintrc\": \"^3\",\n    \"@tailwindcss/postcss\": \"^4\",\n    \"@types/node\": \"^20\",\n    \"@types/react\": \"^19\",\n    \"@types/react-dom\": \"^19\",\n    \"autoprefixer\": \"^10.4.21\",\n    \"eslint\": \"^9\",\n    \"eslint-config-next\": \"15.5.3\",\n    \"postcss\": \"^8.5.6\",\n    \"tailwindcss\": \"^4\",\n    \"typescript\": \"^5\"\n  }\n}\n"
    },
    {
      "path": "postcss.config.mjs",
      "content": "const config = {\n  plugins: [\"@tailwindcss/postcss\"],\n};\n\nexport default config;"
    },
    {
      "path": "README.md",
      "content": "This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).\n\n## Getting Started\n\nFirst, run the development server:\n\n```bash\nnpm run dev\n# or\nyarn dev\n# or\npnpm dev\n# or\nbun dev\n```\n\nOpen [http://localhost:3000](http://localhost:3000) with your browser to see the result.\n\nYou can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.\n\nThis project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.\n\n## Learn More\n\nTo learn more about Next.js, take a look at the following resources:\n\n- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.\n- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.\n\nYou can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!\n\n## Deploy on Vercel\n\nThe easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.\n\nCheck out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.\n"
    },
    {
      "path": "tailwind.config.ts",
      "content": "import type { Config } from \"tailwindcss\";\n\nconst config: Config = {\n  content: [\n    \"./src/pages/**/*.{js,ts,jsx,tsx,mdx}\",\n    \"./src/components/**/*.{js,ts,jsx,tsx,mdx}\",\n    \"./src/app/**/*.{js,ts,jsx,tsx,mdx}\",\n  ],\n  theme: {\n    extend: {\n      backgroundImage: {\n        \"gradient-radial\": \"radial-gradient(var(--tw-gradient-stops))\",\n        \"gradient-conic\":\n          \"conic-gradient(from 180deg at 50% 50%, var(--tw-gradient-stops))\",\n      },\n      // ‚ú® –î–æ–±–∞–≤–∏–º —Å—é–¥–∞ –Ω–∞—à–∏ –∫–∞—Å—Ç–æ–º–Ω—ã–µ —Ü–≤–µ—Ç–∞ –∏–∑ —Ç–≤–æ–µ–≥–æ –∫–æ–¥–∞, —á—Ç–æ–±—ã –≤—Å–µ –±—ã–ª–æ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ\n      colors: {\n        'gray-850': '#1b2332',\n        'block-muted': '#483853',\n      },\n    },\n  },\n  plugins: [],\n};\nexport default config;"
    },
    {
      "path": "tsconfig.json",
      "content": "{\n  \"compilerOptions\": {\n    \"target\": \"ES2017\",\n    \"lib\": [\"dom\", \"dom.iterable\", \"esnext\"],\n    \"allowJs\": true,\n    \"skipLibCheck\": true,\n    \"strict\": true,\n    \"noEmit\": true,\n    \"esModuleInterop\": true,\n    \"module\": \"esnext\",\n    \"moduleResolution\": \"bundler\",\n    \"resolveJsonModule\": true,\n    \"isolatedModules\": true,\n    \"jsx\": \"preserve\",\n    \"incremental\": true,\n    \"plugins\": [\n      {\n        \"name\": \"next\"\n      }\n    ],\n    \"paths\": {\n      \"@/*\": [\"./src/*\"]\n    }\n  },\n  \"include\": [\"next-env.d.ts\", \"**/*.ts\", \"**/*.tsx\", \".next/types/**/*.ts\"],\n  \"exclude\": [\"node_modules\"]\n}\n"
    },
    {
      "path": "src/app/globals.css",
      "content": "\n/*D:\\Work\\Image test for 3Dims (3 models)\\ai-renderer-arena\\src\\app\\globals.css*/\n@import \"tailwindcss\";\n@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n:root {\n  --color-block-muted: #4f2d66;\n}\n\nbody {\n  background-color: #111827; /* –ù–µ–º–Ω–æ–≥–æ —Å–º—è–≥—á–∏–º —Ñ–æ–Ω */\n  color: #d1d5db; /* –°–¥–µ–ª–∞–µ–º —Ç–µ–∫—Å—Ç —á—É—Ç—å –º–µ–Ω–µ–µ —Ä–µ–∑–∫–∏–º */\n}\n\n/* –≠—Ñ—Ñ–µ–∫—Ç —Å–≤–µ—á–µ–Ω–∏—è –¥–ª—è —Ç–µ–∫—Å—Ç–∞ */\n.text-glow {\n  text-shadow: 0 0 8px rgba(56, 189, 248, 0.4);\n}\n\n/* –ü–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */\nbutton,\ntextarea,\ninput,\nlabel {\n  transition: all 0.2s ease-in-out;\n}\n\n/* –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä –ø–æ–¥ –Ω–∞—à—É —Ç–µ–º—É */\n::-webkit-scrollbar {\n  width: 8px;\n}\n::-webkit-scrollbar-track {\n  background: #1f2937;\n}\n::-webkit-scrollbar-thumb {\n  background: #4b5563;\n  border-radius: 4px;\n}\n::-webkit-scrollbar-thumb:hover {\n  background: #6b7280;\n}\n/* –£–∑–∫–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */\n.container-narrow {\n  max-width: 1100px; /* –º–æ–∂–µ—à—å –ø–æ—Å—Ç–∞–≤–∏—Ç—å 960px/1200px –µ—Å–ª–∏ —Ö–æ—á–µ—à—å —É–∂–µ/—à–∏—Ä–µ */\n  margin: 0 auto;\n  padding: 16px;\n}\n\n@media (min-width: 768px) {\n  .container-narrow { padding: 24px; }\n}\n@media (min-width: 1024px) {\n  .container-narrow { padding: 32px; }\n}\n\n/* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —á—É—Ç—å –±–æ–ª–µ–µ —Ç—ë–º–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ */\n.bg-gray-850 {\n  background-color: #1b2332; /* –º—è–≥–∫–∏–π —Ç—ë–º–Ω—ã–π –º–µ–∂–¥—É 800 –∏ 900 */\n}\n\n"
    },
    {
      "path": "src/app/layout.tsx",
      "content": "//D:\\Work\\Image test for 3Dims (3 models)\\ai-renderer-arena\\src\\app\\layout.tsx\nimport type { Metadata } from \"next\";\nimport { Inter } from \"next/font/google\";\nimport \"./globals.css\";\n\nconst inter = Inter({ subsets: [\"latin\", \"cyrillic\"] });\n\nexport const metadata: Metadata = {\n  title: \"AI Renderer Arena\",\n  description: \"Instruction-Based Image Editing Testbed\",\n};\n\nexport default function RootLayout({ children }: { children: React.ReactNode }) {\n  return (\n    <html lang=\"ru\">\n      <body className={inter.className}>{children}</body>\n    </html>\n  );\n}\n"
    },
    {
      "path": "src/app/page.tsx",
      "content": "//D:\\Work\\Image test for 3Dims (3 models)\\ai-renderer-arena\\src\\app\\page.tsx\nimport ImageWorkspace from \"@/components/ImageWorkspace\";\n\nexport default function HomePage() {\n  return (\n    <main>\n      <div className=\"container-narrow\">\n        <header className=\"mb-6\">\n          <h1 className=\"text-2xl md:text-3xl font-bold text-cyan-400 text-glow\">AI Renderer Arena</h1>\n          <p className=\"text-gray-400 text-sm mt-1\">\n            Instruction-Based Image Editing ‚Ä¢ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –∏ –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–Ω–∏—è\n          </p>\n        </header>\n\n        <ImageWorkspace />\n      </div>\n    </main>\n  );\n}\n"
    },
    {
      "path": "src/app/api/generate/route.ts",
      "content": "import { NextRequest, NextResponse } from \"next/server\";\nimport fs from \"fs/promises\";\nimport path from \"path\";\n\n// –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º Node runtime\nexport const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\n// ===== –¢–∏–ø—ã –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã =====\ntype ImgExt = \"png\" | \"jpg\" | \"jpeg\" | \"webp\";\n\n// –£—á–∏—Ç—ã–≤–∞–µ–º –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞\ninterface FalRequestBody {\n  prompt: string;\n  image_url?: string;\n  image_urls?: string[];\n  negative_prompt?: string;\n  seed?: number;\n  num_inference_steps?: number;\n  guidance_scale?: number;\n  safety_tolerance?: number;\n  sync_mode?: boolean; // <--- –î–û–ë–ê–í–ò–õ–ò\n  image_size?: { width: number, height: number }; // <--- –î–û–ë–ê–í–ò–õ–ò\n}\n\n// –ü–∞–ø–∫–∞ –∞–≤—Ç–æ—Å–µ–π–≤–∞ (env > –¥–µ—Ñ–æ–ª—Ç)\nconst SAVE_DIR =\n  process.env.IMAGES_SAVE_PATH ||\n  \"D:\\\\Work\\\\images from Image test for 3Dims (3 models)\";\n\n// –ú–µ—Ç–∫–∏ –¥–ª—è –ø—Ä–µ—Ñ–∏–∫—Å–∞ —Ñ–∞–π–ª–æ–≤\nconst MODEL_LABELS: Record<string, string> = {\n  qwen: \"qwen\",\n  flux: \"flux\",\n  seedream: \"sdream\",\n  gemini: \"Nano-Banana\",\n};\n\n// ===== –í—Å–ø–æ–º–æ–≥–∞–ª–∫–∏ =====\nfunction inferExt(contentType?: string | null, url?: string): ImgExt {\n  if (contentType) {\n    const ct = contentType.toLowerCase();\n    if (ct.includes(\"png\")) return \"png\";\n    if (ct.includes(\"jpeg\")) return \"jpeg\";\n    if (ct.includes(\"jpg\")) return \"jpg\";\n    if (ct.includes(\"webp\")) return \"webp\";\n  }\n  if (url) {\n    const m = url.toLowerCase().match(/\\.(png|jpe?g|webp)(\\?|#|$)/i);\n    if (m) return (m[1].toLowerCase() as ImgExt).replace(\"jpeg\", \"jpeg\") as ImgExt;\n  }\n  return \"png\";\n}\n\nfunction tsForName(d = new Date()) {\n  const yyyy = d.getFullYear();\n  const mm = String(d.getMonth() + 1).padStart(2, \"0\");\n  const dd = String(d.getDate()).padStart(2, \"0\");\n  const hh = String(d.getHours()).padStart(2, \"0\");\n  const mi = String(d.getMinutes()).padStart(2, \"0\");\n  const ss = String(d.getSeconds()).padStart(2, \"0\");\n  return `${yyyy}-${mm}-${dd}__${hh}-${mi}-${ss}`;\n}\n\n\n// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π –∏–Ω–¥–µ–∫—Å –¥–ª—è —Ñ–∞–π–ª–æ–≤ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º <label><N>\nasync function getNextLabelIndex(dir: string, label: string): Promise<number> {\n  try {\n    const files = await fs.readdir(dir).catch(() => []);\n    let max = 0;\n    // –ò—â–µ–º —Ä–æ–≤–Ω–æ –≤ –Ω–∞—á–∞–ª–µ –∏–º–µ–Ω–∏: label + —á–∏—Å–ª–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, \"–Ω–∞–Ω–æ-–±–∞–Ω–∞–Ω–æ12__...\")\n    const re = new RegExp(`^${label.replace(/[.*+?^${}()|[\\\\]\\\\\\\\]/g, \"\\\\$&\")}(\\\\d+)\\\\b`, \"i\");\n    for (const name of files) {\n      const m = name.match(re);\n      if (m) {\n        const n = Number(m[1]);\n        if (!Number.isNaN(n) && n > max) max = n;\n      }\n    }\n    return max + 1;\n  } catch {\n    return 1;\n  }\n}\n\nexport async function POST(req: NextRequest) {\n  const FAL_KEY = process.env.FAL_KEY;\n  if (!FAL_KEY) {\n    return NextResponse.json({ error: \"–ö–ª—é—á API –¥–ª—è fal.ai –Ω–µ –Ω–∞–π–¥–µ–Ω\" }, { status: 500 });\n  }\n\n  try {\n    const formData = await req.formData();\n    const model = (formData.get(\"model\") as string | null)?.toLowerCase() || null;\n    const prompt = formData.get(\"prompt\") as string | null;\n    const negativePrompt = formData.get(\"negative_prompt\") as string | null;\n    const imageFile = formData.get(\"image\") as File | null;\n    const settingsStr = formData.get(\"settings\") as string | null;\n\n    if (!model || !prompt || !imageFile) {\n      return NextResponse.json({ error: \"–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è\" }, { status: 400 });\n    }\n\n    // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤—Ö–æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞–∫ data URL\n    const imageBuffer = Buffer.from(await imageFile.arrayBuffer());\n    const imageUrl = `data:${imageFile.type};base64,${imageBuffer.toString(\"base64\")}`;\n\n    // –ü–∞—Ä—Å–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏\n    const settings = settingsStr ? JSON.parse(settingsStr) : {};\n\n    // –ë–∞–∑–æ–≤–æ–µ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞\n    const body: FalRequestBody = { prompt };\n    if (negativePrompt) body.negative_prompt = negativePrompt;\n\n    // –ú–∞—Ä—à—Ä—É—Ç –∏ –æ—Å–æ–±—ã–µ –ø–æ–ª—è –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –º–æ–¥–µ–ª—å\n    let endpointUrl: string;\n    switch (model) {\n      case \"qwen\":\n        endpointUrl = \"https://fal.run/fal-ai/qwen-image-edit\";\n        body.image_url = imageUrl;\n        if (settings.guidance_scale != null) body.guidance_scale = settings.guidance_scale;\n        if (settings.num_inference_steps != null) body.num_inference_steps = settings.num_inference_steps;\n        if (settings.seed != null) body.seed = settings.seed;\n        break;\n\n      case \"flux\":\n        endpointUrl = \"https://fal.run/fal-ai/flux-pro/kontext\";\n        body.image_url = imageUrl;\n        if (settings.guidance_scale != null) body.guidance_scale = settings.guidance_scale;\n        if (settings.safety_tolerance != null) body.safety_tolerance = settings.safety_tolerance;\n        if (settings.seed != null) body.seed = settings.seed;\n        break;\n\n      case \"gemini\": // Nano Banana edit\n        endpointUrl = \"https://fal.run/fal-ai/nano-banana/edit\";\n        body.image_urls = [imageUrl];\n        if (settings.seed != null) body.seed = settings.seed;\n        break;\n\n         case \"seedream\":\n        endpointUrl = \"https://fal.run/fal-ai/bytedance/seedream/v4/edit\";\n        body.image_urls = [imageUrl];\n        body.sync_mode = true; // –í–∞–∂–Ω–æ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å—Ä–∞–∑—É\n\n        if (settings.seed != null) {\n          body.seed = settings.seed;\n        }\n        if (settings.width != null && settings.height != null) {\n¬† ¬† ¬† ¬† ¬† body.image_size = { width: settings.width, height: settings.height };\n¬† ¬† ¬† ¬† }\n¬† ¬† ¬† ¬† break;\n\n¬† ¬† ¬† default:\n¬† ¬† ¬† ¬† return NextResponse.json({ error: `–ú–æ–¥–µ–ª—å '${model}' –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è` }, { status: 400 });\n¬† ¬† } \n¬† ¬† // –í—ã–∑–æ–≤ FAL\n¬† ¬† const response = await fetch(endpointUrl, {\n      method: \"POST\",\n      headers: {\n        Authorization: `Key ${FAL_KEY}`,\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify(body),\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      console.error(\"API Error Response:\", errorText);\n      return NextResponse.json({ error: `–û—à–∏–±–∫–∞ API: ${errorText}` }, { status: response.status });\n    }\n\n    const data = await response.json();\n\n    // –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞: –∏—â–µ–º URL –∏—Ç–æ–≥–æ–≤–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏\n    const finalImageUrl: string | undefined =\n      data.images?.[0]?.url || data.image?.url || data.output?.[0]?.url;\n\n    if (!finalImageUrl) {\n      console.error(\"API did not return an image URL. Response:\", data);\n      return NextResponse.json({ error: \"API –Ω–µ –≤–µ—Ä–Ω—É–ª–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ\" }, { status: 500 });\n    }\n\n    // –°–∫–∞—á–∏–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ\n    const imgResp = await fetch(finalImageUrl);\n    if (!imgResp.ok) {\n      const errText = await imgResp.text().catch(() => \"\");\n      return NextResponse.json(\n        { error: `–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ${imgResp.status} ${errText}` },\n        { status: 502 }\n      );\n    }\n\n    const ct = imgResp.headers.get(\"content-type\");\n    const ext = inferExt(ct, finalImageUrl);\n    const buf = Buffer.from(await imgResp.arrayBuffer());\n\n    // –ü—Ä–µ—Ñ–∏–∫—Å —Å –º–µ—Ç–∫–æ–π –º–æ–¥–µ–ª–∏ –∏ –∞–≤—Ç–æ-–∏–Ω–¥–µ–∫—Å–æ–º: \"<label><N>__...\"\n    const label = MODEL_LABELS[model] ?? model;\n    await fs.mkdir(SAVE_DIR, { recursive: true });\n    const labelIndex = await getNextLabelIndex(SAVE_DIR, label);\n\n    // –•–≤–æ—Å—Ç –∏–º–µ–Ω–∏ –∫–∞–∫ —É —Ç–µ–±—è —Ä–∞–Ω—å—à–µ\n    const seedPart =\n      typeof settings?.seed === \"number\" && !Number.isNaN(settings.seed)\n        ? `seed-${settings.seed}`\n        : \"seed-auto\";\n\n    // –ò—Ç–æ–≥–æ–≤–æ–µ –∏–º—è: \"<label><N>__<timestamp>__<model>__<seedPart>.<ext>\"\n    const fileName = `${label}${labelIndex}__${tsForName()}__${model}__${seedPart}.${ext}`;\n\n    // –ü–∏—à–µ–º —Ñ–∞–π–ª\n    const filePath = path.join(SAVE_DIR, fileName);\n    await fs.writeFile(filePath, buf);\n\n    // –û—Ç–≤–µ—Ç\n    return NextResponse.json({\n      imageUrl: finalImageUrl,\n      savedPath: filePath,\n      fileName,\n      label,\n      labelIndex,\n    });\n  } catch (e: any) {\n    console.error(\"Server-side error:\", e);\n    return NextResponse.json(\n      { error: e?.message || \"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ\" },\n      { status: 500 }\n    );\n  }\n}\n"
    },
    {
      "path": "src/app/api/refine-prompt/route.ts",
      "content": "import { NextResponse } from \"next/server\";\nimport OpenAI from \"openai\";\n\n// –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å —Ç–∏–ø–∏–∑–∞—Ü–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π —Å –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω–æ—Å—Ç—å—é:\ntype TextPart = { type: \"text\"; text: string };\ntype ImagePart = { type: \"image_url\"; image_url: { url: string } };\ntype ChatMsg =\n  | { role: \"system\"; content: string }\n  | { role: \"user\"; content: (TextPart | ImagePart)[] }\n  | { role: \"assistant\"; content: string };\n\ntype RefineBody = {\n  prompt?: string;\n  system?: string;               // —Å–∏—Å—Ç–µ–º–∫–∞\n  model?: string;                // gpt-5-mini –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\n  temperature?: number | string;\n  top_p?: number | string;\n  max_completion_tokens?: number | string;\n  image?: string | null;         // data:image/...;base64,xxxx\n};\n\nfunction num(val: unknown): number | undefined {\n  if (val === null || val === undefined) return undefined;\n  if (typeof val === \"number\") return Number.isFinite(val) ? val : undefined;\n  if (typeof val === \"string\") {\n    const t = val.trim();\n    if (/^[+-]?\\d+$/.test(t)) return parseInt(t, 10);\n    if (/^[+-]?\\d+(\\.\\d+)?$/.test(t)) return parseFloat(t);\n  }\n  return undefined;\n}\n\nexport async function POST(req: Request) {\n  try {\n    const apiKey = process.env.OPENAI_API_KEY;\n    if (!apiKey) {\n      return NextResponse.json(\n        { error: \"OPENAI_API_KEY –Ω–µ –∑–∞–¥–∞–Ω.\" },\n        { status: 500 }\n      );\n    }\n\n    const client = new OpenAI({\n      apiKey,\n      baseURL: process.env.OPENAI_BASE_URL || undefined,\n    });\n\n    // ---- —á–∏—Ç–∞–µ–º JSON —Ç–µ–ª–æ ----\n    const body = (await req.json()) as RefineBody;\n\n    const prompt = (body.prompt ?? \"\").trim();\n    const system = (body.system ?? \"\").trim();\n    const model = (body.model && body.model.trim()) || \"gpt-5-mini\";\n    const temperature = num(body.temperature);\n    const top_p = num(body.top_p);\n    const max_completion_tokens = num(body.max_completion_tokens) ?? 200;\n    const image = (body.image ?? \"\").trim() || null;\n\n    if (!prompt) {\n      return NextResponse.json(\n        { error: \"–ü–æ–ª–µ 'prompt' –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ.\" },\n        { status: 400 }\n      );\n    }\n\n    // ---- —Å–æ–±–∏—Ä–∞–µ–º –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω—ã–µ messages ----\n    const userParts: (TextPart | ImagePart)[] = [{ type: \"text\", text: prompt }];\n    if (image) {\n      // –æ–∂–∏–¥–∞–µ–º data:URL –∏–ª–∏ https URL\n      userParts.push({ type: \"image_url\", image_url: { url: image } });\n    }\n\n    const messages: ChatMsg[] = [];\n    if (system) messages.push({ role: \"system\", content: system });\n    messages.push({ role: \"user\", content: userParts });\n\n    // ---- –≤—ã–∑–æ–≤ Chat Completions –ø–æ–¥ GPT-5 ----\n    const resp = await client.chat.completions.create({\n      model,\n      // @ts-expect-error ‚Äî SDK –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω—ã–µ —á–∞—Å—Ç–∏ –≤ messages\n      messages,\n      max_completion_tokens,\n      ...(temperature !== undefined ? { temperature } : {}),\n      ...(top_p !== undefined ? { top_p } : {}),\n    });\n\n    const choice = resp.choices?.[0];\n    const finishReason = choice?.finish_reason ?? \"unknown\";\n    const refinedPrompt = choice?.message?.content?.trim() || \"\";\n\n    if (refinedPrompt) {\n      return NextResponse.json({\n        refinedPrompt,\n        finish_reason: finishReason,\n        usage: resp.usage ?? null,\n      });\n    }\n\n    // –µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –ª–æ–≥ –∏ –ø–æ–Ω—è—Ç–Ω–∞—è 502\n    console.error(\"OpenAI empty response:\", JSON.stringify(resp, null, 2));\n    return NextResponse.json(\n      { error: `OpenAI –Ω–µ –≤–µ—Ä–Ω—É–ª–∞ —Ç–µ–∫—Å—Ç. –ü—Ä–∏—á–∏–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: '${finishReason}'.` },\n      { status: 502 }\n    );\n  } catch (err: any) {\n    console.error(\"refine-prompt error:\", err);\n    return NextResponse.json(\n      { error: err?.message || \"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.\" },\n      { status: 500 }\n    );\n  }\n}\n"
    },
    {
      "path": "src/components/ImageWorkspace.tsx",
      "content": "// src/components/ImageWorkspace.tsx\n\"use client\";\n\nimport React from \"react\";\nimport { useImageWorkspace } from \"@/hooks/useImageWorkspace\";\nimport { Sidebar } from \"./workspace/Sidebar\";\nimport { Canvas } from \"./workspace/Canvas\";\n\nexport default function ImageWorkspace() {\n  // –í—Å—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å —Å–ø—Ä—è—Ç–∞–Ω–∞ –∑–¥–µ—Å—å. –ú—ã –ø–æ–ª—É—á–∞–µ–º –≥–æ—Ç–æ–≤—ã–π '–∫–æ–Ω—Ç—Ä–∞–∫—Ç'.\n  const workspaceState = useImageWorkspace();\n\n  return (\n    <div\n      className=\"grid grid-cols-1 xl:grid-cols-[360px_minmax(0,1fr)] gap-6\"\n      onKeyDown={workspaceState.onKeyDown}\n      tabIndex={0}\n    >\n      {/* –ü–µ—Ä–µ–¥–∞–µ–º –≤–µ—Å—å –Ω–∞–±–æ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏–π –∏ —Ñ—É–Ω–∫—Ü–∏–π –≤ —Å–∞–π–¥–±–∞—Ä.\n        –ï–º—É –Ω–µ –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å, –æ—Ç–∫—É–¥–∞ –æ–Ω–∏ –±–µ—Ä—É—Ç—Å—è.\n      */}\n      <Sidebar {...workspaceState} />\n\n      {/* –ü–µ—Ä–µ–¥–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.\n      */}\n      <Canvas\n        isLoading={workspaceState.isLoading}\n        resultUrl={workspaceState.resultUrl}\n        sourceUrl={workspaceState.sourceUrl}\n        sourceFile={workspaceState.sourceFile}\n        tab={workspaceState.tab}\n        setTab={workspaceState.setTab}\n        comparePos={workspaceState.comparePos}\n        setComparePos={workspaceState.setComparePos}\n      />\n    </div>\n  );\n}"
    },
    {
      "path": "src/components/ui/FormControls.tsx",
      "content": "// src/components/ui/FormControls.tsx\n\nimport React, { ChangeEvent } from \"react\";\nimport { cx } from \"@/lib/utils\";\n\n/** --- –ú–∞–ª–µ–Ω—å–∫–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ --- */\nexport const Label: React.FC<{\n  title: string;\n  right?: React.ReactNode;\n  className?: string;\n}> = ({ title, right, className }) => (\n  <div className={cx(\"flex items-center justify-between mb-1.5\", className)}>\n    <span className=\"text-xs text-gray-300\">{title}</span>\n    {right}\n  </div>\n);\n\n/** --- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–ª–∞–π–¥–µ—Ä–∞ —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º –∏ –ø–æ–ª–µ–º –≤–≤–æ–¥–∞ --- */\nexport const Slider: React.FC<{\n  label: string;\n  value: number;\n  min: number;\n  max: number;\n  step: number;\n  onChange: (e: ChangeEvent<HTMLInputElement>) => void;\n  info?: string;\n  name: string;\n}> = ({ label, value, min, max, step, onChange, info, name }) => (\n  <label className=\"block space-y-1\">\n    <Label\n      title={label}\n      right={\n        <input\n          type=\"number\"\n          value={value}\n          onChange={onChange}\n          min={min}\n          max={max}\n          step={step}\n          name={name}\n          className=\"w-20 bg-gray-900 border border-gray-700 rounded p-1.5 text-xs text-center\"\n        />\n      }\n    />\n    <input\n      type=\"range\"\n      value={value}\n      min={min}\n      max={max}\n      step={step}\n      onChange={onChange}\n      name={name}\n      className=\"w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-cyan-500\"\n    />\n    {info && <p className=\"text-[10px] text-gray-500\">{info}</p>}\n  </label>\n);"
    },
    {
      "path": "src/components/workspace/Canvas.tsx",
      "content": "// src/components/workspace/Canvas.tsx\n\nimport React from \"react\";\nimport { cx } from \"@/lib/utils\";\n\n// –ü—Ä–æ–ø—Å—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º\ninterface CanvasProps {\n  isLoading: boolean;\n  resultUrl: string | null;\n  sourceUrl: string | null;\n  sourceFile: File | null;\n  tab: \"source\" | \"result\" | \"compare\";\n  setTab: (tab: \"source\" | \"result\" | \"compare\") => void;\n  comparePos: number;\n  setComparePos: (pos: number) => void;\n}\n\nexport const Canvas: React.FC<CanvasProps> = ({\n  isLoading,\n  resultUrl,\n  sourceUrl,\n  sourceFile,\n  tab,\n  setTab,\n  comparePos,\n  setComparePos,\n}) => {\n  // –ò–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ–º –ª–æ–≥–∏–∫—É —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –ø—Ä—è–º–æ –∑–¥–µ—Å—å\n  const handleDownloadSource = () => {\n    if (!sourceUrl || !sourceFile) return;\n    const link = document.createElement(\"a\");\n    link.href = sourceUrl;\n    link.download = sourceFile.name || \"source.png\";\n    link.click();\n  };\n\n  const handleDownloadResult = () => {\n    if (!resultUrl) return;\n    const link = document.createElement(\"a\");\n    link.href = resultUrl;\n    link.download = \"result.png\";\n    link.click();\n  };\n\n  return (\n    <section className=\"space-y-4\">\n      {/* top bar */}\n      <div className=\"flex items-center justify-between\">\n        <div className=\"text-sm text-gray-400\">\n          {isLoading\n            ? \"–û–±—Ä–∞–±–æ—Ç–∫–∞‚Ä¶\"\n            : resultUrl\n            ? \"–ì–æ—Ç–æ–≤–æ\"\n            : \"–û–∂–∏–¥–∞–µ—Ç –∑–∞–ø—É—Å–∫–∞\"}\n        </div>\n\n        <div className=\"flex items-center gap-2\">\n          <div className=\"bg-gray-900 border border-gray-800 rounded-lg p-1 flex\">\n            {([\"source\", \"result\", \"compare\"] as const).map((t) => (\n              <button\n                key={t}\n                onClick={() => setTab(t)}\n                className={cx(\n                  \"px-3 py-1.5 text-xs rounded-md\",\n                  tab === t\n                    ? \"bg-gray-800 text-gray-100\"\n                    : \"text-gray-400 hover:text-gray-200\"\n                )}\n              >\n                {t === \"source\"\n                  ? \"–ò—Å—Ö–æ–¥–Ω–∏–∫\"\n                  : t === \"result\"\n                  ? \"–†–µ–∑—É–ª—å—Ç–∞—Ç\"\n                  : \"–°—Ä–∞–≤–Ω–∏—Ç—å\"}\n              </button>\n            ))}\n          </div>\n\n          <button\n            onClick={handleDownloadSource}\n            disabled={!sourceUrl}\n            className=\"text-xs px-2.5 py-1.5 rounded border border-gray-800 text-gray-300 hover:bg-gray-800 disabled:opacity-50\"\n          >\n            –°–∫–∞—á–∞—Ç—å –∏—Å—Ö–æ–¥–Ω–∏–∫\n          </button>\n\n          <button\n            onClick={handleDownloadResult}\n            disabled={!resultUrl}\n            className=\"text-xs px-2.5 py-1.5 rounded border border-gray-800 text-gray-300 hover:bg-gray-800 disabled:opacity-50\"\n          >\n            –°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç\n          </button>\n        </div>\n      </div>\n\n      {/* canvases */}\n      <div className=\"bg-gray-850 border border-gray-800 rounded-xl overflow-hidden\">\n        <div className=\"px-3 py-2 border-b border-gray-800 text-xs text-gray-400\">\n          {tab === \"source\"\n            ? \"–ò—Å—Ö–æ–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ\"\n            : tab === \"result\"\n            ? \"–†–µ–∑—É–ª—å—Ç–∞—Ç\"\n            : \"–°—Ä–∞–≤–Ω–µ–Ω–∏–µ (–¥–≤–∏–≥–∞–π —Å–ª–∞–π–¥–µ—Ä)\"}\n        </div>\n\n        <div className=\"relative h-[60vh] md:h-[70vh] bg-gray-900\">\n          {/* loading overlay */}\n          {isLoading && (\n            <div\n              className=\"absolute inset-0 bg-gray-800/50 animate-pulse\"\n              aria-label=\"loading\"\n            />\n          )}\n\n          {/* source */}\n          {tab !== \"result\" &&\n            (sourceUrl ? (\n              <img\n                src={sourceUrl}\n                alt=\"Source\"\n                className=\"absolute inset-0 w-full h-full object-contain\"\n              />\n            ) : (\n              <div className=\"absolute inset-0 flex items-center justify-center text-gray-600 text-sm\">\n                –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ\n              </div>\n            ))}\n\n          {/* result */}\n          {tab !== \"source\" &&\n            (resultUrl ? (\n              tab === \"compare\" ? (\n                <>\n                  <img\n                    src={resultUrl}\n                    alt=\"Result\"\n                    className=\"absolute inset-0 w-full h-full object-contain\"\n                    style={{ clipPath: `inset(0 ${100 - comparePos}% 0 0)` }}\n                  />\n                  <div\n                    className=\"absolute inset-0 pointer-events-none border-l-2 border-cyan-500\"\n                    style={{ left: `${comparePos}%` }}\n                  />\n                  <input\n                    type=\"range\"\n                    min={0}\n                    max={100}\n                    value={comparePos}\n                    onChange={(e) => setComparePos(Number(e.target.value))}\n                    className=\"absolute bottom-3 left-1/2 -translate-x-1/2 w-[60%] h-2 bg-gray-700 rounded-lg appearance-none accent-cyan-500\"\n                  />\n                </>\n              ) : (\n                <img\n                  src={resultUrl}\n                  alt=\"Result\"\n                  className=\"absolute inset-0 w-full h-full object-contain\"\n                />\n              )\n            ) : (\n              tab !== \"source\" && (\n                <div className=\"absolute inset-0 flex items-center justify-center text-gray-600 text-sm\">\n                  –ü–æ–∫–∞ –ø—É—Å—Ç–æ\n                </div>\n              )\n            ))}\n        </div>\n      </div>\n\n      <div className=\"text-[11px] text-gray-500\">\n        –õ–∞–π—Ñ—Ö–∞–∫: –∫–æ—Ä–æ—Ç–∫–∏–π –ø—Ä–æ–º–ø—Ç ‚Üí –≤—ã–±–µ—Ä–∏ –º–æ–¥–µ–ª—å ‚Üí Ctrl/Cmd+Enter. –í—Å—Ç–∞–≤–∫–∞ –∏–∑\n        –±—É—Ñ–µ—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç.\n      </div>\n    </section>\n  );\n};"
    },
    {
      "path": "src/components/workspace/Sidebar.tsx",
      "content": "// src/components/workspace/Sidebar.tsx\n\nimport React, { ChangeEvent, DragEvent, RefObject } from \"react\";\nimport { cx } from \"@/lib/utils\";\nimport {\n  ACCEPTED_FILE_TYPES,\n  FluxSettings,\n  LlmSettings,\n  MAX_FILE_SIZE_MB,\n  Model,\n  QwenSettings,\n  SeedreamSettings,\n} from \"@/lib/types\";\nimport { Label, Slider } from \"@/components/ui/FormControls\";\n\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—Å–µ –ø—Ä–æ–ø—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è —ç—Ç–æ–º—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—É\ninterface SidebarProps {\n  imageInfo: { w: number; h: number } | null;\n  sourceFile: File | null;\n  dropRef: RefObject<HTMLLabelElement>;\n  onDrop: (e: DragEvent<HTMLLabelElement>) => void;\n  onFileChange: (e: ChangeEvent<HTMLInputElement>) => void;\n  showRefiner: boolean;\n  setShowRefiner: (value: React.SetStateAction<boolean>) => void;\n  rawPrompt: string;\n  setRawPrompt: (value: string) => void;\n  llmSettings: LlmSettings;\n  handleLlmSettingsChange: (\n    e: ChangeEvent<HTMLInputElement | HTMLTextAreaElement>\n  ) => void;\n  setLlmSettings: React.Dispatch<React.SetStateAction<LlmSettings>>;\n  sendImageToLlm: boolean;\n  setSendImageToLlm: (value: boolean) => void;\n  onRefinePrompt: () => void;\n  isRefining: boolean;\n  refineError: string | null;\n  prompt: string;\n  setPrompt: (value: string) => void;\n  showNeg: boolean;\n  setShowNeg: (value: React.SetStateAction<boolean>) => void;\n  negativePrompt: string;\n  setNegativePrompt: (value: string) => void;\n  selectedModel: Model;\n  setSelectedModel: (model: Model) => void;\n  seedLock: boolean;\n  setSeedLock: (value: boolean) => void;\n  randomizeSeed: () => void;\n  qwenSettings: QwenSettings;\n  handleQwenChange: (e: ChangeEvent<HTMLInputElement>) => void;\n  fluxSettings: FluxSettings;\n  handleFluxChange: (e: ChangeEvent<HTMLInputElement>) => void;\n  seedreamSettings: SeedreamSettings;\n  handleSeedreamChange: (e: ChangeEvent<HTMLInputElement>) => void;\n  isReadyToGenerate: boolean;\n  isLoading: boolean;\n  onGenerate: () => void;\n  onCancel: () => void;\n  onClear: () => void;\n  error: string | null;\n  jsonContent: string | null;\n  isJsonViewerOpen: boolean;\n  setIsJsonViewerOpen: (value: React.SetStateAction<boolean>) => void;\n  jsonError: string | null;\n  onJsonFileChange: (e: ChangeEvent<HTMLInputElement>) => void;\n}\n\nexport const Sidebar: React.FC<SidebarProps> = ({\n  imageInfo,\n  sourceFile,\n  dropRef,\n  onDrop,\n  onFileChange,\n  showRefiner,\n  setShowRefiner,\n  rawPrompt,\n  setRawPrompt,\n  llmSettings,\n  handleLlmSettingsChange,\n  setLlmSettings,\n  sendImageToLlm,\n  setSendImageToLlm,\n  onRefinePrompt,\n  isRefining,\n  refineError,\n  prompt,\n  setPrompt,\n  showNeg,\n  setShowNeg,\n  negativePrompt,\n  setNegativePrompt,\n  selectedModel,\n  setSelectedModel,\n  seedLock,\n  setSeedLock,\n  randomizeSeed,\n  qwenSettings,\n  handleQwenChange,\n  fluxSettings,\n  handleFluxChange,\n  seedreamSettings,\n  handleSeedreamChange,\n  isReadyToGenerate,\n  isLoading,\n  onGenerate,\n  onCancel,\n  onClear,\n  error,\n    jsonContent,\n    isJsonViewerOpen,\n    setIsJsonViewerOpen,\n    jsonError,\n    onJsonFileChange,\n    }) => {\n  return (\n    <aside className=\"bg-gray-850 border border-gray-800 rounded-xl p-4 lg:p-5 sticky top-6 h-fit\">\n      {/* file */}\n      <div className=\"space-y-2\">\n        <Label\n          title=\"–ò—Å—Ö–æ–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ\"\n          right={\n            imageInfo && (\n              <span className=\"text-[10px] text-gray-500\">\n                {imageInfo.w}√ó{imageInfo.h}px\n              </span>\n            )\n          }\n        />\n        <label\n          ref={dropRef}\n          htmlFor=\"image-upload\"\n          onDrop={onDrop}\n          onDragOver={(e) => e.preventDefault()}\n          className={cx(\n            \"group border border-dashed rounded-lg p-4 text-center cursor-pointer transition\",\n            \"border-gray-700 hover:border-cyan-500 bg-gray-900/50\"\n          )}\n          title=\"–ü–µ—Ä–µ—Ç–∞—â–∏ —Ñ–∞–π–ª –∏–ª–∏ –∫–ª–∏–∫–Ω–∏. –ú–æ–∂–Ω–æ —Ç–∞–∫–∂–µ –≤—Å—Ç–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞ Ctrl+V.\"\n        >\n          {sourceFile ? (\n            <div className=\"text-left space-y-1\">\n              <p className=\"text-cyan-400 text-sm font-medium truncate\">\n                {sourceFile.name}\n              </p>\n              <p className=\"text-xs text-gray-500\">\n                {(sourceFile.size / 1024 / 1024).toFixed(2)} MB ‚Ä¢{\" \"}\n                {sourceFile.type.replace(\"image/\", \"\").toUpperCase()}\n              </p>\n            </div>\n          ) : (\n            <div className=\"space-y-1\">\n              <p className=\"text-sm text-gray-400\">\n                –ü–µ—Ä–µ—Ç–∞—â–∏ –∏–ª–∏ –Ω–∞–∂–º–∏, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å\n              </p>\n              <p className=\"text-xs text-gray-500\">\n                PNG, JPEG, WebP ‚Ä¢ –¥–æ {MAX_FILE_SIZE_MB}MB ‚Ä¢ Ctrl+V –∏–∑ –±—É—Ñ–µ—Ä–∞\n              </p>\n            </div>\n          )}\n          <input\n            id=\"image-upload\"\n            type=\"file\"\n            className=\"hidden\"\n            accept={ACCEPTED_FILE_TYPES.join(\",\")}\n            onChange={onFileChange}\n          />\n        </label>\n      </div>\n\n{/* JSON Viewer */}\n<div className=\"mt-5 space-y-3 bg-gray-900/50 border border-gray-700/50 rounded-lg p-3\">\n  <button\n    type=\"button\"\n    onClick={() => setIsJsonViewerOpen(v => !v)}\n    className=\"w-full text-left text-sm font-medium text-yellow-400\"\n  >\n    {isJsonViewerOpen ? \"‚ñº –°–∫—Ä—ã—Ç—å JSON Viewer\" : \"‚ñ∫ –û—Ç–∫—Ä—ã—Ç—å JSON Viewer\"}\n  </button>\n  {isJsonViewerOpen && (\n    <div className=\"pt-2 space-y-3\">\n      <label \n        htmlFor=\"json-upload\" \n        className=\"block w-full text-center text-xs text-gray-400 border border-dashed border-gray-600 hover:border-yellow-500 rounded-md p-3 cursor-pointer\"\n      >\n        –ù–∞–∂–º–∏, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å .json —Ñ–∞–π–ª\n        <input id=\"json-upload\" type=\"file\" className=\"hidden\" accept=\"application/json\" onChange={onJsonFileChange} />\n      </label>\n      \n      {jsonError && (\n        <p className=\"text-xs text-red-400 bg-red-900/20 p-2 rounded-md\">{jsonError}</p>\n      )}\n\n      {jsonContent && (\n        <pre className=\"bg-gray-950 p-2 rounded-md text-xs text-gray-300 max-h-60 overflow-auto whitespace-pre-wrap\">\n          <code>\n            {jsonContent}\n          </code>\n        </pre>\n      )}\n    </div>\n  )}\n</div>\n\n      {/* prompt refiner */}\n      <div\n  className=\"mt-5 space-y-3 border border-gray-700/50 rounded-lg p-3\" // <-- –£–±—Ä–∞–ª–∏ –æ—Ç—Å—é–¥–∞ –∫–ª–∞—Å—Å bg-[--color-block-muted]\n  style={{ backgroundColor: '#221b25ff' }} // <-- –î–æ–±–∞–≤–∏–ª–∏ —Å—Ç–∏–ª—å –Ω–∞–ø—Ä—è–º—É—é\n>\n        <button\n          type=\"button\"\n          onClick={() => setShowRefiner((v) => !v)}\n          className=\"w-full text-left text-sm font-medium text-cyan-400\"\n        >\n            \n          {showRefiner\n            ? \"‚ñº –°–∫—Ä—ã—Ç—å ¬´–ü—Ä–æ–º–ø—Ç-–ò–Ω–∂–µ–Ω–µ—Ä¬ª\"\n            : \"‚ñ∫ –û—Ç–∫—Ä—ã—Ç—å ¬´–ü—Ä–æ–º–ø—Ç-–ò–Ω–∂–µ–Ω–µ—Ä¬ª\"}\n        </button>\n        {showRefiner && (\n          <div className=\"pt-2 space-y-4\">\n            <div>\n              <Label title=\"1. –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è LLM\" />\n              <textarea\n                rows={3}\n                className=\"w-full bg-gray-900 border border-gray-800 rounded-lg p-3 text-sm placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-500\"\n                placeholder=\"–û–ø–∏—à–∏ –∑–∞–¥–∞—á—É –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ (–Ω–∞–ø—Ä.: —Å—Ç–µ–Ω—ã –∫–µ–¥—Ä, –ª–∞–≤–∫–∏ –æ—Å–∏–Ω–∞)\"\n                value={rawPrompt}\n                onChange={(e) => setRawPrompt(e.target.value)}\n              />\n            </div>\n\n            <div>\n              <Label title=\"2. –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è LLM\" />\n              <textarea\n                name=\"systemPrompt\"\n                rows={6}\n                className=\"w-full bg-gray-900 border border-gray-800 rounded-lg p-3 text-xs font-mono placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-500\"\n                value={llmSettings.systemPrompt}\n                onChange={handleLlmSettingsChange}\n              />\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div>\n                <Label title=\"–ú–æ–¥–µ–ª—å\" />\n                <div className=\"flex items-center gap-2 rounded-lg bg-gray-950 p-1\">\n                  {([\"gpt-5-mini\", \"gpt-5-nano\"] as const).map((model) => (\n                    <button\n                      key={model}\n                      onClick={() =>\n                        setLlmSettings((p) => ({ ...p, model }))\n                      }\n                      className={`w-full px-2 py-1 text-xs rounded-md transition-colors ${\n                        llmSettings.model === model\n                          ? \"bg-cyan-600 text-white\"\n                          : \"hover:bg-gray-800\"\n                      }`}\n                    >\n                      {model.replace(\"gpt-5-\", \"GPT-5 \")}\n                    </button>\n                  ))}\n                </div>\n              </div>\n              <label className=\"flex flex-col justify-end items-start gap-2 text-xs text-gray-400 cursor-pointer\">\n                <Label title=\"–ö–æ–Ω—Ç–µ–∫—Å—Ç\" />\n                <div className=\"flex items-center gap-2\">\n                  <input\n                    type=\"checkbox\"\n                    checked={sendImageToLlm}\n                    onChange={(e) => setSendImageToLlm(e.target.checked)}\n                    className=\"accent-cyan-500\"\n                    disabled={!sourceFile}\n                  />\n                  –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É\n                </div>\n              </label>\n            </div>\n\n            <div className=\"pt-2 border-t border-gray-800 space-y-4\">\n              <Slider\n                label=\"Temperature\"\n                name=\"temperature\"\n                value={llmSettings.temperature}\n                min={0}\n                max={2}\n                step={0.1}\n                onChange={handleLlmSettingsChange}\n              />\n              <Slider\n                label=\"Top P\"\n                name=\"topP\"\n                value={llmSettings.topP}\n                min={0}\n                max={1}\n                step={0.05}\n                onChange={handleLlmSettingsChange}\n              />\n              <Slider\n                label=\"Max Tokens\"\n                name=\"maxCompletionTokens\"\n                value={llmSettings.maxCompletionTokens}\n                min={50}\n                max={1000}\n                step={10}\n                onChange={handleLlmSettingsChange}\n              />\n            </div>\n\n            <div className=\"text-center\">\n              <button\n                onClick={onRefinePrompt}\n                disabled={!rawPrompt.trim() || isRefining}\n                className=\"w-full px-3 py-2 text-sm font-semibold rounded-md bg-cyan-700 hover:bg-cyan-600 text-white disabled:bg-gray-600 disabled:cursor-not-allowed\"\n              >\n                {isRefining ? \"–£–ª—É—á—à–∞—é...\" : \"‚úì –£–ª—É—á—à–∏—Ç—å –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–æ–º–ø—Ç\"}\n              </button>\n            </div>\n\n            {refineError && (\n              <p className=\"text-xs text-red-400 bg-red-900/20 p-2 rounded-md\">\n                {refineError}\n              </p>\n            )}\n          </div>\n        )}\n      </div>\n\n      {/* prompt */}\n      <div className=\"mt-5 space-y-2\">\n        <Label\n            title=\"–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏\"\n            right={\n                <span className=\"text-[10px] text-gray-500\">{prompt.trim().length || 0}</span>\n            }\n            />\n        <textarea\n          rows={5}\n          className=\"w-full bg-gray-900 border border-gray-800 rounded-lg p-3 text-sm placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-500\"\n          placeholder=\"–ù–∞–ø—Ä.: Change the walls to photorealistic Canadian cedar...\"\n          value={prompt}\n          onChange={(e) => setPrompt(e.target.value)}\n        />\n\n        <button\n          type=\"button\"\n          onClick={() => setShowNeg((v) => !v)}\n          className=\"text-xs text-gray-400 hover:text-gray-200 transition underline underline-offset-4\"\n        >\n          {showNeg ? \"–°–∫—Ä—ã—Ç—å –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–ø—Ç\" : \"–ü–æ–∫–∞–∑–∞—Ç—å –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–ø—Ç\"}\n        </button>\n\n        {showNeg && (\n          <input\n            type=\"text\"\n            value={negativePrompt}\n            onChange={(e) => setNegativePrompt(e.target.value)}\n            className=\"w-full bg-gray-900 border border-gray-800 rounded-lg p-2 text-xs placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-500\"\n            placeholder=\"–ß—Ç–æ –ù–ï –Ω—É–∂–Ω–æ –≤–∏–¥–µ—Ç—å\"\n          />\n        )}\n      </div>\n\n      {/* model */}\n      <div className=\"mt-5 space-y-2\">\n¬† ¬† ¬† ¬† <Label title=\"–ú–æ–¥–µ–ª—å\" />\n        <div className=\"grid grid-cols-4 gap-2\"> \n        {/* ‚Üë‚Üë‚Üë –¢–µ–ø–µ—Ä—å —Ç—É—Ç –∂–µ—Å—Ç–∫–æ 4 –∫–æ–ª–æ–Ω–∫–∏ –∏ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–∑–æ—Ä. */}\n          {([\"flux\", \"qwen\", \"seedream\", \"gemini\"] as Model[]).map((m) => {\n            const isActive = selectedModel === m;\n            return (\n              <button\n                key={m}\n                onClick={() => setSelectedModel(m)}\n                className={cx(\n                  \"py-2.5 rounded-lg text-xs font-bold uppercase transition-all duration-200\",\n                  isActive\n                    ? \"bg-green-500 text-white shadow-lg shadow-green-500/30\"\n                    : \"bg-gray-900 border border-gray-700 text-gray-400 hover:bg-gray-800 hover:text-gray-200 hover:border-gray-600\"\n                )}\n              >\n                {m}\n              </button>\n            );\n          })}\n        </div>\n      </div>\n\n      {/* settings */}\n      <div className=\"mt-5 pt-4 border-t border-gray-800 space-y-4\">\n        <div className=\"flex items-center justify-between\">\n          <h3 className=\"text-sm font-semibold text-gray-200\">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</h3>\n          <div className=\"flex items-center gap-2\">\n            <label className=\"flex items-center gap-1 text-[11px] text-gray-400\">\n              <input\n                type=\"checkbox\"\n                checked={seedLock}\n                onChange={(e) => setSeedLock(e.target.checked)}\n                className=\"accent-cyan-500\"\n              />\n              –§–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å seed\n            </label>\n            <button\n              type=\"button\"\n              onClick={randomizeSeed}\n              className=\"text-[11px] px-2 py-1 rounded border border-gray-700 text-gray-300 hover:bg-gray-800\"\n              title=\"–°–ª—É—á–∞–π–Ω—ã–π seed\"\n            >\n              üé≤\n            </button>\n          </div>\n        </div>\n\n        {selectedModel === \"qwen\" && (\n          <>\n            <Slider\n              label=\"Guidance scale\"\n              value={qwenSettings.guidance_scale}\n              min={1}\n              max={10}\n              step={0.1}\n              onChange={handleQwenChange}\n              name=\"guidance_scale\"\n            />\n            <Slider\n              label=\"Inference Steps\"\n              value={qwenSettings.num_inference_steps}\n              min={10}\n              max={60}\n              step={1}\n              onChange={handleQwenChange}\n              name=\"num_inference_steps\"\n            />\n            <Slider\n              label=\"Seed\"\n              value={qwenSettings.seed}\n              min={0}\n              max={2147483647}\n              step={1}\n              onChange={handleQwenChange}\n              name=\"seed\"\n            />\n          </>\n        )}\n\n        {selectedModel === \"flux\" && (\n          <>\n            <Slider\n              label=\"Guidance scale (CFG)\"\n              value={fluxSettings.guidance_scale}\n              min={0}\n              max={10}\n              step={0.1}\n              onChange={handleFluxChange}\n              name=\"guidance_scale\"\n            />\n            <Slider\n              label=\"Safety Tolerance\"\n              value={fluxSettings.safety_tolerance}\n              min={0}\n              max={10}\n              step={0.5}\n              onChange={handleFluxChange}\n              name=\"safety_tolerance\"\n              info=\"–ë–æ–ª—å—à–µ–µ ‚Äî —Å—Ç—Ä–æ–∂–µ safety –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∫—Ä–æ–ø.\"\n            />\n            <Slider\n              label=\"Seed\"\n              value={fluxSettings.seed}\n              min={0}\n              max={2147483647}\n              step={1}\n              onChange={handleFluxChange}\n              name=\"seed\"\n            />\n          </>\n        )}\n\n       \n\n        {selectedModel === \"seedream\" && (\n          <>\n            <Slider\n              label=\"Seed\"\n              value={seedreamSettings.seed}\n              min={0}\n              max={2147483647}\n              step={1}\n              onChange={handleSeedreamChange}\n              name=\"seed\"\n            />\n             <p className=\"text-xs text-gray-500\">\n              –†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –±—É–¥–µ—Ç –≤–∑—è—Ç –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞.\n            </p>\n          </>\n        )}\n\n        {selectedModel === \"gemini\" && (\n          <p className=\"text-xs text-gray-500\">\n            –î–ª—è Gemini –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ–ø. –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.\n          </p>\n        )}\n      </div>\n\n      {/* actions */}\n      <div className=\"mt-5 space-y-3\">\n        <button\n          onClick={onGenerate}\n          disabled={!isReadyToGenerate}\n          className={cx(\n            \"w-full inline-flex items-center justify-center gap-2 text-sm font-semibold py-2.5 rounded-lg transition\",\n            isReadyToGenerate\n              ? \"bg-cyan-600 hover:bg-cyan-500 text-white\"\n              : \"bg-gray-700 text-gray-400 cursor-not-allowed\"\n          )}\n          title=\"Ctrl/Cmd+Enter ‚Äî —Ç–æ–∂–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç\"\n        >\n          {isLoading ? \"–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...\" : \"–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å\"}\n        </button>\n\n        <div className=\"flex items-center justify-between\">\n          {isLoading ? (\n            <button\n              onClick={onCancel}\n              className=\"text-xs text-red-400 hover:text-red-300\"\n            >\n              –û—Ç–º–µ–Ω–∏—Ç—å (Esc)\n            </button>\n          ) : (\n            <button\n              onClick={onClear}\n              className=\"text-xs text-gray-400 hover:text-gray-200\"\n            >\n              –û—á–∏—Å—Ç–∏—Ç—å\n            </button>\n          )}\n          {sourceFile && (\n            <span className=\"text-[11px] text-gray-500\">\n              {sourceFile.type.replace(\"image/\", \"\").toUpperCase()}\n            </span>\n          )}\n        </div>\n\n        {error && (\n          <div className=\"text-red-300 text-xs bg-red-900/20 border border-red-800/40 rounded p-2\">\n            <p className=\"font-semibold\">–û—à–∏–±–∫–∞</p>\n            <p>{error}</p>\n          </div>\n        )}\n      </div>\n    </aside>\n  );\n};"
    },
    {
      "path": "src/hooks/useImageWorkspace.ts",
      "content": "// src/hooks/useImageWorkspace.ts\n\nimport { useState, useMemo, useEffect, useRef, ChangeEvent, DragEvent, KeyboardEvent } from \"react\";\nimport { FluxSettings, LlmSettings, Model, QwenSettings, SeedreamSettings } from \"@/lib/types\"; // <--- –î–û–ë–ê–í–ò–õ–ò SeedreamSettings\nimport { loadPersist, readImageDims, savePersist } from \"@/lib/utils\";\n\nconst initialLlmSettings: LlmSettings = {\n  model: 'gpt-5-mini',\n  systemPrompt: `–¢—ã ‚Äî ¬´–ü—Ä–æ–º—Ç-–ò–Ω–∂–µ–Ω–µ—Ä¬ª, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π AI-–∞–Ω–∞–ª–∏—Ç–∏–∫. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—ã—Ä—ã–µ –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ-—á–µ—Ä—Ç–µ–∂ —Å–∞—É–Ω—ã –∏ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ —Å —É–∂–µ –≥–æ—Ç–æ–≤—ã–º–∏ –æ–ø–∏—Å–∞–Ω–∏—è–º–∏) –∏ —Å–∫–æ–º–ø–æ–Ω–æ–≤–∞—Ç—å –∏–∑ –Ω–∏—Ö —Å–≤–µ—Ä—Ö–∫–æ—Ä–æ—Ç–∫–∏–π, —É–±–∏–π—Å—Ç–≤–µ–Ω–Ω–æ-—Ç–æ—á–Ω—ã–π –ø—Ä–æ–º—Ç –¥–ª—è AI-¬´–•—É–¥–æ–∂–Ω–∏–∫–∞¬ª (–º–æ–¥–µ–ª–∏ —Ç–∏–ø–∞ Qwen-Image-Edit, FLUX).\n–¢–≤–æ–∏ —Ä—É–∫–æ–≤–æ–¥—è—â–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:\n–ö–æ–Ω—Ç–µ–∫—Å—Ç: ¬´–•—É–¥–æ–∂–Ω–∏–∫–∏¬ª (Qwen-Image-Edit –∏ –∞–Ω–∞–ª–æ–≥–∏) –¥–µ—Ä–∂–∞—Ç —Ñ–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤—ã—Ö 4-5 —Å—Ç—Ä–æ–∫–∞—Ö. –í—Å—ë, —á—Ç–æ –¥–∞–ª—å—à–µ ‚Äî –ª–æ—Ç–µ—Ä–µ—è. –¢–≤–æ–π –∏—Ç–æ–≥–æ–≤—ã–π –ø—Ä–æ–º—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–∞–∫ —Ç–µ–ª–µ–≥—Ä–∞–º–º–∞: –º–∞–∫—Å–∏–º—É–º —Å–º—ã—Å–ª–∞ –≤ –º–∏–Ω–∏–º—É–º–µ —Å–ª–æ–≤.\n–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è: –ù–∞ –≤—Ö–æ–¥–µ ‚Äî —á–µ—Ä—Ç–µ–∂ –∏ —Å–ø–∏—Å–æ–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤. –ß–µ—Ä–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏ –Ω–∞ —á–µ—Ä—Ç–µ–∂–µ ‚Äî —ç—Ç–æ –Ω–µ –¥–∏–∑–∞–π–Ω, –∞ –¥—ã—Ä—ã (–æ–∫–Ω–∞, –¥–≤–µ—Ä–∏), –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å. –†–∞–±–æ—Ç–∞–π —Ç–æ–ª—å–∫–æ —Å –≤–∏–¥–∏–º—ã–º–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏ –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –∏–º –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏ –∏–∑ —Å–ø–∏—Å–∫–∞.\n–ê–õ–ì–û–†–ò–¢–ú –°–ë–û–†–ö–ò –ò–¢–û–ì–û–í–û–ì–û –ü–†–û–ú–¢–ê –î–õ–Ø ¬´–•–£–î–û–ñ–ù–ò–ö–ê¬ª:\n–¢–≤–æ–π –∏—Ç–æ–≥–æ–≤—ã–π –ø—Ä–æ–º—Ç –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –∂–µ–ª–µ–∑–æ–±–µ—Ç–æ–Ω–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É. –°–æ–±–∏—Ä–∞–π –µ–≥–æ —Å—Ç—Ä–æ–≥–æ –≤ —ç—Ç–æ–º –ø–æ—Ä—è–¥–∫–µ.\n–ë–õ–û–ö 1: –ó–ê–î–ê–ß–ê, –ì–ï–û–ú–ï–¢–†–ò–Ø –ò –ß–ï–†–ù–´–ï –î–´–†–´ (–í—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)\n–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: –ù–∞—á–∏–Ω–∞–π –ø—Ä–æ–º—Ç —Å –æ–±—â–µ–π –∑–∞–¥–∞—á–∏, –≤ –∫–æ—Ç–æ—Ä—É—é –≤—à–∏—Ç–æ –≥–ª–∞–≤–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –≥–µ–æ–º–µ—Ç—Ä–∏–∏. –°—Ä–∞–∑—É –ø–æ—Å–ª–µ, –µ—Å–ª–∏ –≤–∏–¥–∏—à—å —á–µ—Ä–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏, –¥–æ–±–∞–≤—å –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∏—Ö –∑–∞–º–µ–Ω—ã. –≠—Ç–æ —Å–∞–º—ã–π –≤–∞–∂–Ω—ã–π –±–ª–æ–∫.\n–®–∞–±–ª–æ–Ω—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:\n–ü—Ä–µ–∞–º–±—É–ª–∞: You are editing a 3D render to create a masterpiece. Preserve the exact geometry, proportions, and camera FOV.\n–û–∫–Ω–æ: ‚ö° A black area on the wall = A photorealistic glass window with a thin wooden frame matching the reference, viewing a Scandinavian forest.\n–ü–∞–Ω–æ—Ä–∞–º–Ω–∞—è —Å—Ç–µ–Ω–∞: ‚ö° A black wall = A panoramic, floor-to-ceiling glass wall with a thin frame matching the reference, viewing a Scandinavian forest. (–ò—Å–ø–æ–ª—å–∑—É–π, –µ—Å–ª–∏ —á–µ—Ä–Ω–∞—è –æ–±–ª–∞—Å—Ç—å –∑–∞–Ω–∏–º–∞–µ—Ç –ø–æ—á—Ç–∏ –≤—Å—é —Å—Ç–µ–Ω—É).\n–î–≤–µ—Ä—å: ‚ö° A black doorway = A frameless glass door leading into a bright, minimalist entryway finished with the same wood as the sauna walls.\n–ë–õ–û–ö 2: –ú–ê–¢–ï–†–ò–ê–õ–´ (¬´–ü—Ä—è–º–æ–π –ø—Ä–æ–±—Ä–æ—Å¬ª)\n–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: –≠—Ç–æ —Ç–≤–æ—è –æ—Å–Ω–æ–≤–Ω–∞—è —Ä–∞–±–æ—Ç–∞. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –≤–∑—è—Ç—å –≥–æ—Ç–æ–≤—É—é —Å—Ç—Ä–æ–∫—É —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ –∏ –Ω–∞–ø—Ä—è–º—É—é –≤—Å—Ç–∞–≤–∏—Ç—å –µ–µ –≤ –∏—Ç–æ–≥–æ–≤—ã–π –ø—Ä–æ–º—Ç. –ù–∏—á–µ–≥–æ –Ω–µ –¥–æ–¥—É–º—ã–≤–∞–π. –ü—Ä–æ—Å—Ç–æ —Å–≥—Ä—É–ø–ø–∏—Ä—É–π –æ–±—ä–µ–∫—Ç—ã —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –º–∞—Ç–µ—Ä–∏–∞–ª–æ–º –∏ –ø–µ—Ä–µ–¥–∞–π –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞–∫ –µ—Å—Ç—å.\n–§–æ—Ä–º–∞—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: [–û–±—ä–µ–∫—Ç 1], [–û–±—ä–µ–∫—Ç 2]: [–û–ø–∏—Å–∞–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞]. [–û–±—ä–µ–∫—Ç 3]: [–î—Ä—É–≥–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞].\n–ü—Ä–∏–º–µ—Ä —Ç–æ–≥–æ, —á—Ç–æ —Ç—ã –¥–æ–ª–∂–µ–Ω —Å–≥–µ–Ω–µ—Ä–∏—Ç—å: Walls, floor: Canadian Cedar polished, with clear texture. Benches: Linden wood.\n–ë–õ–û–ö 3: –°–í–ï–¢\n–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: –ü–æ—Å–ª–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –¥–æ–±–∞–≤—å –∫–æ—Ä–æ—Ç–∫—É—é, —è—Å–Ω—É—é –∫–æ–º–∞–Ω–¥—É –ø–æ —Å–≤–µ—Ç—É.\n–®–∞–±–ª–æ–Ω –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: The lighting must be warm and soft with physically correct shadows; if a window is present, add contrasting cool daylight.\n–ë–õ–û–ö 4: –§–ò–ù–ê–õ–¨–ù–û–ï –ö–ê–ß–ï–°–¢–í–û (–ü—Ä–∏–∫–∞–∑)\n–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: –í —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ –ø—Ä–æ–º—Ç–∞ –¥–æ–±–∞–≤—å –æ–¥–Ω—É –º–æ—â–Ω—É—é –∫–æ–º–∞–Ω–¥—É, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–¥–∞–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—É—é –ø–ª–∞–Ω–∫—É –∫–∞—á–µ—Å—Ç–≤–∞.\n–®–∞–±–ª–æ–Ω –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: Elevate the entire image to the quality of an architectural magazine cover, focusing on photorealistic lighting and textures.\n–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞: –ò—Ç–æ–≥–æ–≤—ã–π –ø—Ä–æ–º—Ç –¥–ª—è ¬´–•—É–¥–æ–∂–Ω–∏–∫–∞¬ª –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 5-7 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (–ø—Ä–∏–º–µ—Ä–Ω–æ 200-250 —Ç–æ–∫–µ–Ω–æ–≤). –ë—É–¥—å –±–µ–∑–∂–∞–ª–æ—Å—Ç–µ–Ω –∫ –∫–∞–∂–¥–æ–º—É —Å–ª–æ–≤—É.\n\n'.`,\n  temperature: 1.0,\n  topP: 1,\n  maxCompletionTokens: 2000,\n};\n\nconst MAX_FILE_SIZE_MB = 10;\nconst ACCEPTED_FILE_TYPES = [\"image/png\", \"image/jpeg\", \"image/webp\"];\n\nexport function useImageWorkspace() {\n  // --- –°–æ—Å—Ç–æ—è–Ω–∏—è (State) ---\n  const [sourceFile, setSourceFile] = useState<File | null>(null);\n  const [sourceUrl, setSourceUrl] = useState<string | null>(null);\n  const [resultUrl, setResultUrl] = useState<string | null>(null);\n  const [prompt, setPrompt] = useState(\"\");\n  const [rawPrompt, setRawPrompt] = useState(\"\");\n  const [isRefining, setIsRefining] = useState(false);\n  const [refineError, setRefineError] = useState<string | null>(null);\n  const [sendImageToLlm, setSendImageToLlm] = useState(true);\n  const [showRefiner, setShowRefiner] = useState(false);\n  const [llmSettings, setLlmSettings] = useState<LlmSettings>(initialLlmSettings);\n  const [negativePrompt, setNegativePrompt] = useState(\"blurry, ugly, deformed, text, watermark\");\n  const [showNeg, setShowNeg] = useState(false);\n  const [selectedModel, setSelectedModel] = useState<Model>(\"flux\");\n  const [isLoading, setIsLoading] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [imageInfo, setImageInfo] = useState<{ w: number; h: number } | null>(null);\n  const [tab, setTab] = useState<\"source\" | \"result\" | \"compare\">(\"source\");\n  const [comparePos, setComparePos] = useState(50);\n  const [seedLock, setSeedLock] = useState(false);\n  const [qwenSettings, setQwenSettings] = useState<QwenSettings>({ guidance_scale: 4, num_inference_steps: 30, seed: 0 });\n  const [fluxSettings, setFluxSettings] = useState<FluxSettings>({ guidance_scale: 3.5, safety_tolerance: 2, seed: 0 });\n  const [seedreamSettings, setSeedreamSettings] = useState<SeedreamSettings>({ seed: 0, width: 1024, height: 1024 });\n\n\n  const abortControllerRef = useRef<AbortController | null>(null);\n  const dropRef = useRef<HTMLLabelElement | null>(null);\n\n  const [jsonContent, setJsonContent] = useState<string | null>(null);\n  const [isJsonViewerOpen, setIsJsonViewerOpen] = useState(false);\n  const [jsonError, setJsonError] = useState<string | null>(null);\n  // --- –≠—Ñ—Ñ–µ–∫—Ç—ã (Effects) ---\n\n  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–∑ localStorage –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Ä–µ–Ω–¥–µ—Ä–µ\n  useEffect(() => {\n    const p = loadPersist();\n    if (!p) return;\n\n    setPrompt(p.prompt ?? \"\");\n    setNegativePrompt(p.negativePrompt ?? \"blurry, ugly, deformed, text, watermark\");\n    setSelectedModel(p.selectedModel ?? \"flux\");\n¬† ¬† setQwenSettings(p.qwenSettings ?? { guidance_scale: 4, num_inference_steps: 30, seed: 0 });\n¬† ¬† setFluxSettings(p.fluxSettings ?? { guidance_scale: 3.5, safety_tolerance: 2, seed: 0 });\n    const loadedSeedream = p.seedreamSettings || {};\n    setSeedreamSettings(prev => ({ ...{ seed: 0, width: 1024, height: 1024 }, ...loadedSeedream }));\n¬† ¬† if (p.llmSettings) setLlmSettings(p.llmSettings);\n    if (typeof p.sendImageToLlm === \"boolean\") setSendImageToLlm(p.sendImageToLlm);\n    if (typeof p.showRefiner === \"boolean\") setShowRefiner(p.showRefiner);\n    if (typeof p.showNeg === \"boolean\") setShowNeg(p.showNeg);\n    if (typeof p.seedLock === \"boolean\") setSeedLock(p.seedLock);\n    if (p.tab) setTab(p.tab);\n    if (typeof p.comparePos === \"number\") setComparePos(p.comparePos);\n  }, []);\n\n  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ localStorage –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏\n  useEffect(() => {\n    savePersist({\n      prompt,\n      negativePrompt,\n      selectedModel,\n      qwenSettings,\n      fluxSettings,\n      seedreamSettings,\n      llmSettings,\n      sendImageToLlm,\n      showRefiner,\n      showNeg,\n      seedLock,\n      tab,\n      comparePos,\n    });\n  }, [\n    prompt,\n    negativePrompt,\n    selectedModel,\n    qwenSettings,\n    fluxSettings,\n    seedreamSettings,\n    llmSettings,\n    sendImageToLlm,\n    showRefiner,\n    showNeg,\n    seedLock,\n    tab,\n    comparePos,\n  ]);\n  \n  // –û—á–∏—Å—Ç–∫–∞ Object URL –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏\n  useEffect(() => {\n    return () => {\n      if (sourceUrl) URL.revokeObjectURL(sourceUrl);\n    };\n  }, [sourceUrl]);\n  \n  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å—Ç–∞–≤–∫–∏ –∏–∑ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞\n  useEffect(() => {\n    const handler = (ev: ClipboardEvent) => onPaste(ev);\n    window.addEventListener(\"paste\", handler);\n    return () => window.removeEventListener(\"paste\", handler);\n  }, []); // –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—É—Å—Ç—ã–µ, —Ç.–∫. onPaste –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤–Ω—É—Ç—Ä–∏ —Ö—É–∫–∞\n\n\n  // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏ –ª–æ–≥–∏–∫–∞ ---\n\n  const handleQwenChange = (e: ChangeEvent<HTMLInputElement>) => {\n¬† ¬† setQwenSettings((p) => ({ ...p, [e.target.name]: Number(e.target.value) }));\n¬† };\n¬† const handleFluxChange = (e: ChangeEvent<HTMLInputElement>) => {\n¬† ¬† setFluxSettings((p) => ({ ...p, [e.target.name]: Number(e.target.value) }));\n¬† };\n  const handleSeedreamChange = (e: ChangeEvent<HTMLInputElement>) => { \n    setSeedreamSettings((p) => ({ ...p, [e.target.name]: Number(e.target.value) }));\n  };\n  \n  const onKeyDown = (e: KeyboardEvent<HTMLDivElement>) => {\n    if (e.key === \"Enter\" && (e.metaKey || e.ctrlKey || (e.target as HTMLElement).tagName !== \"TEXTAREA\")) {\n      e.preventDefault();\n      onGenerate();\n    }\n    if (e.key === \"Escape\") {\n      if (isLoading) onCancel();\n    }\n  };\n\n  const handleLlmSettingsChange = (e: ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {\n    const { name, value, type } = e.target;\n    setLlmSettings(prev => ({\n      ...prev,\n      [name]: type === 'number' ? parseFloat(value) : value,\n    }));\n  };\n  \n  const onRefinePrompt = async () => {\n    if (!rawPrompt.trim()) return;\n    setIsRefining(true);\n    setRefineError(null);\n    abortControllerRef.current = new AbortController();\n\n    function arrayBufferToBase64(buffer: ArrayBuffer): string {\n      let binary = \"\";\n      const bytes = new Uint8Array(buffer);\n      const chunkSize = 0x8000;\n      for (let i = 0; i < bytes.length; i += chunkSize) {\n        const chunk = bytes.subarray(i, i + chunkSize);\n        binary += String.fromCharCode.apply(null, Array.from(chunk));\n      }\n      return btoa(binary);\n    }\n\n    let base64Image: string | undefined = undefined;\n    if (sendImageToLlm && sourceFile) {\n      const buffer = await sourceFile.arrayBuffer();\n      base64Image = `data:${sourceFile.type};base64,${arrayBufferToBase64(buffer)}`;\n    }\n\n    const payload = {\n      prompt: rawPrompt,\n      model: llmSettings.model,\n      system: llmSettings.systemPrompt,\n      temperature: llmSettings.temperature,\n      top_p: llmSettings.topP,\n      max_completion_tokens: llmSettings.maxCompletionTokens,\n      ...(base64Image ? { image: base64Image } : {}),\n    };\n\n    try {\n      const response = await fetch(\"/api/refine-prompt\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(payload),\n        signal: abortControllerRef.current.signal,\n      });\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}));\n        throw new Error(errorData.error || \"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ API\");\n      }\n\n      const data = await response.json();\n      setPrompt(data.refinedPrompt);\n      setShowRefiner(false);\n    } catch (e: unknown) {\n      if (e instanceof Error) {\n        if (e.name === \"AbortError\") setRefineError(\"–£–ª—É—á—à–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.\");\n        else setRefineError(e.message);\n      } else {\n        setRefineError(\"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.\");\n      }\n    } finally {\n      setIsRefining(false);\n    }\n  };\n\n  const isReadyToGenerate = useMemo(() => !!sourceFile && !!prompt.trim() && !isLoading, [sourceFile, prompt, isLoading]);\n\n  const fail = (msg: string) => {\n    setError(msg);\n    setIsLoading(false);\n  };\n\n  const handleFileSelect = async (file: File) => {\n    if (file.size > MAX_FILE_SIZE_MB * 1024 * 1024) return fail(`–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å ${MAX_FILE_SIZE_MB} MB.`);\n    if (!ACCEPTED_FILE_TYPES.includes(file.type)) return fail(\"–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ PNG, JPEG –∏–ª–∏ WebP.\");\n    \n    setError(null);\n    setResultUrl(null);\n    setTab(\"source\");\n    setSourceFile(file);\n    if (sourceUrl) URL.revokeObjectURL(sourceUrl);\n    const url = URL.createObjectURL(file);\n    setSourceUrl(url);\n    try {\n      const dims = await readImageDims(file);\n      setImageInfo(dims);\n    } catch {\n      setImageInfo(null);\n    }\n  };\n  \n  const handleJsonFile = (file: File) => {\n  const reader = new FileReader();\n  reader.onload = (event) => {\n    try {\n      if (typeof event.target?.result !== 'string') {\n        throw new Error(\"–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª.\");\n      }\n      const parsed = JSON.parse(event.target.result);\n      // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞\n      setJsonContent(JSON.stringify(parsed, null, 2)); \n      setJsonError(null);\n      setIsJsonViewerOpen(true); // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø—Ä–∏ —É—Å–ø–µ—Ö–µ\n    } catch (e) {\n      setJsonError(\"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞. –£–±–µ–¥–∏—Å—å, —á—Ç–æ —ç—Ç–æ –≤–∞–ª–∏–¥–Ω—ã–π JSON-—Ñ–∞–π–ª.\");\n      setJsonContent(null);\n    }\n  };\n  reader.onerror = () => {\n    setJsonError(\"–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª.\");\n    setJsonContent(null);\n  };\n  reader.readAsText(file);\n};\n\nconst onJsonFileChange = (e: ChangeEvent<HTMLInputElement>) => {\n  const file = e.target.files?.[0];\n  if (file && file.type === \"application/json\") {\n    handleJsonFile(file);\n  } else if (file) {\n    setJsonError(\"–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞. –ù—É–∂–µ–Ω JSON.\");\n  }\n  e.target.value = \"\"; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–ø—É—Ç\n};\n\n  const onFileChange = (e: ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (file) handleFileSelect(file);\n    e.target.value = \"\";\n  };\n  \n  const onDrop = (e: DragEvent<HTMLLabelElement>) => {\n    e.preventDefault();\n    const file = e.dataTransfer.files?.[0];\n    if (file) handleFileSelect(file);\n  };\n  \n  const onPaste = async (e: ClipboardEvent) => {\n    const items = e.clipboardData?.items;\n    if (!items) return;\n    for (const it of items) {\n      if (it.type.startsWith(\"image/\")) {\n        const file = it.getAsFile();\n        if (file) {\n          await handleFileSelect(file);\n          break;\n        }\n      }\n    }\n  };\n\n  const onClear = () => {\n    if (sourceUrl) URL.revokeObjectURL(sourceUrl);\n    setSourceFile(null);\n    setSourceUrl(null);\n    setResultUrl(null);\n    setError(null);\n    setPrompt(\"\");\n    setImageInfo(null);\n    setTab(\"source\");\n    setShowRefiner(false);\n    setShowNeg(false);\n    setSendImageToLlm(true);\n    setSeedLock(false);\n    setComparePos(50);\n  };\n\n  const onCancel = () => {\n    abortControllerRef.current?.abort();\n    setIsLoading(false);\n    setError(\"–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.\");\n  };\n\n  const randomizeSeed = () => {\n¬† ¬† const seed = Math.floor(Math.random() * 2_147_483_647);\n¬† ¬† if (selectedModel === \"flux\") setFluxSettings((p) => ({ ...p, seed }));\n¬† ¬† if (selectedModel === \"qwen\") setQwenSettings((p) => ({ ...p, seed }));\n    if (selectedModel === \"seedream\") setSeedreamSettings((p) => ({...p, seed }));\n¬† };\n  \n  const onGenerate = async () => {\n    if (!isReadyToGenerate || !sourceFile) return;\n    setIsLoading(true);\n    setError(null);\n    setResultUrl(null);\n    abortControllerRef.current = new AbortController();\n\n    const formData = new FormData();\n    formData.append(\"image\", sourceFile);\n    formData.append(\"prompt\", prompt);\n    formData.append(\"negative_prompt\", negativePrompt);\n    formData.append(\"model\", selectedModel);\n\n¬† ¬† let settings: QwenSettings | FluxSettings | SeedreamSettings;\n    switch (selectedModel) {\n      case \"qwen\":\n        settings = qwenSettings;\n        break;\n      case \"seedream\":\n        // –ü–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –∫–∞—Ä—Ç–∏–Ω–∫–∏\n        settings = { ...seedreamSettings, width: imageInfo!.w, height: imageInfo!.h };\n        break;\n      case \"flux\":\n      default:\n        settings = fluxSettings;\n        break;\n    }\n¬† ¬† \n¬† ¬† if (!seedLock) {\n¬† ¬† ¬† const seed = Math.floor(Math.random() * 2_147_483_647);\n¬† ¬† ¬† settings = { ...settings, seed };\n      if (selectedModel === \"qwen\") setQwenSettings(p => ({ ...p, seed }));\n      if (selectedModel === \"seedream\") setSeedreamSettings(p => ({ ...p, seed }));\n¬† ¬† ¬† if (selectedModel === \"flux\") setFluxSettings(p => ({ ...p, seed }));\n¬† ¬† }\n\n¬† ¬† formData.append(\"settings\", JSON.stringify(settings));\n\n    try {\n      const response = await fetch(\"/api/generate\", {\n        method: \"POST\",\n        body: formData,\n        signal: abortControllerRef.current.signal,\n      });\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}));\n        throw new Error(errorData.error || \"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ API\");\n      }\n      const data = await response.json();\n      setResultUrl(data.imageUrl);\n      setTab(\"result\");\n    } catch (e: unknown) {\n      if (e instanceof Error) {\n        if (e.name === \"AbortError\") setError(\"–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.\");\n        else setError(e.message);\n      } else {\n        setError(\"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.\");\n      }\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  // --- –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–π API —Ö—É–∫–∞ ---\n  return {\n    jsonContent,\n    isJsonViewerOpen,\n    setIsJsonViewerOpen,\n    jsonError,\n    onJsonFileChange,\n    sourceFile,\n    sourceUrl,\n    resultUrl,\n    prompt,\n    setPrompt,\n    rawPrompt,\n    setRawPrompt,\n    isRefining,\n    refineError,\n    sendImageToLlm,\n    setSendImageToLlm,\n    showRefiner,\n    setShowRefiner,\n    llmSettings,\n    setLlmSettings,\n    handleLlmSettingsChange,\n    negativePrompt,\n    setNegativePrompt,\n    showNeg,\n    setShowNeg,\n    selectedModel,\n    setSelectedModel,\n    isLoading,\n    error,\n    imageInfo,\n    tab,\n    setTab,\n    comparePos,\n    setComparePos,\n    seedLock,\n    setSeedLock,\n    qwenSettings,\n    handleQwenChange,\n    fluxSettings,\n    handleFluxChange,\n    seedreamSettings,\n    handleSeedreamChange,\n    dropRef,\n    onKeyDown,\n    onRefinePrompt,\n    isReadyToGenerate,\n    onFileChange,\n    onDrop,\n    onClear,\n    onCancel,\n    randomizeSeed,\n    onGenerate,\n  };\n}"
    },
    {
      "path": "src/lib/types.ts",
      "content": "// src/lib/types.ts\n\nexport type Model = \"gemini\" | \"qwen\" | \"flux\" | \"seedream\";\n\nexport const MAX_FILE_SIZE_MB = 10;\nexport const ACCEPTED_FILE_TYPES = [\"image/png\", \"image/jpeg\", \"image/webp\"];\n\nexport type QwenSettings = { guidance_scale: number; num_inference_steps: number; seed: number };\nexport type FluxSettings = { guidance_scale: number; safety_tolerance: number; seed: number };\nexport type SeedreamSettings = { \n  seed: number; \n  width: number; \n  height: number; \n};\nexport type LlmModel = 'gpt-5-mini' | 'gpt-5-nano';\n\nexport type LlmSettings = {\n  model: LlmModel;\n  systemPrompt: string;\n  temperature: number;\n  topP: number;\n  maxCompletionTokens: number;\n};\n\nexport type PersistState = {\n  prompt: string;\n  negativePrompt: string;\n  selectedModel: Model;\n  qwenSettings: QwenSettings;\n  fluxSettings: FluxSettings;\n  seedreamSettings: SeedreamSettings;\n  llmSettings: LlmSettings;\n  sendImageToLlm: boolean;\n  showRefiner: boolean;\n  showNeg: boolean;\n  seedLock: boolean;\n  tab: \"source\" | \"result\" | \"compare\";\n  comparePos: number;\n};"
    },
    {
      "path": "src/lib/utils.ts",
      "content": "// src/lib/utils.ts\n\nimport { PersistState } from \"./types\";\n\n/**\n * –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è —Å–∫–ª–µ–π–∫–∏ CSS-–∫–ª–∞—Å—Å–æ–≤.\n */\nexport function cx(...s: (string | false | undefined)[]) {\n  return s.filter(Boolean).join(\" \");\n}\n\n/**\n * –ß–∏—Ç–∞–µ—Ç —Ä–∞–∑–º–µ—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ —Ñ–∞–π–ª–∞.\n */\nexport function readImageDims(file: File): Promise<{ w: number; h: number }> {\n  return new Promise((res, rej) => {\n    const img = new Image();\n    img.onload = () => res({ w: img.naturalWidth, h: img.naturalHeight });\n    img.onerror = rej;\n    img.src = URL.createObjectURL(file);\n  });\n}\n\n/**\n * –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ localStorage.\n */\nexport function loadPersist(): PersistState | null {\n  try {\n    const raw = localStorage.getItem(\"image_workspace_v2\");\n    return raw ? JSON.parse(raw) : null;\n  } catch {\n    return null;\n  }\n}\n\n/**\n * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ localStorage.\n */\nexport function savePersist(s: PersistState) {\n  try {\n    localStorage.setItem(\"image_workspace_v2\", JSON.stringify(s));\n  } catch {}\n}"
    }
  ]
}