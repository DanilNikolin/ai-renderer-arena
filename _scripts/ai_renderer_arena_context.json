{
  "project_name": "ai-renderer-arena",
  "file_tree": "## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞\n\n```\nai-renderer-arena\n‚îú‚îÄ‚îÄ .gitignore\n‚îú‚îÄ‚îÄ README.md\n‚îú‚îÄ‚îÄ eslint.config.mjs\n‚îú‚îÄ‚îÄ next-env.d.ts\n‚îú‚îÄ‚îÄ next.config.ts\n‚îú‚îÄ‚îÄ package.json\n‚îú‚îÄ‚îÄ postcss.config.mjs\n‚îú‚îÄ‚îÄ src\n‚îÇ   ‚îú‚îÄ‚îÄ app\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api\n‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ generate\n‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ route.ts\n‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ refine-prompt\n‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ route.ts\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ globals.css\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx\n‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx\n‚îÇ   ‚îî‚îÄ‚îÄ components\n‚îÇ       ‚îî‚îÄ‚îÄ ImageWorkspace.tsx\n‚îú‚îÄ‚îÄ tailwind.config.ts\n‚îî‚îÄ‚îÄ tsconfig.json\n```\n\n---\n\n",
  "code_files": [
    {
      "path": ".gitignore",
      "content": "# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.\n\n# dependencies\n/node_modules\n/.pnp\n.pnp.*\n.yarn/*\n!.yarn/patches\n!.yarn/plugins\n!.yarn/releases\n!.yarn/versions\n\n# testing\n/coverage\n\n# next.js\n/.next/\n/out/\n\n# production\n/build\n\n# misc\n.DS_Store\n*.pem\n\n# debug\nnpm-debug.log*\nyarn-debug.log*\nyarn-error.log*\n.pnpm-debug.log*\n\n# env files (can opt-in for committing if needed)\n.env*\n\n# vercel\n.vercel\n\n# typescript\n*.tsbuildinfo\nnext-env.d.ts\n"
    },
    {
      "path": "eslint.config.mjs",
      "content": "import { dirname } from \"path\";\nimport { fileURLToPath } from \"url\";\nimport { FlatCompat } from \"@eslint/eslintrc\";\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = dirname(__filename);\n\nconst compat = new FlatCompat({\n  baseDirectory: __dirname,\n});\n\nconst eslintConfig = [\n  ...compat.extends(\"next/core-web-vitals\", \"next/typescript\"),\n  {\n    ignores: [\n      \"node_modules/**\",\n      \".next/**\",\n      \"out/**\",\n      \"build/**\",\n      \"next-env.d.ts\",\n    ],\n  },\n];\n\nexport default eslintConfig;\n"
    },
    {
      "path": "next-env.d.ts",
      "content": "/// <reference types=\"next\" />\n/// <reference types=\"next/image-types/global\" />\n/// <reference path=\"./.next/types/routes.d.ts\" />\n\n// NOTE: This file should not be edited\n// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.\n"
    },
    {
      "path": "next.config.ts",
      "content": "import type { NextConfig } from \"next\";\n\nconst nextConfig: NextConfig = {\n  /* config options here */\n};\n\nexport default nextConfig;\n"
    },
    {
      "path": "package.json",
      "content": "{\n  \"name\": \"ai-renderer-arena\",\n  \"version\": \"0.1.0\",\n  \"private\": true,\n  \"scripts\": {\n    \"dev\": \"next dev\",\n    \"build\": \"next build\",\n    \"start\": \"next start\",\n    \"lint\": \"eslint\"\n  },\n  \"dependencies\": {\n    \"@fal-ai/client\": \"^1.6.2\",\n    \"next\": \"^15.5.3\",\n    \"openai\": \"^5.20.3\",\n    \"react\": \"^19.1.1\",\n    \"react-dom\": \"^19.1.1\"\n  },\n  \"devDependencies\": {\n    \"@eslint/eslintrc\": \"^3\",\n    \"@tailwindcss/postcss\": \"^4\",\n    \"@types/node\": \"^20\",\n    \"@types/react\": \"^19\",\n    \"@types/react-dom\": \"^19\",\n    \"autoprefixer\": \"^10.4.21\",\n    \"eslint\": \"^9\",\n    \"eslint-config-next\": \"15.5.3\",\n    \"postcss\": \"^8.5.6\",\n    \"tailwindcss\": \"^4\",\n    \"typescript\": \"^5\"\n  }\n}\n"
    },
    {
      "path": "postcss.config.mjs",
      "content": "const config = {\n  plugins: [\"@tailwindcss/postcss\"],\n};\n\nexport default config;"
    },
    {
      "path": "README.md",
      "content": "This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).\n\n## Getting Started\n\nFirst, run the development server:\n\n```bash\nnpm run dev\n# or\nyarn dev\n# or\npnpm dev\n# or\nbun dev\n```\n\nOpen [http://localhost:3000](http://localhost:3000) with your browser to see the result.\n\nYou can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.\n\nThis project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.\n\n## Learn More\n\nTo learn more about Next.js, take a look at the following resources:\n\n- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.\n- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.\n\nYou can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!\n\n## Deploy on Vercel\n\nThe easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.\n\nCheck out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.\n"
    },
    {
      "path": "tailwind.config.ts",
      "content": "import type { Config } from \"tailwindcss\";\n\nconst config: Config = {\n  content: [\n    \"./src/pages/**/*.{js,ts,jsx,tsx,mdx}\",\n    \"./src/components/**/*.{js,ts,jsx,tsx,mdx}\",\n    \"./src/app/**/*.{js,ts,jsx,tsx,mdx}\",\n  ],\n  theme: {\n    extend: {\n      backgroundImage: {\n        \"gradient-radial\": \"radial-gradient(var(--tw-gradient-stops))\",\n        \"gradient-conic\":\n          \"conic-gradient(from 180deg at 50% 50%, var(--tw-gradient-stops))\",\n      },\n      // ‚ú® –î–æ–±–∞–≤–∏–º —Å—é–¥–∞ –Ω–∞—à–∏ –∫–∞—Å—Ç–æ–º–Ω—ã–µ —Ü–≤–µ—Ç–∞ –∏–∑ —Ç–≤–æ–µ–≥–æ –∫–æ–¥–∞, —á—Ç–æ–±—ã –≤—Å–µ –±—ã–ª–æ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ\n      colors: {\n        'gray-850': '#1b2332',\n      },\n    },\n  },\n  plugins: [],\n};\nexport default config;"
    },
    {
      "path": "tsconfig.json",
      "content": "{\n  \"compilerOptions\": {\n    \"target\": \"ES2017\",\n    \"lib\": [\"dom\", \"dom.iterable\", \"esnext\"],\n    \"allowJs\": true,\n    \"skipLibCheck\": true,\n    \"strict\": true,\n    \"noEmit\": true,\n    \"esModuleInterop\": true,\n    \"module\": \"esnext\",\n    \"moduleResolution\": \"bundler\",\n    \"resolveJsonModule\": true,\n    \"isolatedModules\": true,\n    \"jsx\": \"preserve\",\n    \"incremental\": true,\n    \"plugins\": [\n      {\n        \"name\": \"next\"\n      }\n    ],\n    \"paths\": {\n      \"@/*\": [\"./src/*\"]\n    }\n  },\n  \"include\": [\"next-env.d.ts\", \"**/*.ts\", \"**/*.tsx\", \".next/types/**/*.ts\"],\n  \"exclude\": [\"node_modules\"]\n}\n"
    },
    {
      "path": "src/app/globals.css",
      "content": "\n@import \"tailwindcss\";\n@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\nbody {\n  background-color: #111827; /* –ù–µ–º–Ω–æ–≥–æ —Å–º—è–≥—á–∏–º —Ñ–æ–Ω */\n  color: #d1d5db; /* –°–¥–µ–ª–∞–µ–º —Ç–µ–∫—Å—Ç —á—É—Ç—å –º–µ–Ω–µ–µ —Ä–µ–∑–∫–∏–º */\n}\n\n/* –≠—Ñ—Ñ–µ–∫—Ç —Å–≤–µ—á–µ–Ω–∏—è –¥–ª—è —Ç–µ–∫—Å—Ç–∞ */\n.text-glow {\n  text-shadow: 0 0 8px rgba(56, 189, 248, 0.4);\n}\n\n/* –ü–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */\nbutton,\ntextarea,\ninput,\nlabel {\n  transition: all 0.2s ease-in-out;\n}\n\n/* –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä –ø–æ–¥ –Ω–∞—à—É —Ç–µ–º—É */\n::-webkit-scrollbar {\n  width: 8px;\n}\n::-webkit-scrollbar-track {\n  background: #1f2937;\n}\n::-webkit-scrollbar-thumb {\n  background: #4b5563;\n  border-radius: 4px;\n}\n::-webkit-scrollbar-thumb:hover {\n  background: #6b7280;\n}\n/* –£–∑–∫–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */\n.container-narrow {\n  max-width: 1100px; /* –º–æ–∂–µ—à—å –ø–æ—Å—Ç–∞–≤–∏—Ç—å 960px/1200px –µ—Å–ª–∏ —Ö–æ—á–µ—à—å —É–∂–µ/—à–∏—Ä–µ */\n  margin: 0 auto;\n  padding: 16px;\n}\n\n@media (min-width: 768px) {\n  .container-narrow { padding: 24px; }\n}\n@media (min-width: 1024px) {\n  .container-narrow { padding: 32px; }\n}\n\n/* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —á—É—Ç—å –±–æ–ª–µ–µ —Ç—ë–º–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ */\n.bg-gray-850 {\n  background-color: #1b2332; /* –º—è–≥–∫–∏–π —Ç—ë–º–Ω—ã–π –º–µ–∂–¥—É 800 –∏ 900 */\n}\n"
    },
    {
      "path": "src/app/layout.tsx",
      "content": "//D:\\Work\\Image test for 3Dims (3 models)\\ai-renderer-arena\\src\\app\\layout.tsx\nimport type { Metadata } from \"next\";\nimport { Inter } from \"next/font/google\";\nimport \"./globals.css\";\n\nconst inter = Inter({ subsets: [\"latin\", \"cyrillic\"] });\n\nexport const metadata: Metadata = {\n  title: \"AI Renderer Arena\",\n  description: \"Instruction-Based Image Editing Testbed\",\n};\n\nexport default function RootLayout({ children }: { children: React.ReactNode }) {\n  return (\n    <html lang=\"ru\">\n      <body className={inter.className}>{children}</body>\n    </html>\n  );\n}\n"
    },
    {
      "path": "src/app/page.tsx",
      "content": "//D:\\Work\\Image test for 3Dims (3 models)\\ai-renderer-arena\\src\\app\\page.tsx\nimport ImageWorkspace from \"@/components/ImageWorkspace\";\n\nexport default function HomePage() {\n  return (\n    <main>\n      <div className=\"container-narrow\">\n        <header className=\"mb-6\">\n          <h1 className=\"text-2xl md:text-3xl font-bold text-cyan-400 text-glow\">AI Renderer Arena</h1>\n          <p className=\"text-gray-400 text-sm mt-1\">\n            Instruction-Based Image Editing ‚Ä¢ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –∏ –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–Ω–∏—è\n          </p>\n        </header>\n\n        <ImageWorkspace />\n      </div>\n    </main>\n  );\n}\n"
    },
    {
      "path": "src/app/api/generate/route.ts",
      "content": "// D:\\Work\\Image test for 3Dims (3 models)\\ai-renderer-arena\\src\\app\\api\\generate\\route.ts\n\nimport { NextRequest, NextResponse } from \"next/server\";\n\n// –ò–ó–ú–ï–ù–ï–ù–ò–ï ‚Ññ1: –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ç–µ–ø–µ—Ä—å –¥–æ–ª–∂–µ–Ω —É—á–∏—Ç—ã–≤–∞—Ç—å –û–ë–ê –≤–∞—Ä–∏–∞–Ω—Ç–∞\ninterface FalRequestBody {\n  prompt: string;\n  image_url?: string;      // –î–ª—è Qwen, Flux\n  image_urls?: string[];   // –î–ª—è Nano Banana\n  negative_prompt?: string;\n  seed?: number;\n  num_inference_steps?: number;\n  guidance_scale?: number;\n  safety_tolerance?: number;\n}\n\nexport async function POST(req: NextRequest) {\n  const FAL_KEY = process.env.FAL_KEY;\n  if (!FAL_KEY) {\n    return NextResponse.json({ error: \"–ö–ª—é—á API –¥–ª—è fal.ai –Ω–µ –Ω–∞–π–¥–µ–Ω\" }, { status: 500 });\n  }\n\n  try {\n    const formData = await req.formData();\n    const model = formData.get(\"model\") as string | null;\n    const prompt = formData.get(\"prompt\") as string | null;\n    const negativePrompt = formData.get(\"negative_prompt\") as string | null;\n    const imageFile = formData.get(\"image\") as File | null;\n    const settingsStr = formData.get(\"settings\") as string | null;\n\n    if (!model || !prompt || !imageFile) {\n      return NextResponse.json({ error: \"–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è\" }, { status: 400 });\n    }\n\n    const imageBuffer = Buffer.from(await imageFile.arrayBuffer());\n    const imageUrl = `data:${imageFile.type};base64,${imageBuffer.toString(\"base64\")}`;\n\n    let endpointUrl: string;\n    const settings = settingsStr ? JSON.parse(settingsStr) : {};\n\n    // –ë–∞–∑–æ–≤–æ–µ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö –æ–± –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏\n    const body: FalRequestBody = {\n      prompt: prompt,\n    };\n    if (negativePrompt) {\n      body.negative_prompt = negativePrompt;\n    }\n\n    // –ò–ó–ú–ï–ù–ï–ù–ò–ï ‚Ññ2: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –≤ –Ω—É–∂–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ\n    switch (model) {\n      case \"qwen\":\n        endpointUrl = 'https://fal.run/fal-ai/qwen-image-edit';\n        body.image_url = imageUrl; // <--- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ —Å—Ç—Ä–æ–∫—É\n        body.guidance_scale = settings.guidance_scale;\n        body.num_inference_steps = settings.num_inference_steps;\n        body.seed = settings.seed;\n        break;\n      case \"flux\":\n        endpointUrl = 'https://fal.run/fal-ai/flux-pro/kontext';\n        body.image_url = imageUrl; // <--- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ —Å—Ç—Ä–æ–∫—É\n        body.guidance_scale = settings.guidance_scale;\n        body.safety_tolerance = settings.safety_tolerance;\n        body.seed = settings.seed;\n        break;\n      \n      case \"gemini\":\n        endpointUrl = 'https://fal.run/fal-ai/nano-banana/edit';\n        body.image_urls = [imageUrl]; // <--- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ –º–∞—Å—Å–∏–≤\n        if (settings.seed) {\n            body.seed = settings.seed;\n        }\n        break;\n\n      default:\n        return NextResponse.json({ error: `–ú–æ–¥–µ–ª—å '${model}' –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è` }, { status: 400 });\n    }\n    \n    const response = await fetch(endpointUrl, {\n      method: 'POST',\n      headers: { 'Authorization': `Key ${FAL_KEY}`, 'Content-Type': 'application/json' },\n      body: JSON.stringify(body),\n    });\n    \n    if (!response.ok) {\n      const errorText = await response.text();\n      console.error(\"API Error Response:\", errorText); \n      return NextResponse.json({ error: `–û—à–∏–±–∫–∞ API: ${errorText}` }, { status: response.status });\n    }\n\n    const data = await response.json();\n    const finalImageUrl = data.images?.[0]?.url;\n\n    if (!finalImageUrl) {\n        console.error(\"API did not return an image URL. Response:\", data); \n        return NextResponse.json({ error: \"API –Ω–µ –≤–µ—Ä–Ω—É–ª–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ\" }, { status: 500 });\n    }\n    \n    return NextResponse.json({ imageUrl: finalImageUrl });\n\n  } catch (e: any) {\n    console.error(\"Server-side error:\", e); \n    return NextResponse.json({ error: e.message || \"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ\" }, { status: 500 });\n  }\n}"
    },
    {
      "path": "src/app/api/refine-prompt/route.ts",
      "content": "// src/app/api/refine-prompt/route.ts\n\nimport { NextRequest, NextResponse } from \"next/server\";\nimport OpenAI from \"openai\";\n\nexport const runtime = \"nodejs\";\n\nconst openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY! });\n\nexport async function POST(req: NextRequest) {\n  if (!process.env.OPENAI_API_KEY) {\n    return NextResponse.json({ error: \"–ö–ª—é—á API –¥–ª—è OpenAI –Ω–µ –Ω–∞–π–¥–µ–Ω\" }, { status: 500 });\n  }\n\n  try {\n    const formData = await req.formData();\n\n    const rawPrompt = formData.get(\"prompt\") as string | null;\n    const modelName = formData.get(\"model\") as string | null;\n    const imageFile = formData.get(\"image\") as File | null;\n    const systemPrompt = formData.get(\"system_prompt\") as string | null;\n    const temperatureStr = formData.get(\"temperature\") as string | null;\n    const topPStr = formData.get(\"top_p\") as string | null;\n    const maxTokensStr = formData.get(\"max_completion_tokens\") as string | null; // –ø—Ä–∏—Ö–æ–¥–∏—Ç —Ç–∞–∫, –Ω–æ –Ω–∏–∂–µ –º–∞–ø–∏–º –Ω–∞ max_tokens\n\n    if (!rawPrompt || !modelName || !systemPrompt) {\n      return NextResponse.json({ error: \"–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: prompt, model, system_prompt\" }, { status: 400 });\n    }\n\n    const messages: any[] = [\n      { role: \"system\", content: systemPrompt },\n      { role: \"user\", content: [{ type: \"text\", text: `Refine this prompt: \"${rawPrompt}\"` }] },\n    ];\n\n    if (imageFile) {\n      // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –º–æ–¥–µ–ª—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç vision, –ø—Ä–µ–∂–¥–µ —á–µ–º –¥–æ–±–∞–≤–ª—è—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É.\n      // –≠—Ç–æ –ø—Ä–∏–º–µ—Ä–Ω–∞—è –ª–æ–≥–∏–∫–∞; –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥—É—é –ø—Ä–æ–≤–µ—Ä–∫—É.\n      if (!modelName.includes(\"4o\")) {\n         return NextResponse.json({ error: `–ú–æ–¥–µ–ª—å '${modelName}' –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.` }, { status: 400 });\n      }\n      const imageBuffer = Buffer.from(await imageFile.arrayBuffer());\n      const base64Image = imageBuffer.toString(\"base64\");\n      (messages[1].content as any[]).push({\n        type: \"image_url\",\n        image_url: { url: `data:${imageFile.type};base64,${base64Image}` },\n      });\n    }\n\n    const temperature = temperatureStr ? parseFloat(temperatureStr) : undefined;\n    const top_p = topPStr ? parseFloat(topPStr) : undefined;\n    const max_tokens = maxTokensStr ? parseInt(maxTokensStr, 10) : undefined; // ‚úî –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è Chat Completions\n\n    const response = await openai.chat.completions.create({\n        model: modelName,\n        messages,\n        temperature,\n        top_p,\n        max_completion_tokens: max_tokens, // <--- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª—é—á, –∫–æ—Ç–æ—Ä—ã–π —Ç—Ä–µ–±—É–µ—Ç API\n        });\n\n    const refinedPrompt = response.choices[0]?.message?.content?.trim();\n\n    if (!refinedPrompt) {\n      console.error(\"Full OpenAI Response on Empty Content:\", JSON.stringify(response, null, 2));\n      const finishReason = response.choices[0]?.finish_reason || \"unknown_reason\";\n      const detailedError = `OpenAI –Ω–µ –≤–µ—Ä–Ω—É–ª–∞ —É–ª—É—á—à–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç. –ü—Ä–∏—á–∏–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: '${finishReason}'. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.`;\n      return NextResponse.json({ error: detailedError }, { status: 500 });\n    }\n\n    return NextResponse.json({ refinedPrompt });\n  } catch (e: any) {\n    console.error(\"OpenAI API Error:\", e);\n    const errorMessage = e.response?.data?.error?.message || e.message || \"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ\";\n    return NextResponse.json({ error: errorMessage }, { status: 500 });\n  }\n}"
    },
    {
      "path": "src/components/ImageWorkspace.tsx",
      "content": "\"use client\";\n\nimport React, {\n  useState,\n  useMemo,\n  useEffect,\n  useRef,\n  ChangeEvent,\n  DragEvent,\n  KeyboardEvent,\n} from \"react\";\n\n/** ---------- types & const ---------- */\ntype Model = \"gemini\" | \"qwen\" | \"flux\";\n\nconst MAX_FILE_SIZE_MB = 10;\nconst ACCEPTED_FILE_TYPES = [\"image/png\", \"image/jpeg\", \"image/webp\"];\n\ntype QwenSettings = { guidance_scale: number; num_inference_steps: number; seed: number };\ntype FluxSettings = { guidance_scale: number; safety_tolerance: number; seed: number };\n\ntype PersistState = {\n  prompt: string;\n  negativePrompt: string;\n  selectedModel: Model;\n  qwenSettings: QwenSettings;\n  fluxSettings: FluxSettings;\n};\n\n/** ---------- utils ---------- */\nfunction cx(...s: (string | false | undefined)[]) {\n  return s.filter(Boolean).join(\" \");\n}\n\nfunction readImageDims(file: File): Promise<{ w: number; h: number }> {\n  return new Promise((res, rej) => {\n    const img = new Image();\n    img.onload = () => res({ w: img.naturalWidth, h: img.naturalHeight });\n    img.onerror = rej;\n    img.src = URL.createObjectURL(file);\n  });\n}\n\nfunction loadPersist(): PersistState | null {\n  try {\n    const raw = localStorage.getItem(\"image_workspace_v2\");\n    return raw ? JSON.parse(raw) : null;\n  } catch {\n    return null;\n  }\n}\n\nfunction savePersist(s: PersistState) {\n  try {\n    localStorage.setItem(\"image_workspace_v2\", JSON.stringify(s));\n  } catch {}\n}\n\n/** ---------- small UI atoms ---------- */\nconst Label: React.FC<{ title: string; right?: React.ReactNode; className?: string }> = ({ title, right, className }) => (\n  <div className={cx(\"flex items-center justify-between mb-1.5\", className)}>\n    <span className=\"text-xs text-gray-300\">{title}</span>\n    {right}\n  </div>\n);\n\nconst Slider: React.FC<{\n  label: string;\n  value: number;\n  min: number;\n  max: number;\n  step: number;\n  onChange: (e: ChangeEvent<HTMLInputElement>) => void;\n  info?: string;\n  name: string;\n}> = ({ label, value, min, max, step, onChange, info, name }) => (\n  <label className=\"block space-y-1\">\n    <Label\n      title={label}\n      right={\n        <input\n          type=\"number\"\n          value={value}\n          onChange={onChange}\n          min={min}\n          max={max}\n          step={step}\n          name={name}\n          className=\"w-20 bg-gray-900 border border-gray-700 rounded p-1.5 text-xs text-center\"\n\n        />\n      }\n    />\n    <input\n      type=\"range\"\n      value={value}\n      min={min}\n      max={max}\n      step={step}\n      onChange={onChange}\n      name={name}\n      className=\"w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-cyan-500\"\n    />\n    {info && <p className=\"text-[10px] text-gray-500\">{info}</p>}\n  </label>\n);\n\n/** ---------- main ---------- */\nexport default function ImageWorkspace() {\n  const [sourceFile, setSourceFile] = useState<File | null>(null);\n  const [sourceUrl, setSourceUrl] = useState<string | null>(null);\n  const [resultUrl, setResultUrl] = useState<string | null>(null);\n  const [prompt, setPrompt] = useState(\"\");\n  const [rawPrompt, setRawPrompt] = useState(\"\"); // <-- –î–ª—è \"–º—É—Å–æ—Ä–Ω–æ–≥–æ\" –ø—Ä–æ–º—Ç–∞\n  const [isRefining, setIsRefining] = useState(false); // <-- –ó–∞–≥—Ä—É–∑–∫–∞ LLM\n  const [refineError, setRefineError] = useState<string | null>(null); // <-- –û—à–∏–±–∫–∞ LLM\n  const [sendImageToLlm, setSendImageToLlm] = useState(true); // <-- –°–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–∞\n  const [showRefiner, setShowRefiner] = useState(false); // <-- –î–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –±–ª–æ–∫–∞\n  const [llmSettings, setLlmSettings] = useState({\n  model: 'gpt-5-mini' as 'gpt-5-mini' | 'gpt-5-nano',\n  systemPrompt: `You are an expert prompt engineer for an instruction-based image editing model. Your goal is to convert the user's short, messy request into a detailed, clear, and effective instruction. The user will provide a source image of a sauna and a short text. Your output must be a single, concise instruction in English. Focus on photorealism and accurate material descriptions. For example, if the user writes '—Å—Ç–µ–Ω—ã –∫–µ–¥—Ä, –ø–æ–ª–∫–∏ –æ—Å–∏–Ω–∞', you should output 'Change the vertical wall panels to photorealistic Canadian cedar wood, and make the benches from smooth, light aspen wood'.`,\n  temperature: 0.7,\n  topP: 1,\n  maxCompletionTokens: 200,\n});\n  const [negativePrompt, setNegativePrompt] = useState(\"blurry, ugly, deformed, text, watermark\");\n  const [showNeg, setShowNeg] = useState(false);\n  const [selectedModel, setSelectedModel] = useState<Model>(\"flux\");\n  const [isLoading, setIsLoading] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [imageInfo, setImageInfo] = useState<{ w: number; h: number } | null>(null);\n  const [tab, setTab] = useState<\"source\" | \"result\" | \"compare\">(\"source\");\n  const [comparePos, setComparePos] = useState(50); // %\n  const [seedLock, setSeedLock] = useState(false);\n\n  const abortControllerRef = useRef<AbortController | null>(null);\n  const dropRef = useRef<HTMLLabelElement | null>(null);\n\n  // settings\n  const [qwenSettings, setQwenSettings] = useState<QwenSettings>({\n    guidance_scale: 4,\n    num_inference_steps: 30,\n    seed: 0,\n  });\n  const [fluxSettings, setFluxSettings] = useState<FluxSettings>({\n    guidance_scale: 3.5,\n    safety_tolerance: 2,\n    seed: 0,\n  });\n\n  const handleQwenChange = (e: ChangeEvent<HTMLInputElement>) => {\n    setQwenSettings((p) => ({ ...p, [e.target.name]: Number(e.target.value) }));\n  };\n  const handleFluxChange = (e: ChangeEvent<HTMLInputElement>) => {\n    setFluxSettings((p) => ({ ...p, [e.target.name]: Number(e.target.value) }));\n  };\n\n  // persist\n  useEffect(() => {\n    const p = loadPersist();\n    if (!p) return;\n    setPrompt(p.prompt ?? \"\");\n    setNegativePrompt(p.negativePrompt ?? \"blurry, ugly, deformed, text, watermark\");\n    setSelectedModel(p.selectedModel ?? \"flux\");\n    setQwenSettings(p.qwenSettings ?? { guidance_scale: 4, num_inference_steps: 30, seed: 0 });\n    setFluxSettings(p.fluxSettings ?? { guidance_scale: 3.5, safety_tolerance: 2, seed: 0 });\n  }, []);\n\n  useEffect(() => {\n    savePersist({\n      prompt,\n      negativePrompt,\n      selectedModel,\n      qwenSettings,\n      fluxSettings,\n    });\n  }, [prompt, negativePrompt, selectedModel, qwenSettings, fluxSettings]);\n\n  // revoke URL\n  useEffect(() => {\n    return () => {\n      if (sourceUrl) URL.revokeObjectURL(sourceUrl);\n    };\n  }, [sourceUrl]);\n\n  // keyboard shortcuts\n  const onKeyDown = (e: KeyboardEvent<HTMLDivElement>) => {\n    if (e.key === \"Enter\" && (e.metaKey || e.ctrlKey || (e.target as HTMLElement).tagName !== \"TEXTAREA\")) {\n      e.preventDefault();\n      onGenerate();\n    }\n    if (e.key === \"Escape\") {\n      if (isLoading) onCancel();\n    }\n  };\n\n  const handleLlmSettingsChange = (e: ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {\n    const { name, value, type } = e.target;\n    setLlmSettings(prev => ({\n      ...prev,\n      [name]: type === 'number' ? parseFloat(value) : value,\n    }));\n  };\n\n  const onRefinePrompt = async () => {\n  if (!rawPrompt.trim()) return;\n  setIsRefining(true);\n  setRefineError(null);\n  abortControllerRef.current = new AbortController();\n\n  const formData = new FormData();\n  formData.append(\"prompt\", rawPrompt);\n  \n  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ –æ–±—ä–µ–∫—Ç–∞ llmSettings\n  formData.append(\"model\", llmSettings.model);\n  formData.append(\"system_prompt\", llmSettings.systemPrompt);\n  formData.append(\"temperature\", llmSettings.temperature.toString());\n  formData.append(\"top_p\", llmSettings.topP.toString());\n  formData.append(\"max_completion_tokens\", llmSettings.maxCompletionTokens.toString());\n\n  if (sendImageToLlm && sourceFile) {\n    formData.append(\"image\", sourceFile);\n  }\n  \n  try {\n    const response = await fetch(\"/api/refine-prompt\", {\n      method: \"POST\",\n      body: formData,\n      signal: abortControllerRef.current.signal,\n    });\n    if (!response.ok) {\n      const errorData = await response.json().catch(() => ({}));\n      throw new Error(errorData.error || \"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ API\");\n    }\n    const data = await response.json();\n    setPrompt(data.refinedPrompt);\n    setShowRefiner(false);\n  } catch (e: any) {\n    if (e.name === \"AbortError\") {\n      setRefineError(\"–£–ª—É—á—à–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.\");\n    } else {\n      setRefineError(e.message);\n    }\n  } finally {\n    setIsRefining(false);\n  }\n};\n\n  const isReadyToGenerate = useMemo(() => !!sourceFile && !!prompt.trim() && !isLoading, [sourceFile, prompt, isLoading]);\n\n  const fail = (msg: string) => {\n    setError(msg);\n    setIsLoading(false);\n  };\n\n  const handleFileSelect = async (file: File) => {\n    if (file.size > MAX_FILE_SIZE_MB * 1024 * 1024) {\n      return fail(`–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å ${MAX_FILE_SIZE_MB} MB.`);\n    }\n    if (!ACCEPTED_FILE_TYPES.includes(file.type)) {\n      return fail(\"–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ PNG, JPEG –∏–ª–∏ WebP.\");\n    }\n    setError(null);\n    setResultUrl(null);\n    setTab(\"source\");\n    setSourceFile(file);\n    if (sourceUrl) URL.revokeObjectURL(sourceUrl);\n    const url = URL.createObjectURL(file);\n    setSourceUrl(url);\n    try {\n      const dims = await readImageDims(file);\n      setImageInfo(dims);\n    } catch {\n      setImageInfo(null);\n    }\n  };\n\n  const onFileChange = (e: ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (file) handleFileSelect(file);\n    e.target.value = \"\";\n  };\n\n  const onDrop = (e: DragEvent<HTMLLabelElement>) => {\n    e.preventDefault();\n    const file = e.dataTransfer.files?.[0];\n    if (file) handleFileSelect(file);\n  };\n\n  const onPaste = async (e: ClipboardEvent) => {\n    const items = (e.clipboardData || (window as any).clipboardData).items;\n    if (!items) return;\n    for (const it of items) {\n      if (it.type.startsWith(\"image/\")) {\n        const file = it.getAsFile();\n        if (file) {\n          await handleFileSelect(file);\n          break;\n        }\n      }\n    }\n  };\n\n  useEffect(() => {\n    const handler = (ev: ClipboardEvent) => onPaste(ev);\n    window.addEventListener(\"paste\", handler as any);\n    return () => window.removeEventListener(\"paste\", handler as any);\n  }, []);\n\n  const onClear = () => {\n    if (sourceUrl) URL.revokeObjectURL(sourceUrl);\n    setSourceFile(null);\n    setSourceUrl(null);\n    setResultUrl(null);\n    setError(null);\n    setPrompt(\"\");\n    setImageInfo(null);\n    setTab(\"source\");\n  };\n\n  const onCancel = () => {\n    abortControllerRef.current?.abort();\n    setIsLoading(false);\n    setError(\"–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.\");\n  };\n\n  const randomizeSeed = () => {\n    const seed = Math.floor(Math.random() * 2_147_483_647);\n    if (selectedModel === \"flux\") setFluxSettings((p) => ({ ...p, seed }));\n    if (selectedModel === \"qwen\") setQwenSettings((p) => ({ ...p, seed }));\n  };\n\n  const onGenerate = async () => {\n    if (!isReadyToGenerate || !sourceFile) return;\n    setIsLoading(true);\n    setError(null);\n    setResultUrl(null);\n    abortControllerRef.current = new AbortController();\n\n    const formData = new FormData();\n    formData.append(\"image\", sourceFile);\n    formData.append(\"prompt\", prompt);\n    formData.append(\"negative_prompt\", negativePrompt);\n    formData.append(\"model\", selectedModel);\n\n    let settings: any = {};\n    if (selectedModel === \"qwen\") settings = qwenSettings;\n    if (selectedModel === \"flux\") settings = fluxSettings;\n\n    // –µ—Å–ª–∏ —Å–∏–¥ –Ω–µ –∑–∞–ª–æ—á–µ–Ω ‚Äî –ø–æ–¥–∫–∏–Ω–µ–º –Ω–æ–≤—ã–π –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è\n    if (!seedLock) {\n      const seed = Math.floor(Math.random() * 2_147_483_647);\n      settings = { ...settings, seed };\n      if (selectedModel === \"flux\") setFluxSettings((p) => ({ ...p, seed }));\n      if (selectedModel === \"qwen\") setQwenSettings((p) => ({ ...p, seed }));\n    }\n\n    formData.append(\"settings\", JSON.stringify(settings));\n\n    try {\n      const response = await fetch(\"/api/generate\", {\n        method: \"POST\",\n        body: formData,\n        signal: abortControllerRef.current.signal,\n      });\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}));\n        throw new Error(errorData.error || \"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ API\");\n      }\n      const data = await response.json();\n      setResultUrl(data.imageUrl);\n      setTab(\"result\");\n    } catch (e: any) {\n      if (e.name === \"AbortError\") {\n        setError(\"–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.\");\n      } else {\n        setError(e.message);\n      }\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"grid grid-cols-1 xl:grid-cols-[360px_minmax(0,1fr)] gap-6\" onKeyDown={onKeyDown} tabIndex={0}>\n      {/* ---------- Sidebar ---------- */}\n      <aside className=\"bg-gray-850 border border-gray-800 rounded-xl p-4 lg:p-5 sticky top-6 h-fit\">\n        {/* file */}\n        <div className=\"space-y-2\">\n          <Label\n            title=\"–ò—Å—Ö–æ–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ\"\n            right={\n              imageInfo && (\n                <span className=\"text-[10px] text-gray-500\">\n                  {imageInfo.w}√ó{imageInfo.h}px\n                </span>\n              )\n            }\n          />\n          <label\n            ref={dropRef}\n            htmlFor=\"image-upload\"\n            onDrop={onDrop}\n            onDragOver={(e) => e.preventDefault()}\n            className={cx(\n              \"group border border-dashed rounded-lg p-4 text-center cursor-pointer transition\",\n              \"border-gray-700 hover:border-cyan-500 bg-gray-900/50\"\n            )}\n            title=\"–ü–µ—Ä–µ—Ç–∞—â–∏ —Ñ–∞–π–ª –∏–ª–∏ –∫–ª–∏–∫–Ω–∏. –ú–æ–∂–Ω–æ —Ç–∞–∫–∂–µ –≤—Å—Ç–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞ Ctrl+V.\"\n          >\n            {sourceFile ? (\n              <div className=\"text-left space-y-1\">\n                <p className=\"text-cyan-400 text-sm font-medium truncate\">{sourceFile.name}</p>\n                <p className=\"text-xs text-gray-500\">\n                  {(sourceFile.size / 1024 / 1024).toFixed(2)} MB ‚Ä¢ {sourceFile.type.replace(\"image/\", \"\").toUpperCase()}\n                </p>\n              </div>\n            ) : (\n              <div className=\"space-y-1\">\n                <p className=\"text-sm text-gray-400\">–ü–µ—Ä–µ—Ç–∞—â–∏ –∏–ª–∏ –Ω–∞–∂–º–∏, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å</p>\n                <p className=\"text-xs text-gray-500\">PNG, JPEG, WebP ‚Ä¢ –¥–æ {MAX_FILE_SIZE_MB}MB ‚Ä¢ Ctrl+V –∏–∑ –±—É—Ñ–µ—Ä–∞</p>\n              </div>\n            )}\n            <input id=\"image-upload\" type=\"file\" className=\"hidden\" accept={ACCEPTED_FILE_TYPES.join(\",\")} onChange={onFileChange} />\n          </label>\n        </div>\n\n\n        {/* prompt refiner */}\n          <div className=\"mt-5 space-y-3 bg-gray-900/50 border border-gray-700/50 rounded-lg p-3\">\n            <button type=\"button\" onClick={() => setShowRefiner(v => !v)} className=\"w-full text-left text-sm font-medium text-cyan-400\">\n              {showRefiner ? \"‚ñº –°–∫—Ä—ã—Ç—å ¬´–ü—Ä–æ–º–ø—Ç-–ò–Ω–∂–µ–Ω–µ—Ä¬ª\" : \"‚ñ∫ –û—Ç–∫—Ä—ã—Ç—å ¬´–ü—Ä–æ–º–ø—Ç-–ò–Ω–∂–µ–Ω–µ—Ä¬ª\"}\n            </button>\n            {showRefiner && (\n              <div className=\"pt-2 space-y-4\">\n                <div>\n                  <Label title=\"1. –°—ã—Ä–∞—è –∏–¥–µ—è\" />\n                  <textarea\n                    rows={3}\n                    className=\"w-full bg-gray-900 border border-gray-800 rounded-lg p-3 text-sm placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-500\"\n                    placeholder=\"–û–ø–∏—à–∏ –∑–∞–¥–∞—á—É –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ (–Ω–∞–ø—Ä.: —Å—Ç–µ–Ω—ã –∫–µ–¥—Ä, –ª–∞–≤–∫–∏ –æ—Å–∏–Ω–∞)\"\n                    value={rawPrompt}\n                    onChange={(e) => setRawPrompt(e.target.value)}\n                  />\n                </div>\n\n                <div>\n                  <Label title=\"2. –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è LLM\" />\n                  <textarea\n                    name=\"systemPrompt\"\n                    rows={6}\n                    className=\"w-full bg-gray-900 border border-gray-800 rounded-lg p-3 text-xs font-mono placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-500\"\n                    value={llmSettings.systemPrompt}\n                    onChange={handleLlmSettingsChange}\n                  />\n                </div>\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <Label title=\"–ú–æ–¥–µ–ª—å\" />\n                    <div className=\"flex items-center gap-2 rounded-lg bg-gray-950 p-1\">\n                      {(['gpt-5-mini', 'gpt-5-nano'] as const).map(model => (\n                        <button\n                          key={model}\n                          onClick={() => setLlmSettings(p => ({ ...p, model }))}\n                          className={`w-full px-2 py-1 text-xs rounded-md transition-colors ${\n                            llmSettings.model === model ? 'bg-cyan-600 text-white' : 'hover:bg-gray-800'\n                          }`}\n                        >\n                          {model.replace('gpt-5-', '')}\n                        </button>\n                      ))}\n                    </div>\n                  </div>\n                  <label className=\"flex flex-col justify-end items-start gap-2 text-xs text-gray-400 cursor-pointer\">\n                    <Label title=\"–ö–æ–Ω—Ç–µ–∫—Å—Ç\" />\n                    <div className=\"flex items-center gap-2\">\n                      <input\n                          type=\"checkbox\"\n                          checked={sendImageToLlm}\n                          onChange={(e) => setSendImageToLlm(e.target.checked)}\n                          className=\"accent-cyan-500\"\n                          disabled={!sourceFile}\n                      />\n                      –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É\n                    </div>\n                  </label>\n                </div>\n\n                <div className=\"pt-2 border-t border-gray-800 space-y-4\">\n                  <Slider label=\"Temperature\" name=\"temperature\" value={llmSettings.temperature} min={0} max={2} step={0.1} onChange={handleLlmSettingsChange} />\n                  <Slider label=\"Top P\" name=\"topP\" value={llmSettings.topP} min={0} max={1} step={0.05} onChange={handleLlmSettingsChange} />\n                  <Slider label=\"Max Tokens\" name=\"maxCompletionTokens\" value={llmSettings.maxCompletionTokens} min={50} max={1000} step={10} onChange={handleLlmSettingsChange} />\n                </div>\n\n                <div className=\"text-center\">\n                  <button\n                    onClick={onRefinePrompt}\n                    disabled={!rawPrompt.trim() || isRefining}\n                    className=\"w-full px-3 py-2 text-sm font-semibold rounded-md bg-cyan-700 hover:bg-cyan-600 text-white disabled:bg-gray-600 disabled:cursor-not-allowed\"\n                  >\n                    {isRefining ? \"–£–ª—É—á—à–∞—é...\" : \"‚úì –£–ª—É—á—à–∏—Ç—å –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–æ–º–ø—Ç\"}\n                  </button>\n                </div>\n\n                {refineError && (\n                  <p className=\"text-xs text-red-400 bg-red-900/20 p-2 rounded-md\">{refineError}</p>\n                )}\n              </div>\n            )}\n          </div>\n\n        {/* prompt */}\n        <div className=\"mt-5 space-y-2\">\n          <Label\n            title=\"–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è\"\n            right={\n              <span className=\"text-[10px] text-gray-500\">{prompt.trim().length || 0}</span>\n            }\n          />\n          <textarea\n          \n            rows={5}\n            className=\"w-full bg-gray-900 border border-gray-800 rounded-lg p-3 text-sm placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-500\"\n            placeholder=\"–ù–∞–ø—Ä.: Change the walls to photorealistic Canadian cedar...\"\n            value={prompt}\n            onChange={(e) => setPrompt(e.target.value)}\n          />\n\n          <button\n            type=\"button\"\n            onClick={() => setShowNeg((v) => !v)}\n            className=\"text-xs text-gray-400 hover:text-gray-200 transition underline underline-offset-4\"\n          >\n            {showNeg ? \"–°–∫—Ä—ã—Ç—å –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–ø—Ç\" : \"–ü–æ–∫–∞–∑–∞—Ç—å –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–ø—Ç\"}\n          </button>\n\n          {showNeg && (\n            <input\n              type=\"text\"\n              value={negativePrompt}\n              onChange={(e) => setNegativePrompt(e.target.value)}\n              className=\"w-full bg-gray-900 border border-gray-800 rounded-lg p-2 text-xs placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-500\"\n              placeholder=\"–ß—Ç–æ –ù–ï –Ω—É–∂–Ω–æ –≤–∏–¥–µ—Ç—å\"\n            />\n          )}\n        </div>\n\n        {/* model */}\n        <div className=\"mt-5 space-y-2\">\n          <Label title=\"–ú–æ–¥–µ–ª—å\" />\n          <div className=\"grid grid-cols-3 gap-3\">\n            {([\"flux\", \"qwen\", \"gemini\"] as Model[]).map((m) => {\n              const isActive = selectedModel === m;\n              return (\n                <button\n                  key={m}\n                  onClick={() => setSelectedModel(m)}\n                  className={cx(\n                    \"py-2.5 rounded-lg text-sm font-bold uppercase tracking-wider transition-all duration-200\",\n                    isActive\n                      ? \"bg-green-500 text-white shadow-lg shadow-green-500/30\" // <--- –ò–ó–ú–ï–ù–ï–ù–û\n                      : \"bg-gray-900 border border-gray-700 text-gray-400 hover:bg-gray-800 hover:text-gray-200 hover:border-gray-600\"\n                  )}\n                >\n                  {m}\n                </button>\n              );\n            })}\n          </div>\n        </div>\n\n        {/* settings */}\n        <div className=\"mt-5 pt-4 border-t border-gray-800 space-y-4\">\n          <div className=\"flex items-center justify-between\">\n            <h3 className=\"text-sm font-semibold text-gray-200\">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</h3>\n            <div className=\"flex items-center gap-2\">\n              <label className=\"flex items-center gap-1 text-[11px] text-gray-400\">\n                <input\n                  type=\"checkbox\"\n                  checked={seedLock}\n                  onChange={(e) => setSeedLock(e.target.checked)}\n                  className=\"accent-cyan-500\"\n                />\n                –§–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å seed\n              </label>\n              <button\n                type=\"button\"\n                onClick={randomizeSeed}\n                className=\"text-[11px] px-2 py-1 rounded border border-gray-700 text-gray-300 hover:bg-gray-800\"\n                title=\"–°–ª—É—á–∞–π–Ω—ã–π seed\"\n              >\n                üé≤\n              </button>\n            </div>\n          </div>\n\n          {selectedModel === \"qwen\" && (\n            <>\n              <Slider label=\"Guidance scale\" value={qwenSettings.guidance_scale} min={1} max={10} step={0.1} onChange={handleQwenChange} name=\"guidance_scale\" />\n              <Slider label=\"Inference Steps\" value={qwenSettings.num_inference_steps} min={10} max={60} step={1} onChange={handleQwenChange} name=\"num_inference_steps\" />\n              <Slider label=\"Seed\" value={qwenSettings.seed} min={0} max={2147483647} step={1} onChange={handleQwenChange} name=\"seed\" />\n            </>\n          )}\n\n          {selectedModel === \"flux\" && (\n            <>\n              <Slider label=\"Guidance scale (CFG)\" value={fluxSettings.guidance_scale} min={0} max={10} step={0.1} onChange={handleFluxChange} name=\"guidance_scale\" />\n              <Slider label=\"Safety Tolerance\" value={fluxSettings.safety_tolerance} min={0} max={10} step={0.5} onChange={handleFluxChange} name=\"safety_tolerance\" info=\"–ë–æ–ª—å—à–µ–µ ‚Äî —Å—Ç—Ä–æ–∂–µ safety –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∫—Ä–æ–ø.\" />\n              <Slider label=\"Seed\" value={fluxSettings.seed} min={0} max={2147483647} step={1} onChange={handleFluxChange} name=\"seed\" />\n            </>\n          )}\n\n          {selectedModel === \"gemini\" && <p className=\"text-xs text-gray-500\">–î–ª—è Gemini –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ–ø. –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.</p>}\n        </div>\n\n        {/* actions */}\n        <div className=\"mt-5 space-y-3\">\n          <button\n            onClick={onGenerate}\n            disabled={!isReadyToGenerate}\n            className={cx(\n              \"w-full inline-flex items-center justify-center gap-2 text-sm font-semibold py-2.5 rounded-lg transition\",\n              isReadyToGenerate ? \"bg-cyan-600 hover:bg-cyan-500 text-white\" : \"bg-gray-700 text-gray-400 cursor-not-allowed\"\n            )}\n            title=\"Ctrl/Cmd+Enter ‚Äî —Ç–æ–∂–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç\"\n          >\n            {isLoading ? \"–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...\" : \"–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å\"}\n          </button>\n\n          <div className=\"flex items-center justify-between\">\n            {isLoading ? (\n              <button onClick={onCancel} className=\"text-xs text-red-400 hover:text-red-300\">\n                –û—Ç–º–µ–Ω–∏—Ç—å (Esc)\n              </button>\n            ) : (\n              <button onClick={onClear} className=\"text-xs text-gray-400 hover:text-gray-200\">\n                –û—á–∏—Å—Ç–∏—Ç—å\n              </button>\n            )}\n            {sourceFile && (\n              <span className=\"text-[11px] text-gray-500\">{sourceFile.type.replace(\"image/\", \"\").toUpperCase()}</span>\n            )}\n          </div>\n\n          {error && (\n            <div className=\"text-red-300 text-xs bg-red-900/20 border border-red-800/40 rounded p-2\">\n              <p className=\"font-semibold\">–û—à–∏–±–∫–∞</p>\n              <p>{error}</p>\n            </div>\n          )}\n        </div>\n      </aside>\n\n      {/* ---------- Canvas ---------- */}\n      <section className=\"space-y-4\">\n        {/* top bar */}\n        <div className=\"flex items-center justify-between\">\n          <div className=\"text-sm text-gray-400\">\n            {isLoading ? \"–û–±—Ä–∞–±–æ—Ç–∫–∞‚Ä¶\" : resultUrl ? \"–ì–æ—Ç–æ–≤–æ\" : \"–û–∂–∏–¥–∞–µ—Ç –∑–∞–ø—É—Å–∫–∞\"}\n          </div>\n\n          <div className=\"flex items-center gap-2\">\n            <div className=\"bg-gray-900 border border-gray-800 rounded-lg p-1 flex\">\n              {([\"source\", \"result\", \"compare\"] as const).map((t) => (\n                <button\n                  key={t}\n                  onClick={() => setTab(t)}\n                  className={cx(\n                    \"px-3 py-1.5 text-xs rounded-md\",\n                    tab === t ? \"bg-gray-800 text-gray-100\" : \"text-gray-400 hover:text-gray-200\"\n                  )}\n                >\n                  {t === \"source\" ? \"–ò—Å—Ö–æ–¥–Ω–∏–∫\" : t === \"result\" ? \"–†–µ–∑—É–ª—å—Ç–∞—Ç\" : \"–°—Ä–∞–≤–Ω–∏—Ç—å\"}\n                </button>\n              ))}\n            </div>\n\n            <button\n              onClick={() => {\n                if (!sourceUrl) return;\n                const link = document.createElement(\"a\");\n                link.href = sourceUrl;\n                link.download = sourceFile?.name || \"source.png\";\n                link.click();\n              }}\n              disabled={!sourceUrl}\n              className=\"text-xs px-2.5 py-1.5 rounded border border-gray-800 text-gray-300 hover:bg-gray-800 disabled:opacity-50\"\n            >\n              –°–∫–∞—á–∞—Ç—å –∏—Å—Ö–æ–¥–Ω–∏–∫\n            </button>\n\n            <button\n              onClick={() => {\n                if (!resultUrl) return;\n                const link = document.createElement(\"a\");\n                link.href = resultUrl;\n                link.download = \"result.png\";\n                link.click();\n              }}\n              disabled={!resultUrl}\n              className=\"text-xs px-2.5 py-1.5 rounded border border-gray-800 text-gray-300 hover:bg-gray-800 disabled:opacity-50\"\n            >\n              –°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç\n            </button>\n          </div>\n        </div>\n\n        {/* canvases */}\n        <div className=\"bg-gray-850 border border-gray-800 rounded-xl overflow-hidden\">\n          <div className=\"px-3 py-2 border-b border-gray-800 text-xs text-gray-400\">\n            {tab === \"source\" ? \"–ò—Å—Ö–æ–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ\" : tab === \"result\" ? \"–†–µ–∑—É–ª—å—Ç–∞—Ç\" : \"–°—Ä–∞–≤–Ω–µ–Ω–∏–µ (–¥–≤–∏–≥–∞–π —Å–ª–∞–π–¥–µ—Ä)\"}\n          </div>\n\n          <div className=\"relative h-[60vh] md:h-[70vh] bg-gray-900\">\n\n            {/* loading overlay */}\n            {isLoading && <div className=\"absolute inset-0 bg-gray-800/50 animate-pulse\" aria-label=\"loading\" />}\n\n            {/* source */}\n            {tab !== \"result\" && (\n              sourceUrl ? (\n                <img src={sourceUrl} alt=\"Source\" className=\"absolute inset-0 w-full h-full object-contain\" />\n              ) : (\n                <div className=\"absolute inset-0 flex items-center justify-center text-gray-600 text-sm\">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</div>\n              )\n            )}\n\n            {/* result */}\n            {tab !== \"source\" && (\n              resultUrl ? (\n                tab === \"compare\" ? (\n                  <>\n                    <img src={resultUrl} alt=\"Result\" className=\"absolute inset-0 w-full h-full object-contain\" style={{ clipPath: `inset(0 ${100 - comparePos}% 0 0)` }} />\n                    <div className=\"absolute inset-0 pointer-events-none border-l-2 border-cyan-500\" style={{ left: `${comparePos}%` }} />\n                    <input\n                      type=\"range\"\n                      min={0}\n                      max={100}\n                      value={comparePos}\n                      onChange={(e) => setComparePos(Number(e.target.value))}\n                      className=\"absolute bottom-3 left-1/2 -translate-x-1/2 w-[60%] h-2 bg-gray-700 rounded-lg appearance-none accent-cyan-500\"\n                    />\n                  </>\n                ) : (\n                  <img src={resultUrl} alt=\"Result\" className=\"absolute inset-0 w-full h-full object-contain\" />\n                )\n              ) : (\n                tab !== \"source\" && (\n                  <div className=\"absolute inset-0 flex items-center justify-center text-gray-600 text-sm\">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>\n                )\n              )\n            )}\n          </div>\n        </div>\n\n        <div className=\"text-[11px] text-gray-500\">\n          –õ–∞–π—Ñ—Ö–∞–∫: –∫–æ—Ä–æ—Ç–∫–∏–π –ø—Ä–æ–º–ø—Ç ‚Üí –≤—ã–±–µ—Ä–∏ –º–æ–¥–µ–ª—å ‚Üí Ctrl/Cmd+Enter. –í—Å—Ç–∞–≤–∫–∞ –∏–∑ –±—É—Ñ–µ—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç.\n        </div>\n      </section>\n    </div>\n  );\n}\n"
    }
  ]
}